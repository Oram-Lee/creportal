<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE Portal - ë¹Œë”© ë“±ë¡ v9.5.3</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-color: #2563eb;
            --accent-light: #dbeafe;
            --success-color: #16a34a;
            --warning-color: #f59e0b;
            --error-color: #dc2626;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-secondary); color: var(--text-primary); min-height: 100vh; }
        
        /* í—¤ë” */
        .header { height: 56px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 24px; gap: 16px; box-shadow: var(--shadow-sm); }
        .header-logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; color: var(--accent-color); text-decoration: none; }
        .header-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .header-version { font-size: 11px; color: var(--text-muted); background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; }
        .header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-tertiary); }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        
        /* ìŠ¤í… ì¸ë””ì¼€ì´í„° */
        .step-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 32px; }
        .step { display: flex; align-items: center; gap: 8px; }
        .step-num { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-tertiary); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        .step.active .step-num { background: var(--accent-color); color: white; }
        .step.completed .step-num { background: var(--success-color); color: white; }
        .step-label { font-size: 14px; color: var(--text-muted); }
        .step.active .step-label { color: var(--accent-color); font-weight: 600; }
        .step.completed .step-label { color: var(--success-color); }
        .step-divider { width: 60px; height: 2px; background: var(--border-color); }
        .step.completed + .step-divider { background: var(--success-color); }
        
        /* ì¹´ë“œ */
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .card-header h2 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-header .subtitle { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        .card-body { padding: 24px; }
        .card-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg-secondary); border-radius: 0 0 12px 12px; }
        
        /* ê²€ìƒ‰ ë°•ìŠ¤ */
        .search-section { margin-bottom: 24px; }
        .search-box { display: flex; gap: 12px; }
        .search-input { flex: 1; padding: 14px 18px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-light); }
        .search-input::placeholder { color: var(--text-muted); }
        
        /* ê²€ìƒ‰ ê²°ê³¼ */
        .search-results { margin-top: 16px; }
        .search-results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .search-results-header h3 { font-size: 14px; color: var(--text-secondary); }
        .result-count { font-size: 13px; color: var(--text-muted); }
        
        .result-list { max-height: 400px; overflow-y: auto; }
        .result-item { padding: 16px; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .result-item:hover { border-color: var(--accent-color); background: var(--accent-light); }
        .result-item.selected { border-color: var(--accent-color); background: var(--accent-light); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .result-item .building-name { font-weight: 600; font-size: 15px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .result-item .building-address { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
        .result-item .building-info { display: flex; flex-wrap: wrap; gap: 8px; }
        .result-item .info-tag { padding: 4px 10px; background: var(--bg-secondary); border-radius: 4px; font-size: 12px; color: var(--text-secondary); }
        .result-item .info-tag.highlight { background: #dcfce7; color: #16a34a; }
        
        .duplicate-warning { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-top: 12px; display: flex; align-items: center; gap: 10px; }
        .duplicate-warning .icon { font-size: 20px; }
        .duplicate-warning .text { font-size: 13px; color: #92400e; }
        
        /* ë¹Œë”© ì •ë³´ í¼ */
        .form-section { margin-bottom: 24px; }
        .form-section-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .form-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .form-group label .required { color: var(--error-color); }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: all 0.2s; background: var(--bg-primary); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-light); }
        .form-group input:disabled, .form-group select:disabled { background: var(--bg-tertiary); color: var(--text-muted); }
        .form-group input.auto-filled { background: #f0fdf4; border-color: #86efac; }
        .form-group .hint { font-size: 11px; color: var(--text-muted); }
        
        /* ë©´ì  í‘œì‹œ (ã¡ + í‰) */
        .area-display { display: flex; align-items: center; gap: 8px; }
        .area-display input { flex: 1; }
        .area-pyeong { font-size: 12px; color: var(--accent-color); font-weight: 500; white-space: nowrap; min-width: 70px; }
        
        /* ë ŒíŠ¸ë¡¤ ì¡°íšŒ ë²„íŠ¼ */
        .rentroll-action-box { padding: 20px; border: 2px solid var(--border-color); border-radius: 10px; margin-top: 24px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .rentroll-action-box .action-title { font-weight: 600; font-size: 15px; margin-bottom: 8px; color: var(--text-primary); }
        .rentroll-action-box .action-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }
        .rentroll-action-box .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        .rentroll-action-box .btn-action { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
        .rentroll-action-box .btn-nps { background: #3b82f6; color: white; }
        .rentroll-action-box .btn-nps:hover { background: #2563eb; }
        .rentroll-action-box .btn-saramin { background: #10b981; color: white; }
        .rentroll-action-box .btn-saramin:hover { background: #059669; }
        .rentroll-action-box .btn-action:disabled { background: #d1d5db; cursor: not-allowed; }
        
        /* ë ŒíŠ¸ë¡¤ ë¯¸ë¦¬ë³´ê¸° */
        .rentroll-preview { margin-top: 24px; }
        .rentroll-preview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .rentroll-preview-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .rentroll-stats { display: flex; gap: 16px; }
        .rentroll-stat { text-align: center; padding: 12px 20px; background: var(--bg-secondary); border-radius: 8px; }
        .rentroll-stat .num { font-size: 24px; font-weight: 700; color: var(--accent-color); }
        .rentroll-stat .label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        
        /* â˜… v9.4.0: ê¸°ì¤€ì—°ì›” í‘œì‹œ â˜… */
        .target-date-box { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #fef3c7; border-radius: 8px; font-size: 13px; color: #92400e; }
        .target-date-box input { padding: 4px 8px; border: 1px solid #f59e0b; border-radius: 4px; font-size: 13px; width: 120px; }
        
        /* â˜… v9.4.0: ê´€ë¦¬ ë²„íŠ¼ ê·¸ë£¹ â˜… */
        .rentroll-controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; }
        .rentroll-controls .btn { padding: 6px 12px; font-size: 12px; }
        .rentroll-controls .selected-info { margin-left: auto; color: #64748b; font-size: 13px; font-weight: 500; }
        
        /* ë ŒíŠ¸ë¡¤ í…Œì´ë¸” */
        .rentroll-table { width: 100%; border-collapse: collapse; margin-top: 12px; table-layout: fixed; }
        .rentroll-table th { background: var(--bg-secondary); padding: 10px 6px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid var(--border-color); white-space: nowrap; }
        .rentroll-table td { padding: 10px 6px; border-bottom: 1px solid var(--border-color); font-size: 13px; vertical-align: middle; }
        .rentroll-table tbody tr:hover { background: #f8fafc; }
        .rentroll-table tbody tr.checked { background: #eff6ff; }
        
        /* í…Œì´ë¸” ì»¬ëŸ¼ ë„ˆë¹„ - v9.4.0 */
        .rentroll-table th:nth-child(1), .rentroll-table td:nth-child(1) { width: 36px; text-align: center; }
        .rentroll-table th:nth-child(2), .rentroll-table td:nth-child(2) { width: 140px; }
        .rentroll-table th:nth-child(3), .rentroll-table td:nth-child(3) { width: 100px; }
        .rentroll-table th:nth-child(4), .rentroll-table td:nth-child(4) { width: 70px; text-align: center; }
        .rentroll-table th:nth-child(5), .rentroll-table td:nth-child(5) { width: auto; }
        
        .rentroll-table .company-name { font-weight: 600; color: var(--text-primary); display: block; word-break: keep-all; }
        .rentroll-table .company-source { font-size: 10px; color: #94a3b8; display: block; margin-top: 2px; }
        .rentroll-table .employee-count { color: var(--accent-color); font-weight: 600; }
        
        /* ì¸µìˆ˜ ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .floor-input { width: 70px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 4px 6px; font-size: 12px; }
        .floor-input:focus { border-color: var(--accent-color); outline: none; }
        .floor-input::placeholder { color: #ccc; font-size: 11px; }
        
        /* ë¹„ê³  ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .note-input { width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px 8px; font-size: 12px; }
        .note-input:focus { border-color: var(--accent-color); outline: none; }
        
        /* ì™„ë£Œ í™”ë©´ */
        .completion-section { text-align: center; padding: 60px 40px; }
        .completion-icon { font-size: 80px; margin-bottom: 24px; }
        .completion-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .completion-subtitle { font-size: 16px; color: var(--text-muted); margin-bottom: 32px; }
        .completion-summary { display: inline-flex; flex-direction: column; gap: 12px; text-align: left; background: var(--bg-secondary); padding: 24px 32px; border-radius: 12px; margin-bottom: 32px; }
        .completion-summary .item { display: flex; gap: 16px; font-size: 14px; }
        .completion-summary .item .label { color: var(--text-muted); min-width: 100px; }
        .completion-summary .item .value { font-weight: 600; }
        
        /* ë¡œë”© */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 15px; color: var(--text-secondary); }
        
        /* í† ìŠ¤íŠ¸ */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1001; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 14px 20px; background: var(--text-primary); color: white; border-radius: 8px; font-size: 14px; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease; }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--error-color); }
        .toast.warning { background: var(--warning-color); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* ë¹ˆ ìƒíƒœ */
        .empty-state { text-align: center; padding: 60px 40px; color: var(--text-muted); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }
        
        /* NEW ë±ƒì§€ */
        .new-badge { display: inline-block; padding: 2px 8px; background: #dc2626; color: white; font-size: 10px; font-weight: 700; border-radius: 4px; }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .form-grid.cols-2 { grid-template-columns: 1fr; }
            .rentroll-controls { flex-direction: column; align-items: stretch; }
            .rentroll-controls .selected-info { margin-left: 0; text-align: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="portal.html" class="header-logo">ğŸ¢ CRE PORTAL</a>
        <span class="header-title">ë¹Œë”© ë“±ë¡</span>
        <span class="header-version">v9.5.3</span>
        <div class="header-right">
            <a href="portal.html" class="btn btn-secondary btn-sm">â† í¬í„¸ë¡œ ëŒì•„ê°€ê¸°</a>
            <button class="btn btn-secondary btn-sm" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
        </div>
    </header>
    
    <main class="main-container">
        <!-- ìŠ¤í… ì¸ë””ì¼€ì´í„° -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-num">1</div>
                <span class="step-label">ë¹Œë”© ê²€ìƒ‰</span>
            </div>
            <div class="step-divider"></div>
            <div class="step" id="step2">
                <div class="step-num">2</div>
                <span class="step-label">ì •ë³´ ì…ë ¥</span>
            </div>
            <div class="step-divider"></div>
            <div class="step" id="step3">
                <div class="step-num">3</div>
                <span class="step-label">ë“±ë¡ ì™„ë£Œ</span>
            </div>
        </div>
        
        <!-- Step 1: ë¹Œë”© ê²€ìƒ‰ -->
        <div class="card" id="searchCard">
            <div class="card-header">
                <h2>ğŸ” ë¹Œë”© ê²€ìƒ‰</h2>
                <p class="subtitle">ê±´ì¶•ë¬¼ëŒ€ì¥ APIë¥¼ í†µí•´ ë“±ë¡í•  ë¹Œë”©ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤</p>
            </div>
            <div class="card-body">
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" class="search-input" id="addressInput" placeholder="ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í…Œí—¤ë€ë¡œ 152, ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45)">
                        <button class="btn btn-primary" onclick="searchBuilding()">ğŸ” ê²€ìƒ‰</button>
                    </div>
                </div>
                
                <div class="search-results" id="searchResults" style="display:none;">
                    <div class="search-results-header">
                        <h3>ê²€ìƒ‰ ê²°ê³¼</h3>
                        <span class="result-count" id="resultCount">0ê±´</span>
                    </div>
                    <div class="result-list" id="resultList"></div>
                </div>
                
                <div class="empty-state" id="emptyState">
                    <div class="icon">ğŸ—ï¸</div>
                    <p>ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" id="selectBuildingBtn" onclick="goToStep2()" disabled>ì„ íƒí•œ ë¹Œë”©ìœ¼ë¡œ ì§„í–‰ â†’</button>
            </div>
        </div>
        
        <!-- Step 2: ì •ë³´ ì…ë ¥ -->
        <div class="card" id="infoCard" style="display:none;">
            <div class="card-header">
                <h2>ğŸ“ ë¹Œë”© ì •ë³´ ì…ë ¥</h2>
                <p class="subtitle">ê±´ì¶•ë¬¼ëŒ€ì¥ì—ì„œ ìë™ ì¶”ì¶œëœ ì •ë³´ì™€ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤</p>
            </div>
            <div class="card-body">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ¢ ê¸°ë³¸ ì •ë³´ (ìë™ ì…ë ¥)</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ë¹Œë”©ëª… <span class="required">*</span></label>
                            <input type="text" id="buildingName" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>ë„ë¡œëª… ì£¼ì†Œ</label>
                            <input type="text" id="roadAddress" class="auto-filled" disabled>
                        </div>
                        <div class="form-group">
                            <label>ì§€ë²ˆ ì£¼ì†Œ</label>
                            <input type="text" id="jibunAddress" class="auto-filled" disabled>
                        </div>
                        <div class="form-group">
                            <label>ì¤€ê³µë…„ë„</label>
                            <input type="text" id="completionYear" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>ì§€ìƒ ì¸µìˆ˜</label>
                            <input type="text" id="floorsAbove" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>ì§€í•˜ ì¸µìˆ˜</label>
                            <input type="text" id="floorsBelow" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>ì—°ë©´ì </label>
                            <div class="area-display">
                                <input type="text" id="grossFloorSqm" class="auto-filled" placeholder="ã¡">
                                <span class="area-pyeong" id="grossFloorPy"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ëŒ€ì§€ë©´ì </label>
                            <div class="area-display">
                                <input type="text" id="landArea" class="auto-filled" placeholder="ã¡">
                                <span class="area-pyeong" id="landAreaPy"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ê±´ì¶•ë©´ì </label>
                            <div class="area-display">
                                <input type="text" id="buildingArea" class="auto-filled" placeholder="ã¡">
                                <span class="area-pyeong" id="buildingAreaPy"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ìŠ¹ìš© ì—˜ë¦¬ë² ì´í„°</label>
                            <input type="number" id="passengerElevator" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>ë¹„ìƒìš© ì—˜ë¦¬ë² ì´í„°</label>
                            <input type="number" id="freightElevator" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>ì£¼ì°¨ëŒ€ìˆ˜</label>
                            <input type="number" id="parkingTotal" class="auto-filled">
                        </div>
                        <div class="form-group">
                            <label>êµ¬ì¡°</label>
                            <input type="text" id="structure" class="auto-filled" disabled>
                            <input type="hidden" id="structureHidden">
                        </div>
                        <div class="form-group">
                            <label>ê±´ë¬¼ìš©ë„</label>
                            <input type="text" id="buildingUse" class="auto-filled" disabled>
                            <input type="hidden" id="buildingUseHidden">
                        </div>
                    </div>
                </div>
                
                <!-- ì¶”ê°€ ì •ë³´ -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ“‹ ì¶”ê°€ ì •ë³´ (ìˆ˜ë™ ì…ë ¥)</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ê¶Œì—­</label>
                            <select id="region">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="GBD">GBD (ê°•ë‚¨)</option>
                                <option value="YBD">YBD (ì—¬ì˜ë„)</option>
                                <option value="CBD">CBD (ë„ì‹¬)</option>
                                <option value="BBD">BBD (íŒêµ/ë¶„ë‹¹)</option>
                                <option value="ETC">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë¹Œë”© ë“±ê¸‰</label>
                            <select id="grade">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="Prime">Prime</option>
                                <option value="A">Aê¸‰</option>
                                <option value="B+">B+ê¸‰</option>
                                <option value="B">Bê¸‰</option>
                                <option value="C">Cê¸‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ê¸°ì¤€ì¸µ ì „ìš©ë©´ì  (í‰)</label>
                            <input type="number" id="typicalFloorPy" step="0.1" placeholder="ì˜ˆ: 350">
                        </div>
                        <div class="form-group">
                            <label>ê¸°ì¤€ì¸µ ì„ëŒ€ë©´ì  (í‰)</label>
                            <input type="number" id="typicalFloorLeasePy" step="0.1" placeholder="ì˜ˆ: 420">
                        </div>
                        <div class="form-group">
                            <label>ì „ìš©ë¥  (%)</label>
                            <input type="number" id="exclusiveRate" step="0.1" placeholder="ì˜ˆ: 55">
                        </div>
                        <div class="form-group">
                            <label>ë³´ì¦ê¸ˆ (ì›/í‰)</label>
                            <input type="text" id="depositPy" placeholder="ì˜ˆ: 1,500,000">
                        </div>
                        <div class="form-group">
                            <label>ì„ëŒ€ë£Œ (ì›/í‰)</label>
                            <input type="text" id="rentPy" placeholder="ì˜ˆ: 150,000">
                        </div>
                        <div class="form-group">
                            <label>ê´€ë¦¬ë¹„ (ì›/í‰)</label>
                            <input type="text" id="maintenancePy" placeholder="ì˜ˆ: 45,000">
                        </div>
                        <div class="form-group">
                            <label>ì£¼ì°¨ë¹„ìœ¨</label>
                            <input type="text" id="parkingRatio" placeholder="ì˜ˆ: 1ëŒ€/80í‰">
                        </div>
                        <div class="form-group">
                            <label>ì¸ê·¼ì—­</label>
                            <input type="text" id="nearbyStation" placeholder="ì˜ˆ: ê°•ë‚¨ì—­ 2í˜¸ì„ ">
                        </div>
                        <div class="form-group">
                            <label>ì—­ ê±°ë¦¬</label>
                            <input type="text" id="stationDistance" placeholder="ì˜ˆ: ë„ë³´ 5ë¶„">
                        </div>
                        <div class="form-group">
                            <label>PMì‚¬</label>
                            <input type="text" id="pm" placeholder="ì˜ˆ: JLL">
                        </div>
                        <div class="form-group">
                            <label>ì†Œìœ ì</label>
                            <input type="text" id="owner" placeholder="ì˜ˆ: ì‚¼ì„±ìƒëª…">
                        </div>
                    </div>
                </div>
                
                <!-- ë ŒíŠ¸ë¡¤ ì¡°íšŒ ë²„íŠ¼ -->
                <div class="rentroll-action-box">
                    <div class="action-title">ğŸ“Š ì˜ˆìƒ ë ŒíŠ¸ë¡¤ ì¡°íšŒ</div>
                    <div class="action-desc">í•´ë‹¹ ë¹Œë”© ì£¼ì†Œì˜ ì…ì£¼ ì—…ì²´ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</div>
                    <div class="action-buttons">
                        <button type="button" class="btn-action btn-saramin" onclick="fetchSaraminRentroll()">
                            ğŸ’¼ ì‚¬ëŒì¸ ê¸°ì—…ì •ë³´ ì¡°íšŒ
                        </button>
                        <button type="button" class="btn-action" style="background:#6366f1; color:white;" onclick="fetchNearbyCompanies()">
                            ğŸ¢ ë„ë¡œëª… ê¸°ë°˜ ì‚¬ì—…ì¥ ì¡°íšŒ
                        </button>
                    </div>
                    <div style="margin-top:10px;">
                        <span id="csvStatus" style="font-size:12px; color:#888;">â³ êµ­ë¯¼ì—°ê¸ˆ ë°ì´í„° ë¡œë“œ ì¤‘...</span>
                    </div>
                </div>
                
                <!-- â˜…â˜…â˜… v9.4.0: ë ŒíŠ¸ë¡¤ ë¯¸ë¦¬ë³´ê¸° (ê°œì„ ) â˜…â˜…â˜… -->
                <div class="rentroll-preview" id="rentrollPreview" style="display:none;">
                    <div class="rentroll-preview-header">
                        <h3>ğŸ“Š ì˜ˆìƒ ë ŒíŠ¸ë¡¤</h3>
                        <div class="rentroll-stats">
                            <div class="rentroll-stat">
                                <div class="num" id="previewCompanyCount">0</div>
                                <div class="label">ì…ì£¼ ì—…ì²´</div>
                            </div>
                            <div class="rentroll-stat">
                                <div class="num" id="previewEmployeeCount">0</div>
                                <div class="label">ì´ ê·¼ë¡œì</div>
                            </div>
                        </div>
                        <div class="target-date-box">
                            ğŸ“… ê¸°ì¤€ì—°ì›”: <input type="month" id="targetDate">
                        </div>
                    </div>
                    
                    <!-- â˜…â˜…â˜… v9.4.5: ê´€ë¦¬ ë²„íŠ¼ (NPS ì¡°íšŒ ë²„íŠ¼ ë³µì›) â˜…â˜…â˜… -->
                    <div class="rentroll-controls" id="rentrollControls">
                        <button type="button" class="btn" style="background: #6366f1; color: white;" onclick="selectAllRentroll()">
                            â˜‘ï¸ ì „ì²´ì„ íƒ
                        </button>
                        <button type="button" class="btn" style="background: #94a3b8; color: white;" onclick="deselectAllRentroll()">
                            â¬œ ì „ì²´í•´ì œ
                        </button>
                        <button type="button" class="btn" style="background: #ef4444; color: white;" onclick="deleteSelectedRentroll()">
                            ğŸ—‘ï¸ ì„ íƒì‚­ì œ
                        </button>
                        <button type="button" class="btn" style="background: #10b981; color: white;" onclick="enrichSelectedWithNps()">
                            ğŸ” ì„ íƒí•­ëª© NPS ì¡°íšŒ
                        </button>
                        <span class="selected-info" id="selectedCount">0ê°œ ì„ íƒ</span>
                    </div>
                    
                    <table class="rentroll-table">
                        <thead>
                            <tr>
                                <th style="width:36px;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="ì „ì²´ì„ íƒ">
                                </th>
                                <th style="width:140px;">ì…ì£¼ì‚¬ëª…</th>
                                <th style="width:160px;">ì£¼ì†Œ</th>
                                <th style="width:90px;">ì¸µìˆ˜</th>
                                <th style="width:70px;">ì§ì›ìˆ˜</th>
                                <th style="width:120px;">ì—…ì¢…</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody id="rentrollTableBody"></tbody>
                    </table>
                    <div class="floor-help" style="margin-top:8px; font-size:11px; color:#888;">
                        ğŸ’¡ ì¸µìˆ˜ ì…ë ¥ ì˜ˆì‹œ: ë‹¨ì¼ì¸µ <b>3F</b> / ì—°ì†ì¸µ <b>5~7F</b> / ë³µìˆ˜ì¸µ <b>3,5,7F</b> / ì§€í•˜ <b>B1</b>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-secondary" onclick="goToStep1()">â† ì´ì „</button>
                <button class="btn btn-success" onclick="registerBuilding()">âœ“ ë¹Œë”© ë“±ë¡</button>
            </div>
        </div>
        
        <!-- Step 3: ë“±ë¡ ì™„ë£Œ -->
        <div class="card" id="completionCard" style="display:none;">
            <div class="card-body">
                <div class="completion-section">
                    <div class="completion-icon">ğŸ‰</div>
                    <div class="completion-title">ë¹Œë”© ë“±ë¡ ì™„ë£Œ!</div>
                    <div class="completion-subtitle">ìƒˆë¡œìš´ ë¹Œë”©ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                    
                    <div class="completion-summary">
                        <div class="item">
                            <span class="label">ë¹Œë”©ëª…</span>
                            <span class="value" id="completedName">-</span>
                        </div>
                        <div class="item">
                            <span class="label">ì£¼ì†Œ</span>
                            <span class="value" id="completedAddress">-</span>
                        </div>
                        <div class="item">
                            <span class="label">ê¶Œì—­</span>
                            <span class="value" id="completedRegion">-</span>
                        </div>
                        <div class="item">
                            <span class="label">ë ŒíŠ¸ë¡¤</span>
                            <span class="value" id="completedRentroll">-</span>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:12px;justify-content:center;">
                        <a href="portal.html" class="btn btn-primary">ğŸ“ í¬í„¸ì—ì„œ í™•ì¸í•˜ê¸°</a>
                        <button class="btn btn-secondary" onclick="resetForm()">+ ë‹¤ë¥¸ ë¹Œë”© ë“±ë¡</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">ê²€ìƒ‰ ì¤‘...</div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        // ========== ë¡œê·¸ì¸ ì²´í¬ ==========
        const savedUser = localStorage.getItem('crePortalUser');
        if (!savedUser) {
            window.location.href = 'index.html';
        }
        let currentUser = null;
        try {
            currentUser = JSON.parse(savedUser);
        } catch(e) {
            window.location.href = 'index.html';
        }

        // ========== í…Œë§ˆ ë¡œë“œ ==========
        const theme = localStorage.getItem('crePortalTheme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        const themeBtn = document.getElementById('themeBtn');
        if (themeBtn) themeBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

        window.toggleTheme = function() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('crePortalTheme', next);
            const btn = document.getElementById('themeBtn');
            if (btn) btn.textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDTEJnDQzgY6FQABVBcvNsKvwDLJkmj26s",
            authDomain: "cre-unified.firebaseapp.com",
            databaseURL: "https://cre-unified-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cre-unified",
            storageBucket: "cre-unified.firebasestorage.app",
            messagingSenderId: "161207314802",
            appId: "1:161207314802:web:777e72ae0e190e73ebd5eb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ë°±ì—”ë“œ API URL
        const API_BASE_URL = 'https://portal-dsyl.onrender.com';
        // const API_BASE_URL = 'http://localhost:5000'; // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©
        
        let selectedBuilding = null;
        let existingBuildings = [];
        let rentrollData = [];
        
        // â˜…â˜…â˜… v9.5.0: NPS CSV ë°ì´í„° â˜…â˜…â˜…
        let npsCsvData = [];
        let npsCsvLoaded = false;
        let npsIndexByName = new Map();      // íšŒì‚¬ëª… ì¸ë±ìŠ¤
        let npsIndexByRoad = new Map();      // ë„ë¡œëª… ì¸ë±ìŠ¤
        let npsIndexByBCode = new Map();     // ë²•ì •ë™ì½”ë“œ ì¸ë±ìŠ¤
        
        // â˜…â˜…â˜… v9.5.0: í˜„ì¬ ì—°ì›” ì„¤ì • â˜…â˜…â˜…
        function initTargetDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const el = document.getElementById('targetDate');
            if (el) el.value = `${year}-${month}`;
        }
        initTargetDate();
        
        // â˜…â˜…â˜… v9.5.1: NPS CSV ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œ, ë¡œë”© ì˜¤ë²„ë ˆì´ ì—†ìŒ) â˜…â˜…â˜…
        async function loadNpsCsvBackground() {
            if (npsCsvLoaded) {
                updateCsvStatus('loaded');
                return true;
            }
            
            updateCsvStatus('loading');
            
            try {
                const response = await fetch('company.csv');
                if (!response.ok) {
                    console.warn('company.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    updateCsvStatus('error');
                    return false;
                }
                
                const csvText = await response.text();
                console.log('CSV íŒŒì¼ í¬ê¸°:', (csvText.length / 1024 / 1024).toFixed(2) + 'MB');
                
                // PapaParseë¡œ íŒŒì‹±
                const result = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.trim()
                });
                
                console.log('íŒŒì‹± ì™„ë£Œ:', result.data.length + 'í–‰');
                
                // ë°ì´í„° ì •ì œ ë° ì¸ë±ì‹±
                npsCsvData = result.data
                    .filter(row => row['ì‚¬ì—…ì¥ê°€ì…ìƒíƒœì½”ë“œ'] === '1')
                    .map(row => ({
                        companyName: (row['ì‚¬ì—…ì¥ëª…'] || '').trim(),
                        roadAddress: (row['ì‚¬ì—…ì¥ë„ë¡œëª…ìƒì„¸ì£¼ì†Œ'] || '').trim(),
                        jibunAddress: (row['ì‚¬ì—…ì¥ì§€ë²ˆìƒì„¸ì£¼ì†Œ'] || '').trim(),
                        bCode: (row['ê³ ê°ë²•ì •ë™ì£¼ì†Œì½”ë“œ'] || '').trim(),
                        employeeCount: parseInt(row['ê°€ì…ììˆ˜']) || 0,
                        industry: (row['ì‚¬ì—…ì¥ì—…ì¢…ì½”ë“œëª…'] || '').trim(),
                        bizType: row['ì‚¬ì—…ì¥í˜•íƒœêµ¬ë¶„ì½”ë“œ'] === '1' ? 'ë²•ì¸' : 'ê°œì¸',
                        monthlyAmount: parseInt(row['ë‹¹ì›”ê³ ì§€ê¸ˆì•¡']) || 0
                    }))
                    .filter(row => row.companyName && row.employeeCount > 0);
                
                console.log('ìœ íš¨ ë°ì´í„°:', npsCsvData.length + 'ê±´');
                
                // ì¸ë±ìŠ¤ ìƒì„±
                buildNpsIndexes();
                
                npsCsvLoaded = true;
                updateCsvStatus('loaded');
                console.log(`NPS CSV ìë™ ë¡œë“œ ì™„ë£Œ: ${npsCsvData.length.toLocaleString()}ê°œ ì‚¬ì—…ì¥`);
                
                return true;
                
            } catch (e) {
                console.error('CSV ë¡œë“œ ì˜¤ë¥˜:', e);
                updateCsvStatus('error');
                return false;
            }
        }
        
        // CSV ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCsvStatus(status) {
            const statusEl = document.getElementById('csvStatus');
            if (!statusEl) return;
            
            switch(status) {
                case 'loading':
                    statusEl.innerHTML = 'â³ êµ­ë¯¼ì—°ê¸ˆ ë°ì´í„° ë¡œë“œ ì¤‘...';
                    statusEl.style.color = '#f59e0b';
                    break;
                case 'loaded':
                    statusEl.innerHTML = `âœ… êµ­ë¯¼ì—°ê¸ˆ ë°ì´í„° ${npsCsvData.length.toLocaleString()}ê±´ ë¡œë“œë¨`;
                    statusEl.style.color = '#16a34a';
                    break;
                case 'error':
                    statusEl.innerHTML = 'âš ï¸ CSV íŒŒì¼ ì—†ìŒ (company.csv)';
                    statusEl.style.color = '#dc2626';
                    break;
            }
        }
        
        // â˜…â˜…â˜… v9.5.0: NPS CSV ë¡œë“œ (ê¸°ì¡´ - ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆìŒ) â˜…â˜…â˜…
        window.loadNpsCsv = async function() {
            if (npsCsvLoaded) {
                console.log('NPS CSV ì´ë¯¸ ë¡œë“œë¨:', npsCsvData.length + 'ê±´');
                return true;
            }
            
            showLoading('êµ­ë¯¼ì—°ê¸ˆ CSV ë°ì´í„° ë¡œë“œ ì¤‘... (ì•½ 60,000ê±´)');
            
            try {
                const response = await fetch('company.csv');
                if (!response.ok) {
                    throw new Error('CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const csvText = await response.text();
                console.log('CSV íŒŒì¼ í¬ê¸°:', (csvText.length / 1024 / 1024).toFixed(2) + 'MB');
                
                // PapaParseë¡œ íŒŒì‹±
                const result = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.trim()
                });
                
                console.log('íŒŒì‹± ì™„ë£Œ:', result.data.length + 'í–‰');
                
                // ë°ì´í„° ì •ì œ ë° ì¸ë±ì‹±
                npsCsvData = result.data
                    .filter(row => row['ì‚¬ì—…ì¥ê°€ì…ìƒíƒœì½”ë“œ'] === '1') // ë“±ë¡ ìƒíƒœë§Œ
                    .map(row => ({
                        companyName: (row['ì‚¬ì—…ì¥ëª…'] || '').trim(),
                        roadAddress: (row['ì‚¬ì—…ì¥ë„ë¡œëª…ìƒì„¸ì£¼ì†Œ'] || '').trim(),
                        jibunAddress: (row['ì‚¬ì—…ì¥ì§€ë²ˆìƒì„¸ì£¼ì†Œ'] || '').trim(),
                        bCode: (row['ê³ ê°ë²•ì •ë™ì£¼ì†Œì½”ë“œ'] || '').trim(),
                        employeeCount: parseInt(row['ê°€ì…ììˆ˜']) || 0,
                        industry: (row['ì‚¬ì—…ì¥ì—…ì¢…ì½”ë“œëª…'] || '').trim(),
                        bizType: row['ì‚¬ì—…ì¥í˜•íƒœêµ¬ë¶„ì½”ë“œ'] === '1' ? 'ë²•ì¸' : 'ê°œì¸',
                        monthlyAmount: parseInt(row['ë‹¹ì›”ê³ ì§€ê¸ˆì•¡']) || 0
                    }))
                    .filter(row => row.companyName && row.employeeCount > 0);
                
                console.log('ìœ íš¨ ë°ì´í„°:', npsCsvData.length + 'ê±´');
                
                // ì¸ë±ìŠ¤ ìƒì„±
                buildNpsIndexes();
                
                npsCsvLoaded = true;
                updateCsvStatus('loaded');
                showToast(`êµ­ë¯¼ì—°ê¸ˆ CSV ë¡œë“œ ì™„ë£Œ: ${npsCsvData.length.toLocaleString()}ê°œ ì‚¬ì—…ì¥`, 'success');
                
                return true;
                
            } catch (e) {
                console.error('CSV ë¡œë“œ ì˜¤ë¥˜:', e);
                showToast('CSV ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
                updateCsvStatus('error');
                return false;
            } finally {
                hideLoading();
            }
        }
        
        // â˜…â˜…â˜… v9.5.0: ì¸ë±ìŠ¤ ìƒì„± â˜…â˜…â˜…
        function buildNpsIndexes() {
            console.log('ì¸ë±ìŠ¤ ìƒì„± ì‹œì‘...');
            const startTime = Date.now();
            
            npsIndexByName.clear();
            npsIndexByRoad.clear();
            npsIndexByBCode.clear();
            
            npsCsvData.forEach((row, idx) => {
                // íšŒì‚¬ëª… ì¸ë±ìŠ¤ (ì •ê·œí™”)
                const normalizedName = normalizeCompanyName(row.companyName);
                if (!npsIndexByName.has(normalizedName)) {
                    npsIndexByName.set(normalizedName, []);
                }
                npsIndexByName.get(normalizedName).push(idx);
                
                // ë„ë¡œëª… ì¸ë±ìŠ¤ (ë„ë¡œëª…ë§Œ ì¶”ì¶œ)
                const roadName = extractRoadName(row.roadAddress);
                if (roadName) {
                    if (!npsIndexByRoad.has(roadName)) {
                        npsIndexByRoad.set(roadName, []);
                    }
                    npsIndexByRoad.get(roadName).push(idx);
                }
                
                // ë²•ì •ë™ì½”ë“œ ì¸ë±ìŠ¤
                if (row.bCode) {
                    if (!npsIndexByBCode.has(row.bCode)) {
                        npsIndexByBCode.set(row.bCode, []);
                    }
                    npsIndexByBCode.get(row.bCode).push(idx);
                }
            });
            
            console.log(`ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ: ${Date.now() - startTime}ms`);
            console.log(`- íšŒì‚¬ëª…: ${npsIndexByName.size}ê°œ`);
            console.log(`- ë„ë¡œëª…: ${npsIndexByRoad.size}ê°œ`);
            console.log(`- ë²•ì •ë™: ${npsIndexByBCode.size}ê°œ`);
        }
        
        // íšŒì‚¬ëª… ì •ê·œí™”
        function normalizeCompanyName(name) {
            if (!name) return '';
            return name
                .replace(/\(ì£¼\)|\(ìœ \)|ì£¼ì‹íšŒì‚¬|ãˆœ|\(ì‚¬\)|\(ì¬\)/g, '')
                .replace(/\s+/g, '')
                .toLowerCase()
                .trim();
        }
        
        // ë„ë¡œëª… ì¶”ì¶œ (ë²ˆì§€ ì œì™¸)
        function extractRoadName(address) {
            if (!address) return '';
            // "ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬ ê°€ì‚°ë””ì§€í„¸2ë¡œ" â†’ "ê°€ì‚°ë””ì§€í„¸2ë¡œ"
            const match = address.match(/([ê°€-í£]+(?:ë¡œ|ê¸¸|ëŒ€ë¡œ)\d*(?:ê¸¸)?)/);
            return match ? match[1] : '';
        }
        
        // ìœ í‹¸ë¦¬í‹°
        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        
        function showLoading(text = 'ë¡œë”© ì¤‘...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function sqmToPy(sqm) {
            return sqm ? Math.round(parseFloat(sqm) / 3.3058 * 10) / 10 : null;
        }
        
        // ê¸°ì¡´ ë¹Œë”© ë¡œë“œ
        async function loadExistingBuildings() {
            try {
                const snapshot = await get(ref(db, 'buildings'));
                if (snapshot.exists()) {
                    existingBuildings = Object.entries(snapshot.val())
                        .filter(([k]) => k !== '_schema')
                        .map(([id, b]) => ({
                            id,
                            name: b.name,
                            address: b.address,
                            addressJibun: b.addressJibun
                        }));
                    console.log('ê¸°ì¡´ ë¹Œë”© ë¡œë“œ ì™„ë£Œ:', existingBuildings.length + 'ê°œ');
                    console.log('ë¹Œë”© ëª©ë¡:', existingBuildings.map(b => `${b.name} (${b.address})`).join(', '));
                } else {
                    console.log('ê¸°ì¡´ ë¹Œë”© ì—†ìŒ');
                }
            } catch (e) {
                console.error('ê¸°ì¡´ ë¹Œë”© ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ì¤‘ë³µ ì²´í¬ (ì£¼ì†Œ ë˜ëŠ” ë¹Œë”©ëª…ìœ¼ë¡œ)
        function checkDuplicate(address, buildingName) {
            console.log('=== ì¤‘ë³µ ì²´í¬ ì‹œì‘ ===');
            console.log('ê²€ìƒ‰ ì£¼ì†Œ:', address);
            console.log('ê²€ìƒ‰ ë¹Œë”©ëª…:', buildingName);
            console.log('ê¸°ì¡´ ë¹Œë”© ìˆ˜:', existingBuildings.length);
            
            if (!address && !buildingName) return null;
            
            // ë„ë¡œëª…+ë²ˆì§€ ì¶”ì¶œ (ë” ìœ ì—°í•œ íŒ¨í„´)
            const extractKey = (addr) => {
                if (!addr) return '';
                // "ê³µí•­ëŒ€ë¡œ 165" ë˜ëŠ” "ê³µí•­ëŒ€ë¡œ165" ëª¨ë‘ ë§¤ì¹­
                const match = addr.match(/([ê°€-í£]+(?:ë¡œ|ê¸¸|ëŒ€ë¡œ)\d*)\s*(\d+(?:-\d+)?)/);
                const key = match ? (match[1] + match[2]).replace(/\s/g, '') : '';
                console.log(`  ì£¼ì†Œ í‚¤ ì¶”ì¶œ: "${addr}" â†’ "${key}"`);
                return key;
            };
            
            const searchKey = extractKey(address);
            const normalizedName = buildingName?.trim().toLowerCase().replace(/\s+/g, '');
            
            console.log('ê²€ìƒ‰ í‚¤:', searchKey);
            console.log('ì •ê·œí™”ëœ ë¹Œë”©ëª…:', normalizedName);
            
            for (const b of existingBuildings) {
                const existingKey = extractKey(b.address) || extractKey(b.addressJibun);
                const existingName = b.name?.trim().toLowerCase().replace(/\s+/g, '');
                
                // ì£¼ì†Œ ë§¤ì¹­
                if (searchKey && existingKey && searchKey === existingKey) {
                    console.log('âœ… ì£¼ì†Œ ë§¤ì¹­ ì„±ê³µ:', b.name, b.id);
                    return b;
                }
                
                // ë¹Œë”©ëª… ë§¤ì¹­ (ê³µë°± ì œê±° í›„ ë¹„êµ)
                if (normalizedName && existingName && normalizedName === existingName) {
                    console.log('âœ… ë¹Œë”©ëª… ë§¤ì¹­ ì„±ê³µ:', b.name, b.id);
                    return b;
                }
                
                // ë¹Œë”©ëª… ë¶€ë¶„ ë§¤ì¹­ (í¬í•¨ ê´€ê³„)
                if (normalizedName && existingName) {
                    if (normalizedName.includes(existingName) || existingName.includes(normalizedName)) {
                        console.log('âœ… ë¹Œë”©ëª… ë¶€ë¶„ ë§¤ì¹­:', b.name, b.id);
                        return b;
                    }
                }
            }
            
            console.log('âŒ ë§¤ì¹­ë˜ëŠ” ë¹Œë”© ì—†ìŒ');
            return null;
        }
        
        // ë¹Œë”© ê²€ìƒ‰
        window.searchBuilding = async function() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showToast('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            showLoading('ê±´ì¶•ë¬¼ëŒ€ì¥ ê²€ìƒ‰ ì¤‘...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/building-register/search?address=${encodeURIComponent(address)}`);
                const data = await response.json();
                
                console.log('ê±´ì¶•ë¬¼ëŒ€ì¥ API ì‘ë‹µ:', data);
                
                if (data.success && data.results && data.results.length > 0) {
                    displaySearchResults(data.results);
                } else {
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('emptyState').innerHTML = `
                        <div class="icon">ğŸ”</div>
                        <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="font-size:12px;color:#888;margin-top:8px;">ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”</p>
                    `;
                }
            } catch (e) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', e);
                showToast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            } finally {
                hideLoading();
            }
        };
        
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(results) {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('resultCount').textContent = `${results.length}ê±´`;
            
            const resultList = document.getElementById('resultList');
            resultList.innerHTML = results.map((r, idx) => {
                const info = r.buildingInfo || {};
                const roadAddr = r.roadAddress || '';
                const buildingName = r.buildingName || info.buildingName || '(ë¹Œë”©ëª… ì—†ìŒ)';
                
                const duplicate = checkDuplicate(roadAddr, buildingName);
                
                return `
                <div class="result-item ${duplicate ? 'duplicate' : ''}" data-idx="${idx}" onclick="selectResult(${idx})">
                    <div class="building-name">
                        ${buildingName}
                        ${duplicate ? '<span class="new-badge" style="background:#f59e0b;">ì¤‘ë³µ</span>' : ''}
                    </div>
                    <div class="building-address">${roadAddr}</div>
                    <div class="building-info">
                        ${info.mainPurpsCdNm ? `<span class="info-tag">${info.mainPurpsCdNm}</span>` : ''}
                        ${info.grndFlrCnt ? `<span class="info-tag">ì§€ìƒ ${info.grndFlrCnt}ì¸µ</span>` : ''}
                        ${info.totArea ? `<span class="info-tag highlight">${Math.round(info.totArea).toLocaleString()}ã¡</span>` : ''}
                        ${info.useAprDay ? `<span class="info-tag">${info.useAprDay.substring(0,4)}ë…„</span>` : ''}
                    </div>
                    ${duplicate ? `<div class="duplicate-warning"><span class="icon">âš ï¸</span><span class="text">ì´ë¯¸ ë“±ë¡ëœ ë¹Œë”©ì…ë‹ˆë‹¤: ${duplicate.name}</span></div>` : ''}
                </div>
                `;
            }).join('');
            
            window.searchResults = results;
        }
        
        // ê²°ê³¼ ì„ íƒ
        window.selectResult = function(idx) {
            document.querySelectorAll('.result-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.result-item[data-idx="${idx}"]`).classList.add('selected');
            
            selectedBuilding = window.searchResults[idx];
            document.getElementById('selectBuildingBtn').disabled = false;
        };
        
        // Step 2ë¡œ ì´ë™
        window.goToStep2 = function() {
            if (!selectedBuilding) {
                showToast('ë¹Œë”©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            document.getElementById('searchCard').style.display = 'none';
            document.getElementById('infoCard').style.display = 'block';
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            
            fillBuildingInfo(selectedBuilding);
        };
        
        // Step 1ë¡œ ëŒì•„ê°€ê¸°
        window.goToStep1 = function() {
            document.getElementById('infoCard').style.display = 'none';
            document.getElementById('searchCard').style.display = 'block';
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
            
            rentrollData = [];
            document.getElementById('rentrollPreview').style.display = 'none';
        };
        
        // ë¹Œë”© ì •ë³´ ì±„ìš°ê¸°
        function fillBuildingInfo(building) {
            const roadAddr = building.roadAddress || '';
            const jibunAddr = building.jibunAddress || '';
            
            let buildingName = building.buildingName || '';
            if (!buildingName && building.buildingInfo?.buildingName) {
                buildingName = building.buildingInfo.buildingName;
            }
            if (!buildingName) buildingName = 'ì‹ ê·œ ë¹Œë”©';
            
            document.getElementById('buildingName').value = buildingName;
            document.getElementById('roadAddress').value = roadAddr;
            document.getElementById('jibunAddress').value = jibunAddr;
            
            selectedBuilding.lat = parseFloat(building.lat || building.y);
            selectedBuilding.lng = parseFloat(building.lng || building.x);
            selectedBuilding.bCode = building.bCode || '';
            
            const region = detectRegion(roadAddr);
            document.getElementById('region').value = region;
            
            const info = building.buildingInfo;
            if (info) {
                if (info.useAprDay) document.getElementById('completionYear').value = info.useAprDay.substring(0, 4);
                if (info.grndFlrCnt) document.getElementById('floorsAbove').value = info.grndFlrCnt;
                if (info.ugrndFlrCnt) document.getElementById('floorsBelow').value = info.ugrndFlrCnt;
                
                if (info.totArea) {
                    const sqm = Math.round(info.totArea);
                    document.getElementById('grossFloorSqm').value = sqm.toLocaleString();
                    document.getElementById('grossFloorPy').textContent = `(${Math.round(sqm / 3.3058).toLocaleString()}í‰)`;
                }
                if (info.platArea) {
                    const sqm = Math.round(info.platArea);
                    document.getElementById('landArea').value = sqm.toLocaleString();
                    document.getElementById('landAreaPy').textContent = `(${Math.round(sqm / 3.3058).toLocaleString()}í‰)`;
                }
                if (info.archArea) {
                    const sqm = Math.round(info.archArea);
                    document.getElementById('buildingArea').value = sqm.toLocaleString();
                    document.getElementById('buildingAreaPy').textContent = `(${Math.round(sqm / 3.3058).toLocaleString()}í‰)`;
                }
                if (info.rideUseElvtCnt) document.getElementById('passengerElevator').value = info.rideUseElvtCnt;
                if (info.emgenUseElvtCnt) document.getElementById('freightElevator').value = info.emgenUseElvtCnt;
                if (info.totPkngCnt) document.getElementById('parkingTotal').value = info.totPkngCnt;
                
                // â˜…â˜…â˜… v9.5.3: êµ¬ì¡° í•„ë“œ - ì—¬ëŸ¬ í•„ë“œëª… ëŒ€ì‘ + hiddenì— ì €ì¥ â˜…â˜…â˜…
                const structureValue = info.strctCdNm || info.strctCd || info.structure || info.structureName || '';
                if (structureValue) {
                    document.getElementById('structure').value = structureValue;
                    document.getElementById('structureHidden').value = structureValue;
                    console.log('êµ¬ì¡° ì €ì¥:', structureValue);
                }
                
                // â˜…â˜…â˜… v9.5.3: ê±´ë¬¼ìš©ë„ í•„ë“œ - ì—¬ëŸ¬ í•„ë“œëª… ëŒ€ì‘ + hiddenì— ì €ì¥ â˜…â˜…â˜…
                const buildingUseValue = info.mainPurpsCdNm || info.mainPurpsCd || info.mainPurpose || 
                                         info.etcPurps || info.purpose || info.buildingUse || info.usage || '';
                if (buildingUseValue) {
                    document.getElementById('buildingUse').value = buildingUseValue;
                    document.getElementById('buildingUseHidden').value = buildingUseValue;
                    console.log('ê±´ë¬¼ìš©ë„ ì €ì¥:', buildingUseValue);
                }
                
                // â˜…â˜…â˜… v9.5.3: selectedBuildingì—ë„ ì €ì¥ (ë°±ì—…) â˜…â˜…â˜…
                selectedBuilding.structureFromLedger = structureValue;
                selectedBuilding.buildingUseFromLedger = buildingUseValue;
                
                showToast('ê±´ì¶•ë¬¼ëŒ€ì¥ ì •ë³´ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }
        
        // ê¶Œì—­ ìë™ ê°ì§€
        function detectRegion(addr) {
            if (!addr) return '';
            if (addr.includes('ê°•ë‚¨') || addr.includes('ì„œì´ˆ') || addr.includes('í…Œí—¤ë€')) return 'GBD';
            if (addr.includes('ì—¬ì˜ë„') || addr.includes('ì˜ë“±í¬')) return 'YBD';
            if (addr.includes('ì¢…ë¡œ') || addr.includes('ì¤‘êµ¬') || addr.includes('ì„ì§€ë¡œ')) return 'CBD';
            if (addr.includes('íŒêµ') || addr.includes('ë¶„ë‹¹')) return 'BBD';
            return 'ETC';
        }
        
        // â˜…â˜…â˜… v9.4.0: êµ­ë¯¼ì—°ê¸ˆ ì‚¬ì—…ì¥ ì¡°íšŒ â˜…â˜…â˜…
        window.fetchNpsRentroll = async function() {
            showLoading('êµ­ë¯¼ì—°ê¸ˆ ì‚¬ì—…ì¥ ì •ë³´ ì¡°íšŒ ì¤‘...');
            
            try {
                const address = document.getElementById('roadAddress').value || document.getElementById('jibunAddress').value;
                if (!address) {
                    hideLoading();
                    showToast('ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const bCode = selectedBuilding.bCode || '';
                let url = `${API_BASE_URL}/api/nps/search?address=${encodeURIComponent(address)}`;
                if (bCode) url += `&bCode=${encodeURIComponent(bCode)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('NPS API ì‘ë‹µ:', data);
                
                if (data.success && data.results && data.results.length > 0) {
                    rentrollData = data.results.map(item => ({
                        companyName: item.companyName || '',
                        industry: item.industry || '',
                        employeeCount: parseInt(item.employeeCount) || 0,
                        floor: '',
                        note: item.industry || '',
                        source: 'NPS'
                    })).filter(item => item.companyName);
                    
                    displayRentrollTable();
                    showToast(`êµ­ë¯¼ì—°ê¸ˆì—ì„œ ${rentrollData.length}ê°œ ì—…ì²´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤`, 'success');
                } else {
                    displayEmptyRentroll('êµ­ë¯¼ì—°ê¸ˆì—ì„œ ì…ì£¼ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (e) {
                console.error('NPS ì¡°íšŒ ì˜¤ë¥˜:', e);
                showToast('êµ­ë¯¼ì—°ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoading();
            }
        };
        
        // â˜…â˜…â˜… v9.5.0: NPS CSVì—ì„œ íšŒì‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰ â˜…â˜…â˜…
        function findNpsByCompanyName(companyName) {
            if (!npsCsvLoaded || !companyName) return null;
            
            const normalized = normalizeCompanyName(companyName);
            const indexes = npsIndexByName.get(normalized);
            
            if (indexes && indexes.length > 0) {
                // ê°€ì¥ ì§ì›ìˆ˜ê°€ ë§ì€ ê²ƒ ë°˜í™˜ (ì—¬ëŸ¬ ì§€ì ì´ ìˆì„ ìˆ˜ ìˆìŒ)
                let best = null;
                indexes.forEach(idx => {
                    const row = npsCsvData[idx];
                    if (!best || row.employeeCount > best.employeeCount) {
                        best = row;
                    }
                });
                return best;
            }
            
            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
            for (const [key, idxList] of npsIndexByName) {
                if (key.includes(normalized) || normalized.includes(key)) {
                    if (idxList.length > 0) {
                        return npsCsvData[idxList[0]];
                    }
                }
            }
            
            return null;
        }
        
        // â˜…â˜…â˜… v9.5.0: ë„ë¡œëª… + ë²•ì •ë™ì½”ë“œë¡œ ì‚¬ì—…ì¥ ëª©ë¡ ì¡°íšŒ â˜…â˜…â˜…
        function findNpsByRoadAndBCode(roadAddress, bCode) {
            if (!npsCsvLoaded) return [];
            
            const roadName = extractRoadName(roadAddress);
            if (!roadName) return [];
            
            console.log(`ë„ë¡œëª… ê²€ìƒ‰: ${roadName}, ë²•ì •ë™: ${bCode}`);
            
            let results = [];
            
            // ë²•ì •ë™ì½”ë“œê°€ ìˆìœ¼ë©´ ë¨¼ì € í•„í„°
            if (bCode) {
                const bCodeIndexes = npsIndexByBCode.get(bCode) || [];
                bCodeIndexes.forEach(idx => {
                    const row = npsCsvData[idx];
                    if (row.roadAddress && row.roadAddress.includes(roadName)) {
                        results.push(row);
                    }
                });
            }
            
            // ë²•ì •ë™ í•„í„° ê²°ê³¼ê°€ ì ìœ¼ë©´ ë„ë¡œëª…ë§Œìœ¼ë¡œ ê²€ìƒ‰
            if (results.length < 5) {
                const roadIndexes = npsIndexByRoad.get(roadName) || [];
                roadIndexes.forEach(idx => {
                    const row = npsCsvData[idx];
                    // ì¤‘ë³µ ë°©ì§€
                    if (!results.find(r => r.companyName === row.companyName)) {
                        results.push(row);
                    }
                });
            }
            
            // ì§ì›ìˆ˜ ê¸°ì¤€ ì •ë ¬
            results.sort((a, b) => b.employeeCount - a.employeeCount);
            
            console.log(`ë„ë¡œëª… ê²€ìƒ‰ ê²°ê³¼: ${results.length}ê±´`);
            return results.slice(0, 50); // ìµœëŒ€ 50ê°œ
        }
        
        // â˜…â˜…â˜… v9.5.0: ë„ë¡œëª… ê¸°ë°˜ ì‚¬ì—…ì¥ ì¡°íšŒ (ë°©ì•ˆ 2) â˜…â˜…â˜…
        window.fetchNearbyCompanies = async function() {
            if (!npsCsvLoaded) {
                const loaded = await loadNpsCsv();
                if (!loaded) return;
            }
            
            const roadAddress = document.getElementById('roadAddress').value || '';
            const bCode = selectedBuilding?.bCode || '';
            
            if (!roadAddress) {
                showToast('ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            showLoading('ë„ë¡œëª… ê¸°ë°˜ ì‚¬ì—…ì¥ ê²€ìƒ‰ ì¤‘...');
            
            try {
                const results = findNpsByRoadAndBCode(roadAddress, bCode);
                
                if (results.length === 0) {
                    displayEmptyRentroll('í•´ë‹¹ ë„ë¡œì—ì„œ ì‚¬ì—…ì¥ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                    showToast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ', 'warning');
                    return;
                }
                
                rentrollData = results.map(row => ({
                    companyName: row.companyName,
                    address: row.roadAddress || row.jibunAddress,
                    floor: '',
                    employeeCount: row.employeeCount,
                    industry: row.industry,
                    note: row.bizType === 'ë²•ì¸' ? 'ë²•ì¸' : '',
                    source: 'NPS CSV'
                }));
                
                displayRentrollTable();
                showToast(`${rentrollData.length}ê°œ ì‚¬ì—…ì¥ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤ (CSV ê¸°ë°˜)`, 'success');
                
            } catch (e) {
                console.error('ë„ë¡œëª… ê²€ìƒ‰ ì˜¤ë¥˜:', e);
                showToast('ê²€ìƒ‰ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoading();
            }
        };
        
        // â˜…â˜…â˜… v9.5.0: ì‚¬ëŒì¸ ê²°ê³¼ì— NPS ë°ì´í„° ìë™ ë§¤ì¹­ (ë°©ì•ˆ 3) â˜…â˜…â˜…
        async function enrichSaraminWithNpsCsv() {
            if (!npsCsvLoaded || rentrollData.length === 0) return;
            
            console.log('NPS CSV ë§¤ì¹­ ì‹œì‘...');
            let matchCount = 0;
            
            rentrollData.forEach((item, idx) => {
                const npsMatch = findNpsByCompanyName(item.companyName);
                if (npsMatch) {
                    // ì§ì›ìˆ˜ê°€ ì—†ê±°ë‚˜ NPSê°€ ë” ì •í™•í•˜ë©´ ì—…ë°ì´íŠ¸
                    if (!item.employeeCount || item.employeeCount === 0) {
                        rentrollData[idx].employeeCount = npsMatch.employeeCount;
                    }
                    // ì—…ì¢…ì´ ì—†ìœ¼ë©´ ì—…ë°ì´íŠ¸
                    if (!item.industry) {
                        rentrollData[idx].industry = npsMatch.industry;
                    }
                    rentrollData[idx].npsMatched = true;
                    matchCount++;
                    console.log(`ë§¤ì¹­: ${item.companyName} â†’ ${npsMatch.employeeCount}ëª…`);
                }
            });
            
            if (matchCount > 0) {
                displayRentrollTable();
                showToast(`${matchCount}ê°œ ì—…ì²´ NPS ì •ë³´ ë§¤ì¹­ë¨`, 'info');
            }
        }
        window.fetchSaraminRentroll = async function() {
            showLoading('ì‚¬ëŒì¸ ê¸°ì—…ì •ë³´ ì¡°íšŒ ì¤‘...');
            
            try {
                const buildingName = document.getElementById('buildingName').value || '';
                const roadAddress = document.getElementById('roadAddress').value || '';
                
                if (!buildingName && !roadAddress) {
                    hideLoading();
                    showToast('ë¹Œë”©ëª… ë˜ëŠ” ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/saramin/search?building=${encodeURIComponent(buildingName)}&address=${encodeURIComponent(roadAddress)}`);
                const data = await response.json();
                
                console.log('ì‚¬ëŒì¸ API ì‘ë‹µ:', data);
                
                if (data.success && data.results && data.results.length > 0) {
                    // â˜… v9.4.3: ì£¼ì†Œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²ƒë§Œ í•„í„°ë§ â˜…
                    const filteredResults = data.results.filter(item => {
                        if (!item.address) return false;
                        return isAddressMatch(roadAddress, item.address);
                    });
                    
                    console.log(`ì‚¬ëŒì¸ í•„í„°ë§: ${data.results.length}ê°œ â†’ ${filteredResults.length}ê°œ`);
                    
                    if (filteredResults.length === 0) {
                        displayEmptyRentroll('ì‚¬ëŒì¸ì—ì„œ í•´ë‹¹ ë¹Œë”© ì…ì£¼ì‚¬ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                        showToast(`ê²€ìƒ‰ ê²°ê³¼ ${data.results.length}ê°œ ì¤‘ ì£¼ì†Œ ì¼ì¹˜ í•­ëª© ì—†ìŒ`, 'warning');
                        return;
                    }
                    
                    rentrollData = filteredResults.map(item => {
                        // ì¸µìˆ˜ ì¶”ì¶œ
                        let floor = item.floor || '';
                        if (!floor && item.address) {
                            const floorMatch = item.address.match(/(\d+)\s*ì¸µ/);
                            if (floorMatch) floor = floorMatch[1] + 'F';
                            const basementMatch = item.address.match(/ì§€í•˜\s*(\d+)|B(\d+)/i);
                            if (basementMatch) floor = 'B' + (basementMatch[1] || basementMatch[2]);
                        }
                        
                        // ë¹„ê³ : ë§¤ì¶œ + ê¸°ì—…ê·œëª¨ (ì—…ì¢…ì€ ë³„ë„ ì»¬ëŸ¼)
                        const notes = [];
                        if (item.revenue) notes.push(`ë§¤ì¶œ:${item.revenue}`);
                        if (item.companySize) notes.push(item.companySize);
                        
                        return {
                            companyName: item.companyName || '',
                            employeeCount: parseInt(item.employeeCount) || 0,
                            floor: floor,
                            industry: item.industry || '',  // ì—…ì¢… ë³„ë„ ì €ì¥
                            note: notes.join(' / '),
                            address: (item.address || '').replace(/ì§€ë„ë³´ê¸°/g, '').trim(),
                            source: 'Saramin'
                        };
                    }).filter(item => item.companyName);
                    
                    displayRentrollTable();
                    showToast(`ì‚¬ëŒì¸ì—ì„œ ${rentrollData.length}ê°œ ì—…ì²´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤`, 'success');
                    
                    // â˜… v9.5.0: CSV ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ìë™ ë§¤ì¹­ â˜…
                    if (npsCsvLoaded) {
                        await enrichSaraminWithNpsCsv();
                    }
                } else {
                    displayEmptyRentroll('ì‚¬ëŒì¸ì—ì„œ ì…ì£¼ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (e) {
                console.error('ì‚¬ëŒì¸ ì¡°íšŒ ì˜¤ë¥˜:', e);
                showToast('ì‚¬ëŒì¸ ì¡°íšŒ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoading();
            }
        };
        
        // â˜…â˜…â˜… v9.4.4: ì£¼ì†Œ ë§¤ì¹­ í™•ì¸ í•¨ìˆ˜ â˜…â˜…â˜…
        function isAddressMatch(searchedAddr, resultAddr) {
            if (!searchedAddr || !resultAddr) return false;
            
            const extractRoadNumber = (addr) => {
                const match = addr.match(/([ê°€-í£]+(?:ë¡œ|ê¸¸|ëŒ€ë¡œ)\d*(?:ê¸¸)?)\s*(\d+(?:-\d+)?)/);
                if (match) {
                    return (match[1] + match[2]).replace(/\s/g, '');
                }
                return null;
            };
            
            const searched = extractRoadNumber(searchedAddr);
            const result = extractRoadNumber(resultAddr);
            
            if (!searched || !result) return false;
            return searched === result;
        }
        
        // â˜…â˜…â˜… v9.4.4: ë ŒíŠ¸ë¡¤ í…Œì´ë¸” í‘œì‹œ (ìƒˆë¡œìš´ ì»¬ëŸ¼ êµ¬ì¡°) â˜…â˜…â˜…
        function displayRentrollTable() {
            if (!rentrollData || rentrollData.length === 0) {
                displayEmptyRentroll('ì…ì£¼ì‚¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            document.getElementById('rentrollPreview').style.display = 'block';
            document.getElementById('rentrollControls').style.display = 'flex';
            document.getElementById('previewCompanyCount').textContent = rentrollData.length;
            document.getElementById('previewEmployeeCount').textContent = rentrollData.reduce((sum, r) => sum + (r.employeeCount || 0), 0).toLocaleString();
            
            const tbody = document.getElementById('rentrollTableBody');
            tbody.innerHTML = rentrollData.map((r, idx) => {
                // ì£¼ì†Œ ê°„ëµí™” (ì‹œ/ë„ ì œê±°)
                let shortAddr = r.address || '-';
                shortAddr = shortAddr.replace(/ì„œìš¸íŠ¹ë³„ì‹œ\s*/g, '');
                shortAddr = shortAddr.replace(/ì„œìš¸ì‹œ\s*/g, '');
                shortAddr = shortAddr.replace(/ê²½ê¸°ë„\s*/g, 'ê²½ê¸° ');
                shortAddr = shortAddr.replace(/ì¸ì²œê´‘ì—­ì‹œ\s*/g, 'ì¸ì²œ ');
                
                return `
                <tr data-idx="${idx}">
                    <td style="text-align:center;">
                        <input type="checkbox" class="row-checkbox" data-idx="${idx}" onchange="updateSelectedCount(); toggleRowHighlight(this);">
                    </td>
                    <td>
                        <span class="company-name">${r.companyName}</span>
                        <span class="company-source">${r.source || ''}</span>
                    </td>
                    <td style="font-size:11px; color:#666;" title="${r.address || ''}">
                        ${shortAddr}
                    </td>
                    <td>
                        <input type="text" class="floor-input" value="${r.floor || ''}" 
                               placeholder="3F"
                               onchange="updateField(${idx}, 'floor', this.value)">
                    </td>
                    <td>
                        <input type="number" class="emp-input" value="${r.employeeCount || ''}" 
                               placeholder="-"
                               style="width:60px; text-align:center; border:1px solid #ddd; border-radius:4px; padding:4px;"
                               onchange="updateField(${idx}, 'employeeCount', parseInt(this.value) || 0)">
                    </td>
                    <td>
                        <input type="text" class="industry-input" value="${r.industry || ''}" 
                               placeholder="ì—…ì¢…"
                               style="width:100%; border:1px solid #ddd; border-radius:4px; padding:4px 6px; font-size:12px;"
                               onchange="updateField(${idx}, 'industry', this.value)">
                    </td>
                    <td>
                        <input type="text" class="note-input" value="${r.note || ''}" 
                               placeholder="ê¸°íƒ€ ë©”ëª¨"
                               onchange="updateField(${idx}, 'note', this.value)">
                    </td>
                </tr>
            `}).join('');
            
            // ì„ íƒ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
            document.getElementById('selectedCount').textContent = '0ê°œ ì„ íƒ';
            document.getElementById('selectAllCheckbox').checked = false;
        }
        
        // â˜…â˜…â˜… v9.4.4: í•„ë“œ ì—…ë°ì´íŠ¸ í†µí•© í•¨ìˆ˜ â˜…â˜…â˜…
        window.updateField = function(idx, field, value) {
            if (rentrollData[idx]) {
                rentrollData[idx][field] = value;
                console.log(`ì—…ë°ì´íŠ¸: ${rentrollData[idx].companyName} - ${field} = ${value}`);
                
                // ì§ì›ìˆ˜ ë³€ê²½ ì‹œ ì´ ê·¼ë¡œì ìˆ˜ ê°±ì‹ 
                if (field === 'employeeCount') {
                    const total = rentrollData.reduce((sum, r) => sum + (r.employeeCount || 0), 0);
                    document.getElementById('previewEmployeeCount').textContent = total.toLocaleString();
                }
            }
        };
        
        // ê¸°ì¡´ ê°œë³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (í•˜ìœ„ í˜¸í™˜)
        window.updateFloor = function(idx, value) { updateField(idx, 'floor', value); };
        window.updateNote = function(idx, value) { updateField(idx, 'note', value); };
        
        // ë¹ˆ ê²°ê³¼ í‘œì‹œ
        function displayEmptyRentroll(message) {
            document.getElementById('rentrollPreview').style.display = 'block';
            document.getElementById('rentrollControls').style.display = 'none';
            document.getElementById('previewCompanyCount').textContent = '0';
            document.getElementById('previewEmployeeCount').textContent = '0';
            
            const tbody = document.getElementById('rentrollTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center; padding:40px; color:#888;">
                        <div style="margin-bottom:15px;">ğŸ“­ ${message}</div>
                        <div style="font-size:12px; color:#aaa;">ë‹¤ë¥¸ ì¡°íšŒ ë°©ë²•ì„ ì‹œë„í•˜ê±°ë‚˜, ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                    </td>
                </tr>
            `;
        }
        
        // â˜…â˜…â˜… v9.4.0: ì²´í¬ë°•ìŠ¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤ â˜…â˜…â˜…
        window.toggleSelectAll = function(checkbox) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                toggleRowHighlight(cb);
            });
            updateSelectedCount();
        };
        
        window.selectAllRentroll = function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = true;
                toggleRowHighlight(cb);
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectedCount();
        };
        
        window.deselectAllRentroll = function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
                toggleRowHighlight(cb);
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedCount();
        };
        
        window.toggleRowHighlight = function(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                row.classList.add('checked');
            } else {
                row.classList.remove('checked');
            }
        };
        
        window.updateSelectedCount = function() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            document.getElementById('selectedCount').textContent = `${checkboxes.length}ê°œ ì„ íƒ`;
            
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            document.getElementById('selectAllCheckbox').checked = 
                allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        };
        
        window.deleteSelectedRentroll = function() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            if (!confirm(`ì„ íƒí•œ ${checkboxes.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const selectedIdxs = Array.from(checkboxes)
                .map(cb => parseInt(cb.dataset.idx))
                .sort((a, b) => b - a);
            
            selectedIdxs.forEach(idx => rentrollData.splice(idx, 1));
            
            displayRentrollTable();
            showToast(`${selectedIdxs.length}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        };
        
        // â˜…â˜…â˜… v9.4.5: ì„ íƒ í•­ëª© êµ­ë¯¼ì—°ê¸ˆ ì¡°íšŒ (ì§ì›ìˆ˜ input ì—…ë°ì´íŠ¸) â˜…â˜…â˜…
        window.enrichSelectedWithNps = async function() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            
            let targetIdxs = [];
            if (checkboxes.length === 0) {
                targetIdxs = rentrollData.map((_, idx) => idx);
                if (!confirm(`ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ${targetIdxs.length}ê°œ í•­ëª©ì„ ì¡°íšŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            } else {
                targetIdxs = Array.from(checkboxes).map(cb => parseInt(cb.dataset.idx));
            }
            
            if (targetIdxs.length === 0) {
                showToast('ì¡°íšŒí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            const bCode = selectedBuilding.bCode || '';
            showLoading(`êµ­ë¯¼ì—°ê¸ˆ ì •ë³´ ì¡°íšŒ ì¤‘... (${targetIdxs.length}ê°œ)`);
            
            let updatedCount = 0;
            let notFoundCount = 0;
            
            try {
                for (const idx of targetIdxs) {
                    const company = rentrollData[idx];
                    if (!company || !company.companyName) continue;
                    
                    try {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const response = await fetch(`${API_BASE_URL}/api/nps/company?companyName=${encodeURIComponent(company.companyName)}&bCode=${bCode}`);
                        const data = await response.json();
                        
                        console.log(`NPS ì¡°íšŒ: ${company.companyName}`, data);
                        
                        if (data.success && data.found) {
                            const prevCount = rentrollData[idx].employeeCount || 0;
                            const newCount = data.employeeCount || 0;
                            
                            rentrollData[idx].employeeCount = newCount;
                            
                            // ì—…ì¢… ì •ë³´ë„ ì—…ë°ì´íŠ¸
                            if (data.industry && !rentrollData[idx].industry) {
                                rentrollData[idx].industry = data.industry;
                            }
                            
                            // í…Œì´ë¸” í–‰ ì—…ë°ì´íŠ¸ (input í•„ë“œ)
                            const row = document.querySelector(`tr[data-idx="${idx}"]`);
                            if (row) {
                                const empInput = row.querySelector('.emp-input');
                                if (empInput) {
                                    empInput.value = newCount || '';
                                    empInput.style.backgroundColor = '#dcfce7';
                                }
                                
                                const industryInput = row.querySelector('.industry-input');
                                if (industryInput && data.industry && !industryInput.value) {
                                    industryInput.value = data.industry;
                                    industryInput.style.backgroundColor = '#dcfce7';
                                }
                            }
                            
                            updatedCount++;
                            console.log(`NPS ê°±ì‹ : ${company.companyName} ${prevCount}ëª… â†’ ${newCount}ëª…`);
                        } else {
                            notFoundCount++;
                            console.log(`NPS ë¯¸ë°œê²¬: ${company.companyName}`);
                        }
                    } catch (e) {
                        console.log(`NPS ì¡°íšŒ ì‹¤íŒ¨: ${company.companyName}`, e);
                        notFoundCount++;
                    }
                }
                
                // ì´ ê·¼ë¡œì ìˆ˜ ì—…ë°ì´íŠ¸
                const allEmployees = rentrollData.reduce((sum, r) => sum + (r.employeeCount || 0), 0);
                document.getElementById('previewEmployeeCount').textContent = allEmployees.toLocaleString();
                
                if (updatedCount > 0) {
                    showToast(`${updatedCount}ê°œ ì—…ì²´ ì •ë³´ë¥¼ NPSë¡œ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤`, 'success');
                } else if (notFoundCount > 0) {
                    showToast(`${notFoundCount}ê°œ ì—…ì²´ë¥¼ êµ­ë¯¼ì—°ê¸ˆì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤`, 'warning');
                } else {
                    showToast('ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                }
                
            } catch (e) {
                console.error('NPS ë³´ì™„ ì˜¤ë¥˜:', e);
                showToast('êµ­ë¯¼ì—°ê¸ˆ ì •ë³´ ë³´ì™„ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoading();
            }
        };
        
        // ì¸µìˆ˜ ì—…ë°ì´íŠ¸
        window.updateFloor = function(idx, value) {
            if (rentrollData[idx]) {
                rentrollData[idx].floor = value;
            }
        };
        
        // ë¹„ê³  ì—…ë°ì´íŠ¸
        window.updateNote = function(idx, value) {
            if (rentrollData[idx]) {
                rentrollData[idx].note = value;
            }
        };
        
        // â˜…â˜…â˜… v9.5.2: ë¹Œë”© ë“±ë¡ (ê¸°ì¡´ ë¹Œë”© ì²´í¬ ì¶”ê°€) â˜…â˜…â˜…
        window.registerBuilding = async function() {
            const buildingName = document.getElementById('buildingName').value.trim();
            if (!buildingName) {
                showToast('ë¹Œë”©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            showLoading('ë¹Œë”© ë“±ë¡ ì¤‘...');
            
            try {
                const now = new Date();
                const targetDate = document.getElementById('targetDate').value; // YYYY-MM
                const roadAddress = document.getElementById('roadAddress').value;
                
                // â˜…â˜…â˜… ê¸°ì¡´ ë¹Œë”© ì²´í¬ â˜…â˜…â˜…
                console.log('=== ë¹Œë”© ë“±ë¡ ì‹œì‘ ===');
                console.log('ë¹Œë”©ëª…:', buildingName);
                console.log('ì£¼ì†Œ:', roadAddress);
                console.log('ê¸°ì¡´ ë¹Œë”© ë°°ì—´ í¬ê¸°:', existingBuildings.length);
                
                const existingBuilding = checkDuplicate(roadAddress, buildingName);
                let buildingId = null;
                let isUpdate = false;
                
                if (existingBuilding) {
                    // ê¸°ì¡´ ë¹Œë”©ì´ ìˆìœ¼ë©´ ë ŒíŠ¸ë¡¤ë§Œ ì¶”ê°€í• ì§€ í™•ì¸
                    const confirmUpdate = confirm(
                        `"${existingBuilding.name}" ë¹Œë”©ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n` +
                        `ê¸°ì¡´ ë¹Œë”©ì— ë ŒíŠ¸ë¡¤ë§Œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                        `[í™•ì¸] â†’ ê¸°ì¡´ ë¹Œë”©ì— ë ŒíŠ¸ë¡¤ ì¶”ê°€\n` +
                        `[ì·¨ì†Œ] â†’ ìƒˆ ë¹Œë”©ìœ¼ë¡œ ë“±ë¡`
                    );
                    
                    if (confirmUpdate) {
                        buildingId = existingBuilding.id;
                        isUpdate = true;
                        console.log('ê¸°ì¡´ ë¹Œë”©ì— ë ŒíŠ¸ë¡¤ ì¶”ê°€:', buildingId);
                    }
                }
                
                // ìƒˆ ë¹Œë”© ë“±ë¡ (ê¸°ì¡´ ë¹Œë”© ì„ íƒ ì•ˆí–ˆì„ ë•Œë§Œ)
                if (!buildingId) {
                    const grossFloorSqm = parseFloat(document.getElementById('grossFloorSqm').value.replace(/,/g, '')) || 0;
                    
                    const buildingData = {
                        name: buildingName,
                        address: roadAddress,
                        addressJibun: document.getElementById('jibunAddress').value,
                        coordinates: {
                            lat: selectedBuilding.lat,
                            lng: selectedBuilding.lng
                        },
                        regionId: document.getElementById('region').value,
                        grade: document.getElementById('grade').value,
                        completionYear: document.getElementById('completionYear').value,
                        floors: {
                            above: parseInt(document.getElementById('floorsAbove').value) || 0,
                            below: parseInt(document.getElementById('floorsBelow').value) || 0,
                            display: `ì§€í•˜${document.getElementById('floorsBelow').value || 0}ì¸µ/ì§€ìƒ${document.getElementById('floorsAbove').value || 0}ì¸µ`
                        },
                        area: {
                            grossFloorSqm: grossFloorSqm,
                            grossFloorPy: sqmToPy(grossFloorSqm),
                            landArea: parseFloat(document.getElementById('landArea').value.replace(/,/g, '')) || 0,
                            buildingArea: parseFloat(document.getElementById('buildingArea').value.replace(/,/g, '')) || 0,
                            typicalFloorPy: parseFloat(document.getElementById('typicalFloorPy').value) || 0,
                            typicalFloorLeasePy: parseFloat(document.getElementById('typicalFloorLeasePy').value) || 0,
                            exclusiveRate: parseFloat(document.getElementById('exclusiveRate').value) || 0
                        },
                        pricing: {
                            depositPy: document.getElementById('depositPy').value,
                            rentPy: document.getElementById('rentPy').value,
                            maintenancePy: document.getElementById('maintenancePy').value
                        },
                        specs: {
                            passengerElevator: parseInt(document.getElementById('passengerElevator').value) || 0,
                            freightElevator: parseInt(document.getElementById('freightElevator').value) || 0,
                            // â˜…â˜…â˜… v9.5.3: hidden inputì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (fallbackìœ¼ë¡œ selectedBuilding ì‚¬ìš©) â˜…â˜…â˜…
                            structure: document.getElementById('structureHidden').value || 
                                       document.getElementById('structure').value || 
                                       selectedBuilding?.structureFromLedger || '',
                            buildingUse: document.getElementById('buildingUseHidden').value || 
                                         document.getElementById('buildingUse').value || 
                                         selectedBuilding?.buildingUseFromLedger || ''
                        },
                        parking: {
                            total: parseInt(document.getElementById('parkingTotal').value) || 0,
                            ratio: document.getElementById('parkingRatio').value
                        },
                        // â˜…â˜…â˜… v9.6: ê±´ì¶•ë¬¼ëŒ€ì¥ í•µì‹¬ í•„ë“œ ì¶”ê°€ ì €ì¥ â˜…â˜…â˜…
                        bcRat: selectedBuilding?.buildingInfo?.bcRat || 0,
                        vlRat: selectedBuilding?.buildingInfo?.vlRat || 0,
                        mainPurpose: selectedBuilding?.buildingInfo?.mainPurpose || '',
                        etcPurpose: selectedBuilding?.buildingInfo?.etcPurpose || '',
                        roofCode: selectedBuilding?.buildingInfo?.roofCode || '',
                        strctCdNm: selectedBuilding?.buildingInfo?.strctCdNm || '',
                        // â˜…â˜…â˜… v9.6: ê±´ì¶•ë¬¼ëŒ€ì¥ ì›ë³¸ ë°ì´í„° ë³´ì¡´ â˜…â˜…â˜…
                        buildingInfo: selectedBuilding?.buildingInfo || null,
                        nearbyStation: document.getElementById('nearbyStation').value,
                        stationDistance: document.getElementById('stationDistance').value,
                        pm: document.getElementById('pm').value,
                        owner: document.getElementById('owner').value,
                        isNew: true,
                        registeredAt: now.toISOString(),
                        newUntil: new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    };
                    
                    // Firebaseì— ë¹Œë”© ì €ì¥
                    const buildingRef = push(ref(db, 'buildings'));
                    await set(buildingRef, buildingData);
                    buildingId = buildingRef.key;
                    console.log('ìƒˆ ë¹Œë”© ë“±ë¡:', buildingId);
                }
                
                // â˜…â˜…â˜… v9.5.3: ë ŒíŠ¸ë¡¤ ì €ì¥ (ì²´í¬ëœ ê²ƒë§Œ, ë¹ˆ ë°ì´í„° ì œì™¸) â˜…â˜…â˜…
                let rentrollCount = 0;
                const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
                const saveAll = checkedBoxes.length === 0;
                
                for (let i = 0; i < rentrollData.length; i++) {
                    const r = rentrollData[i];
                    
                    // â˜… íšŒì‚¬ëª…ì´ ì—†ê±°ë‚˜ í•˜ì´í”ˆì´ë©´ ê±´ë„ˆë›°ê¸° â˜…
                    const tenantName = (r.companyName || '').trim();
                    if (!tenantName || tenantName === '-' || tenantName === '') {
                        console.log(`ìŠ¤í‚µ: ì¸ë±ìŠ¤ ${i} - íšŒì‚¬ëª… ì—†ìŒ`);
                        continue;
                    }
                    
                    // ì²´í¬ë°•ìŠ¤ê°€ ìˆìœ¼ë©´ ì²´í¬ëœ ê²ƒë§Œ, ì—†ìœ¼ë©´ ì „ì²´
                    if (!saveAll) {
                        const checkbox = document.querySelector(`.row-checkbox[data-idx="${i}"]`);
                        if (!checkbox || !checkbox.checked) continue;
                    }
                    
                    // â˜… ë¹„ê³  í†µí•©: ì§ì›ìˆ˜ + ì—…ì¢… + ê¸°íƒ€ë¹„ê³  â˜…
                    const noteParts = [];
                    if (r.employeeCount) noteParts.push(`${r.employeeCount}ëª…`);
                    if (r.industry) noteParts.push(r.industry);
                    if (r.note) noteParts.push(r.note);
                    const combinedNote = noteParts.join(' / ');
                    
                    const rentrollRef = push(ref(db, 'rentrolls'));
                    await set(rentrollRef, {
                        buildingId: buildingId,
                        buildingName: buildingName,
                        tenant: r.companyName,
                        floor: r.floor || '',
                        targetDate: targetDate,
                        note: combinedNote,
                        source: r.source || 'manual',
                        isEstimate: true,
                        createdAt: now.toISOString(),
                        author: 'system'
                    });
                    rentrollCount++;
                }
                
                // ì™„ë£Œ í™”ë©´ìœ¼ë¡œ ì´ë™
                document.getElementById('infoCard').style.display = 'none';
                document.getElementById('completionCard').style.display = 'block';
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');
                
                document.getElementById('completedName').textContent = buildingName;
                document.getElementById('completedAddress').textContent = document.getElementById('roadAddress').value;
                document.getElementById('completedRegion').textContent = document.getElementById('region').value || '-';
                document.getElementById('completedRentroll').textContent = rentrollCount > 0 ? `${rentrollCount}ê°œ ì—…ì²´` : 'ë¯¸ë“±ë¡';
                
                // â˜…â˜…â˜… v9.5.2: ê¸°ì¡´ ë¹Œë”© ì—…ë°ì´íŠ¸ vs ìƒˆ ë¹Œë”© ë“±ë¡ êµ¬ë¶„ â˜…â˜…â˜…
                if (isUpdate) {
                    showToast(`ê¸°ì¡´ ë¹Œë”©ì— ë ŒíŠ¸ë¡¤ ${rentrollCount}ê±´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                    document.querySelector('.completion-title').textContent = 'ë ŒíŠ¸ë¡¤ ì¶”ê°€ ì™„ë£Œ!';
                    document.querySelector('.completion-subtitle').textContent = 'ê¸°ì¡´ ë¹Œë”©ì— ë ŒíŠ¸ë¡¤ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤';
                } else {
                    showToast('ë¹Œë”©ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    document.querySelector('.completion-title').textContent = 'ë¹Œë”© ë“±ë¡ ì™„ë£Œ!';
                    document.querySelector('.completion-subtitle').textContent = 'ìƒˆë¡œìš´ ë¹Œë”©ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤';
                }
                
                // ê¸°ì¡´ ë¹Œë”© ëª©ë¡ ê°±ì‹  (ì¤‘ë³µ ì²´í¬ìš©)
                loadExistingBuildings();
                
            } catch (e) {
                console.error('ë“±ë¡ ì˜¤ë¥˜:', e);
                showToast('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            } finally {
                hideLoading();
            }
        };
        
        // í¼ ë¦¬ì…‹
        window.resetForm = function() {
            selectedBuilding = null;
            rentrollData = [];
            
            document.getElementById('addressInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('selectBuildingBtn').disabled = true;
            document.getElementById('rentrollPreview').style.display = 'none';
            
            document.getElementById('completionCard').style.display = 'none';
            document.getElementById('searchCard').style.display = 'block';
            
            ['step1', 'step2', 'step3'].forEach(id => {
                document.getElementById(id).classList.remove('active', 'completed');
            });
            document.getElementById('step1').classList.add('active');
            
            document.querySelectorAll('#infoCard input, #infoCard select').forEach(el => {
                if (el.type === 'checkbox') el.checked = true;
                else if (el.type !== 'month') el.value = '';
            });
            
            initTargetDate();
        };
        
        // ì´ˆê¸°í™”
        loadExistingBuildings();
        
        // â˜…â˜…â˜… v9.5.3: CSV ë¡œë”©ì„ requestIdleCallbackìœ¼ë¡œ ì™„ì „ ë¹„ë™ê¸°í™” â˜…â˜…â˜…
        // ë¸Œë¼ìš°ì €ê°€ ìœ íœ´ ìƒíƒœì¼ ë•Œë§Œ ì‹¤í–‰ë˜ì–´ UI ë¸”ë¡œí‚¹ ë°©ì§€
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                loadNpsCsvBackground();
            }, { timeout: 5000 });
        } else {
            setTimeout(() => {
                loadNpsCsvBackground();
            }, 1000);
        }
    </script>
</body>
</html>
