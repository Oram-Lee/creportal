<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ëŒ€ì•ˆë‚´ë¬¸ ì—…ë°ì´íŠ¸ v2.2 - CRE PORTAL ê´€ë¦¬</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #868e96;
            --border-color: #dee2e6;
            --accent-color: #2563eb;
            --accent-light: #dbeafe;
            --success-color: #16a34a;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background: var(--bg-secondary); 
            color: var(--text-primary); 
            min-height: 100vh; 
        }
        
        /* í—¤ë” */
        .header {
            height: 56px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 16px;
            color: var(--accent-color);
        }
        .header-nav {
            display: flex;
            gap: 4px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            background: var(--bg-secondary);
        }
        .nav-item:hover { background: var(--bg-tertiary); }
        .nav-item.active { background: var(--accent-color); color: white; }
        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .user-role {
            padding: 2px 8px;
            background: var(--danger-color);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* í˜ì´ì§€ íƒ€ì´í‹€ */
        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .page-title h1 {
            font-size: 24px;
            font-weight: 700;
        }
        .page-title .badge {
            padding: 4px 12px;
            background: var(--accent-light);
            color: var(--accent-color);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ìŠ¤í… ì¹´ë“œ */
        .step-card {
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .step-number {
            width: 28px;
            height: 28px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }
        .step-number.completed {
            background: var(--success-color);
        }
        .step-title {
            font-size: 16px;
            font-weight: 600;
        }
        .step-status {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-muted);
        }
        .step-content {
            padding: 20px;
        }
        
        /* í¼ ìš”ì†Œ */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
        }
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        /* ì¶œì²˜ íšŒì‚¬ ì„ íƒ */
        .source-selector {
            display: flex;
            gap: 8px;
        }
        .source-selector select {
            flex: 1;
        }
        .btn-add-source {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-add-source:hover {
            background: var(--bg-tertiary);
        }
        
        /* ê¶Œì—­ ì„ íƒ */
        .region-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .region-chip {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .region-chip:hover {
            border-color: var(--accent-color);
        }
        .region-chip.selected {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }
        
        /* íŒŒì¼ ì—…ë¡œë“œ */
        .file-upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-upload-zone:hover {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }
        .file-upload-zone.has-file {
            border-style: solid;
            border-color: var(--success-color);
            background: #f0fdf4;
        }
        .file-upload-zone .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .file-upload-zone .text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .file-upload-zone .file-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--success-color);
            margin-top: 8px;
        }
        .file-upload-zone input {
            display: none;
        }
        
        /* ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ */
        .thumbnail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .thumbnail-header .info {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .thumbnail-header .info strong {
            color: var(--accent-color);
        }
        .thumbnail-actions {
            display: flex;
            gap: 8px;
        }
        .btn-select-all {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .btn-select-all:hover {
            background: var(--bg-tertiary);
        }
        
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding: 4px;
        }
        .thumbnail-item {
            position: relative;
            width: 100%;
            padding-bottom: 141%; /* A4 ë¹„ìœ¨ (297/210 = 1.414) */
            background: white;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s;
        }
        .thumbnail-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .thumbnail-item.selected {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }
        .thumbnail-item.skip {
            opacity: 0.5;
        }
        .thumbnail-item canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }
        .thumbnail-item .page-num {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 11px;
            text-align: center;
        }
        .thumbnail-item .page-type {
            position: absolute;
            top: 4px;
            right: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .thumbnail-item .page-type.cover { background: #6b7280; color: white; }
        .thumbnail-item .page-type.toc { background: #8b5cf6; color: white; }
        .thumbnail-item .page-type.divider { background: #f59e0b; color: white; }
        .thumbnail-item .page-type.content { background: var(--success-color); color: white; }
        .thumbnail-item .checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thumbnail-item.selected .checkbox {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }
        
        /* ì§„í–‰ ìƒí™© */
        .progress-section {
            display: none;
        }
        .progress-section.active {
            display: block;
        }
        .progress-bar-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #60a5fa);
            border-radius: 8px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-color);
        }
        .stat-card .label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .stat-card.warning .value { color: var(--warning-color); }
        .stat-card.success .value { color: var(--success-color); }
        .stat-card.danger .value { color: var(--danger-color); }
        
        /* ì‹¤ì‹œê°„ ë¡œê·¸ */
        .realtime-log {
            background: #1e293b;
            border-radius: 8px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #334155;
            display: flex;
            gap: 12px;
        }
        .log-entry .time {
            color: #64748b;
            min-width: 80px;
        }
        .log-entry .page {
            color: #60a5fa;
            min-width: 60px;
        }
        .log-entry .message {
            color: #e2e8f0;
            flex: 1;
        }
        .log-entry.success .message { color: #4ade80; }
        .log-entry.warning .message { color: #fbbf24; }
        .log-entry.error .message { color: #f87171; }
        
        /* ê²°ê³¼ í…Œì´ë¸” */
        .result-section {
            display: none;
        }
        .result-section.active {
            display: block;
        }
        .result-table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .result-table th {
            background: var(--bg-secondary);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }
        .result-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        .result-table tr:hover {
            background: var(--bg-secondary);
        }
        .result-table input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 13px;
            background: transparent;
        }
        .result-table input:focus {
            border-color: var(--accent-color);
            background: white;
            outline: none;
        }
        .result-table .actions {
            display: flex;
            gap: 4px;
        }
        .result-table .btn-action {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 12px;
        }
        .result-table .btn-action:hover {
            background: var(--bg-tertiary);
        }
        .result-table .btn-action.danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .result-table .btn-action.danger:hover {
            background: #fef2f2;
        }
        .result-table .page-link {
            color: var(--accent-color);
            text-decoration: none;
            cursor: pointer;
        }
        .result-table .page-link:hover {
            text-decoration: underline;
        }
        .result-table .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        .result-table .status-badge.new {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .result-table .status-badge.matched {
            background: #dcfce7;
            color: #16a34a;
        }
        .result-table .status-badge.warning {
            background: #fef3c7;
            color: #d97706;
        }
        .result-table tr.no-vacancy {
            background: #f9fafb;
        }
        .result-table tr.no-vacancy:hover {
            background: #f3f4f6;
        }
        
        /* ë²„íŠ¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        .btn-primary:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        .btn-success:hover {
            background: #15803d;
        }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }
        .btn-lg {
            padding: 14px 32px;
            font-size: 16px;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        
        /* ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        /* í† ìŠ¤íŠ¸ */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }
        .toast {
            background: #1e293b;
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.warning { background: var(--warning-color); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
        .preview-modal .modal {
            max-width: 900px;
        }
        .preview-content {
            display: flex;
            gap: 20px;
        }
        .preview-image {
            flex: 1;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
        }
        .preview-image canvas {
            width: 100%;
            height: auto;
        }
        .preview-data {
            width: 350px;
        }
        .preview-data h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        .preview-field {
            margin-bottom: 12px;
        }
        .preview-field label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .preview-field .value {
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* ê³µì‹¤ ì—†ìŒ í–‰ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
        tr.no-vacancy td {
            padding: 12px 8px;
        }
        tr.no-vacancy input[type="text"] {
            width: 100%;
            min-width: 80px;
        }
        
        /* íŒŒì¼ ë³€ê²½ ë²„íŠ¼ */
        .btn-change-file {
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-change-file:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        /* ì¸ë„¤ì¼ ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .thumbnail-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .thumbnail-loading .spinner {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
        }
        .thumbnail-loading .progress-text {
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <a href="portal.html" class="header-logo" style="text-decoration:none;">
            <span>ğŸ¢</span> CRE PORTAL
        </a>
        <nav class="header-nav">
            <a href="portal.html" class="nav-item">ğŸ—ºï¸ ì§€ë„</a>
            <a href="portal.html?view=list" class="nav-item">ğŸ” ê²€ìƒ‰</a>
            <div class="nav-item">ğŸ“‹ Comp List</div>
            <a href="leasing-guide.html" class="nav-item">ğŸ“„ ì„ëŒ€ì•ˆë‚´ë¬¸</a>
            <div class="nav-item">ğŸ“Š ì‹œê³„ì—´</div>
            <div class="nav-item active">âš™ï¸ ê´€ë¦¬</div>
        </nav>
        <div class="header-right">
            <button onclick="toggleTheme()" id="themeBtn" style="background:none; border:none; font-size:18px; cursor:pointer;">ğŸŒ™</button>
            <span class="user-info">
                <span id="userEmail">ë¡œë”©ì¤‘...</span>
                <span class="user-role">ê´€ë¦¬ì</span>
            </span>
        </div>
    </header>
    
    <!-- ë©”ì¸ -->
    <main class="main-container">
        <div class="page-title">
            <h1>ğŸ“„ ì„ëŒ€ì•ˆë‚´ë¬¸ ì—…ë°ì´íŠ¸</h1>
            <span class="badge">OCR ìë™ ì¶”ì¶œ</span>
        </div>
        
        <!-- STEP 1: ê¸°ë³¸ ì •ë³´ -->
        <div class="step-card" id="step1">
            <div class="step-header">
                <span class="step-number">1</span>
                <span class="step-title">ê¸°ë³¸ ì •ë³´ ì…ë ¥</span>
                <span class="step-status" id="step1Status"></span>
            </div>
            <div class="step-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>ë°œê°„íšŒì‚¬ *</label>
                        <div class="source-selector">
                            <select id="sourceCompany">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="CBRE">CBRE</option>
                                <option value="JLL">JLL</option>
                                <option value="Cushman">Cushman & Wakefield</option>
                                <option value="Savills">Savills</option>
                                <option value="Colliers">Colliers</option>
                                <option value="ì‹ ì˜">ì‹ ì˜</option>
                                <option value="êµë³´ë¦¬ì–¼ì½”">êµë³´ë¦¬ì–¼ì½”</option>
                                <option value="ë©”ì´íŠ¸í”ŒëŸ¬ìŠ¤">ë©”ì´íŠ¸í”ŒëŸ¬ìŠ¤</option>
                                <option value="ì  ìŠ¤íƒ€">ì  ìŠ¤íƒ€</option>
                                <option value="other">+ ì§ì ‘ ì…ë ¥</option>
                            </select>
                            <button class="btn-add-source" onclick="showAddSourceModal()">+ ì‹ ê·œ ë“±ë¡</button>
                        </div>
                        <input type="text" id="sourceCompanyCustom" placeholder="íšŒì‚¬ëª… ì§ì ‘ ì…ë ¥" style="display:none; margin-top:8px;">
                    </div>
                    <div class="form-group">
                        <label>ë°œê°„ì—°ì›” *</label>
                        <div style="display:flex; gap:8px;">
                            <select id="publishYear" style="flex:1;">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </select>
                            <select id="publishMonth" style="flex:1;">
                                <option value="01">1ì›”</option>
                                <option value="02">2ì›”</option>
                                <option value="03">3ì›”</option>
                                <option value="04">4ì›”</option>
                                <option value="05">5ì›”</option>
                                <option value="06">6ì›”</option>
                                <option value="07">7ì›”</option>
                                <option value="08">8ì›”</option>
                                <option value="09">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <script>
                    // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì—°ë„/ì›” ë™ì  ìƒì„± ë° ìë™ ì„¤ì •
                    (function() {
                        const now = new Date();
                        const currentYear = now.getFullYear();
                        const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
                        
                        const yearSelect = document.getElementById('publishYear');
                        const monthSelect = document.getElementById('publishMonth');
                        
                        // ì—°ë„ ì˜µì…˜ ë™ì  ìƒì„± (í˜„ì¬ ì—°ë„ + 1ë…„ ~ í˜„ì¬ ì—°ë„ - 3ë…„)
                        yearSelect.innerHTML = '';
                        for (let y = currentYear + 1; y >= currentYear - 3; y--) {
                            const option = document.createElement('option');
                            option.value = y.toString();
                            option.textContent = `${y}ë…„`;
                            if (y === currentYear) option.selected = true;
                            yearSelect.appendChild(option);
                        }
                        
                        // ì›” ì„¤ì •
                        for (let i = 0; i < monthSelect.options.length; i++) {
                            if (monthSelect.options[i].value === currentMonth) {
                                monthSelect.selectedIndex = i;
                                break;
                            }
                        }
                    })();
                </script>
                
                <!-- ê¶Œì—­ ì„ íƒ (ì¶”í›„ êµ¬í˜„ ì˜ˆì •)
                <div class="form-group">
                    <label>ê¶Œì—­ ì„ íƒ</label>
                    <div class="region-selector">
                        <div class="region-chip selected" data-region="ALL">ì „ì²´</div>
                        <div class="region-chip" data-region="GBD">GBD (ê°•ë‚¨)</div>
                        <div class="region-chip" data-region="YBD">YBD (ì—¬ì˜ë„)</div>
                        <div class="region-chip" data-region="CBD">CBD (ë„ì‹¬)</div>
                        <div class="region-chip" data-region="BBD">BBD (ë¶„ë‹¹)</div>
                        <div class="region-chip" data-region="ETC">ê¸°íƒ€</div>
                    </div>
                </div>
                -->
                
                <div class="form-group">
                    <label>PDF íŒŒì¼ ì—…ë¡œë“œ *</label>
                    <div class="file-upload-zone" id="fileUploadZone" onclick="document.getElementById('pdfFile').click()">
                        <div class="icon" id="uploadIcon">ğŸ“</div>
                        <div class="text" id="uploadText">í´ë¦­í•˜ì—¬ PDF íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜<br>ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                        <div class="loading-indicator" id="uploadLoading" style="display:none;">
                            <div class="spinner"></div>
                            <div class="loading-text">PDF ë¡œë”© ì¤‘... <span id="uploadProgress">0</span>%</div>
                        </div>
                        <input type="file" id="pdfFile" accept=".pdf">
                    </div>
                </div>
                
                <!-- êµ¬ë¶„ì„  -->
                <div style="display: flex; align-items: center; margin: 24px 0; gap: 16px;">
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    <span style="color: var(--text-muted); font-size: 13px; font-weight: 500;">ë˜ëŠ”</span>
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                </div>
                
                <!-- ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° -->
                <div class="form-group">
                    <label>ğŸ“¤ ê¸°ì¡´ ì¶”ì¶œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</label>
                    <div style="padding: 20px; background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 8px; text-align: center;">
                        <div style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px;">
                            ì´ì „ì— ë‹¤ìš´ë¡œë“œí•œ JSON íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´<br>
                            <strong>OCR ì—†ì´ ë°”ë¡œ Firebaseì— ì €ì¥</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <label class="btn btn-secondary" style="cursor: pointer;">
                                ğŸ“‚ JSON íŒŒì¼ ì„ íƒ
                                <input type="file" accept=".json" onchange="importFromExcel(event)" style="display: none;">
                            </label>
                            <button class="btn btn-secondary" onclick="downloadSampleJson()" style="background: var(--accent-light); color: var(--accent-color);">
                                ğŸ“¥ ìƒ˜í”Œ JSON ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <details style="margin-top: 16px; text-align: left;">
                            <summary style="cursor: pointer; font-size: 12px; color: var(--accent-color); font-weight: 600;">ğŸ“‹ JSON ì–‘ì‹ ì•ˆë‚´</summary>
                            <div style="margin-top: 12px; padding: 12px; background: var(--bg-primary); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                                <pre style="white-space: pre-wrap; font-family: monospace; line-height: 1.5;">{
  "meta": {
    "source": "CBRE",           // ë°œê°„íšŒì‚¬
    "publishDate": "25.01",      // ë°œê°„ì—°ì›” (YY.MM)
    "region": "ALL",             // ê¶Œì—­ (ALL/GBD/YBD/CBD/BBD)
    "buildingCount": 10,         // ë¹Œë”© ìˆ˜
    "vacancyCount": 25           // ê³µì‹¤ ìˆ˜
  },
  "extractedData": [
    {
      "pageNum": 1,              // í˜ì´ì§€ ë²ˆí˜¸
      "buildingName": "ê·¸ë‘ì„œìš¸",  // ë¹Œë”©ëª… (í•„ìˆ˜)
      "address": "ì„œìš¸ ì¢…ë¡œêµ¬ ì¢…ë¡œ 33",  // ì£¼ì†Œ
      "vacancies": [             // ê³µì‹¤ ëª©ë¡
        {
          "floor": "15F",        // ì¸µ
          "exclusiveArea": 300,  // ì „ìš©ë©´ì  (í‰)
          "rentArea": 500,       // ì„ëŒ€ë©´ì  (í‰)
          "depositPy": "1,200",  // ë³´ì¦ê¸ˆ/í‰
          "rentPy": "120",       // ì„ëŒ€ë£Œ/í‰
          "maintenancePy": "35", // ê´€ë¦¬ë¹„/í‰
          "moveInDate": "ì¦‰ì‹œ"   // ì…ì£¼ê°€ëŠ¥ì¼
        }
      ]
    }
  ]
}</pre>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STEP 2: í˜ì´ì§€ ì„ íƒ -->
        <div class="step-card" id="step2" style="display:none;">
            <div class="step-header">
                <span class="step-number">2</span>
                <span class="step-title">OCR ëŒ€ìƒ í˜ì´ì§€ ì„ íƒ</span>
                <span class="step-status" id="step2Status"></span>
            </div>
            <div class="step-content">
                <div class="thumbnail-header">
                    <div class="info">
                        ì´ <strong id="totalPages">0</strong>í˜ì´ì§€ ì¤‘ 
                        <strong id="selectedPages">0</strong>í˜ì´ì§€ ì„ íƒë¨
                    </div>
                    <div class="thumbnail-actions">
                        <button class="btn-select-all" onclick="selectAllPages()">âœ“ ì „ì²´ ì„ íƒ</button>
                        <button class="btn-select-all" onclick="selectContentPages()">ğŸ“„ ë³¸ë¬¸ë§Œ ì„ íƒ</button>
                        <button class="btn-select-all" onclick="deselectAllPages()">âœ• ì„ íƒ í•´ì œ</button>
                    </div>
                </div>
                <div class="thumbnail-grid" id="thumbnailGrid">
                    <!-- ì¸ë„¤ì¼ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                </div>
                
                <!-- â˜… ë°°ì¹˜ ì²˜ë¦¬ ì˜µì…˜ -->
                <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        âš™ï¸ OCR ë°°ì¹˜ ì²˜ë¦¬ ì„¤ì •
                        <span style="font-size: 11px; color: #666; font-weight: normal;">(Render.com ìµœì í™”)</span>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 13px;">ë°°ì¹˜ í¬ê¸°:</span>
                            <select id="batchSize" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                <option value="5">5ê°œì”©</option>
                                <option value="10" selected>10ê°œì”© (ê¶Œì¥)</option>
                                <option value="20">20ê°œì”©</option>
                                <option value="30">30ê°œì”©</option>
                                <option value="0">ì „ì²´ (ë°°ì¹˜ ì—†ìŒ)</option>
                            </select>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="autoPauseBatch" checked style="width: 16px; height: 16px;">
                            <span style="font-size: 13px;">ë°°ì¹˜ ì™„ë£Œ ì‹œ í™•ì¸ í›„ ê³„ì†</span>
                        </label>
                    </div>
                    
                    <!-- ì´ì–´ì„œ ì²˜ë¦¬ ì˜µì…˜ -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d1d5db;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 13px; color: #666;">ğŸ’¾ ì¤‘ê°„ ì €ì¥ëœ ì‘ì—… ì´ì–´ì„œ ì²˜ë¦¬:</span>
                            <input type="file" id="resumeJsonFile" accept=".json" style="display: none;" onchange="loadResumeJson(this)">
                            <button onclick="document.getElementById('resumeJsonFile').click()" 
                                    style="padding: 6px 12px; background: #e0f2fe; color: #0369a1; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ğŸ“‚ JSON ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                            <span id="resumeStatus" style="font-size: 12px; color: #666;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="action-bar">
                <button class="btn btn-secondary" onclick="goToStep(1)">â† ì´ì „</button>
                <button class="btn btn-primary btn-lg" id="startOcrBtn" onclick="startOCR()" disabled>
                    ğŸš€ OCR ì¶”ì¶œ ì‹œì‘
                </button>
            </div>
        </div>
        
        <!-- STEP 3: ì²˜ë¦¬ ì§„í–‰ -->
        <div class="step-card" id="step3" style="display:none;">
            <div class="step-header">
                <span class="step-number">3</span>
                <span class="step-title">OCR ì²˜ë¦¬ ì§„í–‰ ì¤‘</span>
                <span id="versionBadge" style="display:none; padding: 4px 10px; background: #fef3c7; color: #b45309; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px;">
                    ë²„ì „: --
                </span>
                <span id="batchBadge" style="display:none; padding: 4px 10px; background: #dbeafe; color: #1d4ed8; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px;">
                    ë°°ì¹˜: --
                </span>
                <span class="step-status" id="step3Status"></span>
            </div>
            <div class="step-content">
                <div class="progress-section active">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-card">
                            <div class="value" id="statProcessed">0</div>
                            <div class="label">ì²˜ë¦¬ ì™„ë£Œ</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="statBuildings">0</div>
                            <div class="label">ë°œê²¬ëœ ë¹Œë”©</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="statVacancies">0</div>
                            <div class="label">ì¶”ì¶œëœ ê³µì‹¤</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="statWarnings">0</div>
                            <div class="label">í™•ì¸ í•„ìš”</div>
                        </div>
                    </div>
                    <div class="realtime-log" id="realtimeLog">
                        <div class="log-entry">
                            <span class="time">--:--:--</span>
                            <span class="page">ëŒ€ê¸°</span>
                            <span class="message">OCR ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...</span>
                        </div>
                    </div>
                </div>
                
                <!-- â˜… ë°°ì¹˜ ì™„ë£Œ ì‹œ í‘œì‹œë˜ëŠ” í™•ì¸ ì˜ì—­ -->
                <div id="batchPausePanel" style="display: none; margin-top: 16px; padding: 16px; background: #fef3c7; border-radius: 10px; border: 2px solid #f59e0b;">
                    <div style="font-weight: 600; color: #b45309; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        â¸ï¸ ë°°ì¹˜ ì²˜ë¦¬ ì™„ë£Œ - í™•ì¸ í•„ìš”
                    </div>
                    <div style="font-size: 13px; color: #92400e; margin-bottom: 12px;">
                        <span id="batchStatusText">ë°°ì¹˜ 1/5 ì™„ë£Œ (10ê°œ ì²˜ë¦¬ë¨)</span>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="continueBatchOCR()" style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            â–¶ ê³„ì† ì§„í–‰
                        </button>
                        <button onclick="saveIntermediateJson()" style="padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ğŸ’¾ ì¤‘ê°„ ì €ì¥ (JSON)
                        </button>
                        <button onclick="goToStep(4)" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ğŸ“‹ í˜„ì¬ ê²°ê³¼ í™•ì¸
                        </button>
                        <button onclick="cancelBatchOCR()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            âœ• ì¤‘ë‹¨
                        </button>
                    </div>
                </div>
            </div>
            <div class="action-bar">
                <button class="btn btn-secondary" onclick="cancelOCR()">ì·¨ì†Œ</button>
                <button class="btn btn-secondary" onclick="saveIntermediateJson()" style="margin-left: auto; margin-right: 10px;">
                    ğŸ’¾ ì¤‘ê°„ ì €ì¥
                </button>
                <button class="btn btn-primary" id="viewResultsBtn" onclick="goToStep(4)" disabled>
                    ê²°ê³¼ í™•ì¸ â†’
                </button>
            </div>
        </div>
        
        <!-- STEP 4: ê²°ê³¼ í™•ì¸ -->
        <div class="step-card" id="step4" style="display:none;">
            <div class="step-header">
                <span class="step-number">4</span>
                <span class="step-title">ì¶”ì¶œ ê²°ê³¼ í™•ì¸ ë° í¸ì§‘</span>
                <span class="step-status" id="step4Status"></span>
            </div>
            <div class="step-content">
                <div class="result-section active">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div>
                            <span style="font-size:14px; color:var(--text-muted);">
                                ì´ <strong id="resultBuildingCount">0</strong>ê°œ ë¹Œë”©, 
                                <strong id="resultVacancyCount">0</strong>ê±´ ê³µì‹¤
                            </span>
                        </div>
                        <div style="display:flex; gap:8px; align-items: center;">
                            <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ</button>
                            <span style="color: var(--text-muted); font-size: 12px;">|</span>
                            <label class="btn btn-secondary" style="cursor: pointer; margin: 0;">
                                ğŸ“¤ JSON ì—…ë¡œë“œ
                                <input type="file" accept=".json" onchange="importFromExcel(event)" style="display: none;">
                            </label>
                        </div>
                    </div>
                    
                    <!-- ì—…ë¡œë“œ ì•ˆë‚´ -->
                    <div id="uploadGuide" style="display: none; padding: 16px; background: var(--accent-light); border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">ğŸ’¡ Excel ì—…ë¡œë“œ ì•ˆë‚´</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            ì´ì „ì— ë‹¤ìš´ë¡œë“œí•œ Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ OCR ì—†ì´ ë°”ë¡œ Firebaseì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                    
                    <div class="result-table-container">
                        <table class="result-table">
                            <thead>
                                <tr>
                                    <th style="width:40px;">P</th>
                                    <th style="width:150px;">ë¹Œë”©ëª…</th>
                                    <th style="width:200px;">ì£¼ì†Œ</th>
                                    <th>ê³µì‹¤ì¸µ</th>
                                    <th>ì „ìš©(í‰)</th>
                                    <th>ì„ëŒ€(í‰)</th>
                                    <th>ë³´ì¦ê¸ˆ/í‰</th>
                                    <th>ì„ëŒ€ë£Œ/í‰</th>
                                    <th>ê´€ë¦¬ë¹„/í‰</th>
                                    <th>ì…ì£¼ì‹œê¸°</th>
                                    <th style="width:80px;">ìƒíƒœ</th>
                                    <th style="width:100px;">ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody">
                                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="action-bar">
                <button class="btn btn-secondary" onclick="goToStep(3)">â† ì´ì „</button>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-secondary" onclick="startNewExtraction()">ğŸ”„ ìƒˆ PDF ì¶”ì¶œ</button>
                    <button class="btn btn-secondary" onclick="cancelAll()">ì·¨ì†Œ</button>
                    <button class="btn btn-success btn-lg" onclick="saveToFirebase()">
                        ğŸ’¾ Firebase ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ê³µí†µ ì˜¤ë²„ë ˆì´ -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeAllModals()"></div>
    
    <!-- â˜… v2.2: ì¤‘ë³µ ë°ì´í„° ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="duplicateCheckModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header" style="background: #fef3c7; border-bottom: 1px solid #fcd34d;">
                <span class="modal-title" style="color: #b45309;">âš ï¸ ê¸°ì¡´ ë°ì´í„° ë°œê²¬</span>
                <button class="modal-close" onclick="closeModal('duplicateCheckModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">ë™ì¼í•œ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤:</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);" id="duplicateInfo">
                        <!-- ë™ì : CBRE / 25.01 -->
                    </div>
                    <div style="margin-top: 12px; font-size: 13px; color: var(--text-muted);">
                        <span id="duplicateStats">ë¹Œë”© 15ê°œ, ê³µì‹¤ 42ê±´</span> â€¢ 
                        <span id="duplicateDate">2025-01-15 ë“±ë¡</span>
                    </div>
                </div>
                
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ì²˜ë¦¬ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:</div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label class="duplicate-option" style="display: flex; align-items: flex-start; gap: 12px; padding: 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="duplicateAction" value="overwrite" style="margin-top: 3px;">
                        <div>
                            <div style="font-weight: 600; color: var(--danger-color);">ğŸ”„ ë®ì–´ì“°ê¸°</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì¶”ì¶œí•œ ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.</div>
                        </div>
                    </label>
                    
                    <label class="duplicate-option" style="display: flex; align-items: flex-start; gap: 12px; padding: 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="duplicateAction" value="newVersion" checked style="margin-top: 3px;">
                        <div>
                            <div style="font-weight: 600; color: var(--accent-color);">ğŸ“ ìƒˆ ë²„ì „ìœ¼ë¡œ ì €ì¥</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                ê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê³  ìƒˆ ë²„ì „ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                                <br><strong id="newVersionLabel" style="color: var(--accent-color);">â†’ 25.01_2nd</strong>
                            </div>
                        </div>
                    </label>
                    
                    <label class="duplicate-option" style="display: flex; align-items: flex-start; gap: 12px; padding: 14px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="duplicateAction" value="cancel" style="margin-top: 3px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-secondary);">âŒ ì·¨ì†Œ</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">OCR ì‘ì—…ì„ ì·¨ì†Œí•˜ê³  ì„¤ì •ì„ ë‹¤ì‹œ í™•ì¸í•©ë‹ˆë‹¤.</div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('duplicateCheckModal')">ë‹«ê¸°</button>
                <button class="btn btn-primary" onclick="proceedWithDuplicateAction()">í™•ì¸ í›„ ì§„í–‰</button>
            </div>
        </div>
    </div>
    
    <style>
        .duplicate-option:has(input:checked) {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }
        .duplicate-option:hover {
            border-color: var(--accent-color);
        }
    </style>
    
    <!-- ë¹Œë”© ë§¤ì¹­ ê²€í†  ëª¨ë‹¬ -->
    <div class="modal-overlay" id="matchReviewModalOverlay">
        <div class="modal" id="matchReviewModal" style="max-width: 850px; width: 95%;">
            <div class="modal-header">
                <span class="modal-title">ğŸ” ë¹Œë”© ë§¤ì¹­ ê²€í† </span>
                <button class="modal-close" onclick="closeModal('matchReviewModalOverlay')">Ã—</button>
            </div>
            <div class="modal-body" id="matchReviewContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- ë™ì  ì½˜í…ì¸  -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('matchReviewModalOverlay')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmMatchAndSave()">âœ“ í™•ì¸ í›„ ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- â˜… v2.1: ì‹¤íŒ¨ í˜ì´ì§€ ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="failedPagesModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header" style="background: #fef2f2; border-bottom: 1px solid #fecaca;">
                <span class="modal-title" style="color: #dc2626;">âš ï¸ OCR ì‹¤íŒ¨ í˜ì´ì§€</span>
                <button class="modal-close" onclick="closeModal('failedPagesModal')">Ã—</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">
                    ì•„ë˜ í˜ì´ì§€ì—ì„œ ë°ì´í„° ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¬ì‹œë„í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div id="failedPagesList" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="skipFailedPages()">ê±´ë„ˆë›°ê¸°</button>
                <button class="btn" style="background: #f59e0b; color: white;" onclick="retryFailedPages()">ğŸ”„ ì „ì²´ ì¬ì‹œë„</button>
                <button class="btn btn-primary" onclick="openManualInputModal()">âœï¸ ì§ì ‘ ì…ë ¥</button>
            </div>
        </div>
    </div>
    
    <!-- â˜… v2.1: ì§ì ‘ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="manualInputModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title">ğŸ“ ë¹Œë”© ì •ë³´ ì§ì ‘ ì…ë ¥</span>
                <button class="modal-close" onclick="closeModal('manualInputModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label>í˜ì´ì§€ ë²ˆí˜¸</label>
                    <input type="number" id="manualPageNum" readonly style="background: #f3f4f6;">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label>ë¹Œë”©ëª… *</label>
                    <input type="text" id="manualBuildingName" placeholder="ì˜ˆ: ê·¸ë‘ì„œìš¸">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label>ì£¼ì†Œ</label>
                    <input type="text" id="manualAddress" placeholder="ì˜ˆ: ì„œìš¸ ì¢…ë¡œêµ¬ ì¢…ë¡œ 33">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label>ê³µì‹¤ ì •ë³´ (ì¸µë³„ë¡œ ì¤„ë°”ê¿ˆ)</label>
                    <textarea id="manualVacancies" rows="5" placeholder="ì˜ˆ:&#10;15F, 500í‰, ì „ìš©ë¥  55%&#10;16F, 500í‰, ì „ìš©ë¥  55%"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('manualInputModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveManualInput()">ì €ì¥ í›„ ë‹¤ìŒ</button>
            </div>
        </div>
    </div>
    
    <!-- ì‹ ê·œ íšŒì‚¬ ë“±ë¡ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="addSourceModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ì‹ ê·œ ë°œê°„íšŒì‚¬ ë“±ë¡</span>
                <button class="modal-close" onclick="closeModal('addSourceModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>íšŒì‚¬ëª… (ì •ì‹) *</label>
                    <input type="text" id="newSourceName" placeholder="ì˜ˆ: í•œêµ­ë¶€ë™ì‚°ì›">
                </div>
                <div class="form-group">
                    <label>ì•½ì¹­ / ë³„ì¹­ (ì„ íƒ)</label>
                    <input type="text" id="newSourceAlias" placeholder="ì˜ˆ: ë¶€ë™ì‚°ì›, KAB">
                </div>
                <div class="form-group">
                    <label>ë¡œê³  ì´ëª¨ì§€ (ì„ íƒ)</label>
                    <input type="text" id="newSourceLogo" placeholder="ì˜ˆ: ğŸ¢" maxlength="2">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addSourceModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="addNewSource()">ë“±ë¡</button>
            </div>
        </div>
    </div>
    
    <!-- í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal-overlay preview-modal" id="previewModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">í˜ì´ì§€ <span id="previewPageNum">1</span> ìƒì„¸</span>
                <button class="modal-close" onclick="closeModal('previewModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="preview-content">
                    <div class="preview-image">
                        <canvas id="previewCanvas"></canvas>
                    </div>
                    <div class="preview-data" id="previewData">
                        <!-- ì¶”ì¶œ ë°ì´í„° í‘œì‹œ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="reprocessPage()">ğŸ”„ ë‹¤ì‹œ ì¶”ì¶œ</button>
                <button class="btn btn-primary" onclick="closeModal('previewModal')">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ========== ë¡œê·¸ì¸ ì²´í¬ ==========
        const savedUser = localStorage.getItem('crePortalUser');
        if (!savedUser) {
            window.location.href = 'index.html';
        }
        let currentUser = null;
        try {
            currentUser = JSON.parse(savedUser);
            document.getElementById('userEmail').textContent = currentUser?.name || currentUser?.email?.split('@')[0] || 'ê´€ë¦¬ì';
        } catch(e) {
            window.location.href = 'index.html';
        }

        // ========== í…Œë§ˆ ë¡œë“œ ==========
        const theme = localStorage.getItem('crePortalTheme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        const themeBtn = document.getElementById('themeBtn');
        if (themeBtn) themeBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('crePortalTheme', next);
            const btn = document.getElementById('themeBtn');
            if (btn) btn.textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // PDF.js ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ===== API ì„¤ì • =====
        const API_BASE_URL = 'https://portal-dsyl.onrender.com';

        // ===== Firebase ì„¤ì • =====
        const firebaseConfig = {
            apiKey: "AIzaSyDHfBAQ2ydq4IMmm6WFkS2jj1D8RCVLZJA",
            authDomain: "cre-unified.firebaseapp.com",
            databaseURL: "https://cre-unified-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cre-unified",
            storageBucket: "cre-unified.firebasestorage.app",
            messagingSenderId: "621aborat877104574",
            appId: "1:621877104574:web:ccfe2e659d52e8e3c7f3f8"
        };
        
        // Firebase ì´ˆê¸°í™”
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const storage = firebase.storage();
        
        // ë¹Œë”© ìºì‹œ (ë©”ëª¨ë¦¬)
        let buildingsCache = null;
        let buildingsCacheTime = 0;
        let vacanciesCache = null;  // â˜… ë…ë¦½ vacancies ì»¬ë ‰ì…˜ ìºì‹œ
        const CACHE_TTL = 5 * 60 * 1000; // 5ë¶„

        // ìƒíƒœ ê´€ë¦¬
        let state = {
            pdfDoc: null,
            pdfFile: null,
            totalPages: 0,
            selectedPages: new Set(),
            pageTypes: {}, // { pageNum: 'cover'|'toc'|'divider'|'content' }
            extractedData: [], // OCR ê²°ê³¼
            isProcessing: false,
            currentStep: 1,
            sourceCompanies: [], // ê¸°ì¡´ íšŒì‚¬ ëª©ë¡ (Firebaseì—ì„œ ë¡œë“œ)
            matchResults: [], // ë¹Œë”© ë§¤ì¹­ ê²°ê³¼
            failedPages: [], // â˜… v2.1: OCR ì‹¤íŒ¨ í˜ì´ì§€ ëª©ë¡
            // â˜… v2.2: ì¤‘ë³µ ì²˜ë¦¬ ê´€ë ¨
            currentPublishDate: null, // ë²„ì „ì´ ì ìš©ëœ publishDate (ì˜ˆ: 25.01_2nd)
            duplicateContext: null, // ì¤‘ë³µ ì²´í¬ ì‹œ ì €ì¥ëœ ì»¨í…ìŠ¤íŠ¸
            // â˜… v2.3: ë°°ì¹˜ ì²˜ë¦¬ ê´€ë ¨
            batchState: {
                isPaused: false,
                currentBatch: 0,
                totalBatches: 0,
                processedPagesList: [], // ì´ë¯¸ ì²˜ë¦¬ëœ í˜ì´ì§€ ëª©ë¡
                remainingPages: [], // ë‚¨ì€ í˜ì´ì§€ ëª©ë¡
                continueResolve: null // ê³„ì† ì§„í–‰ Promise resolver
            },
            resumeData: null // JSONì—ì„œ ë¶ˆëŸ¬ì˜¨ ì´ì–´ì„œ ì²˜ë¦¬ ë°ì´í„°
        };
        
        // ===== ë¹Œë”© ë§¤ì¹­ ìœ í‹¸ë¦¬í‹° =====
        
        // ì£¼ì†Œ ì •ê·œí™”
        function normalizeAddress(address) {
            if (!address) return '';
            let normalized = address.trim();
            
            // ì„œìš¸ì‹œ í‘œê¸° í†µì¼
            normalized = normalized.replace(/ì„œìš¸íŠ¹ë³„ì‹œ/g, 'ì„œìš¸');
            normalized = normalized.replace(/ì„œìš¸ì‹œ/g, 'ì„œìš¸');
            
            // ê´„í˜¸ ë‚´ìš© ì œê±°
            normalized = normalized.replace(/\s*\([^)]*\)/g, '');
            
            // íŠ¹ìˆ˜ë¬¸ì ì •ë¦¬
            normalized = normalized.replace(/[,.]/, ' ');
            normalized = normalized.replace(/\s+/g, ' ').trim();
            
            return normalized;
        }
        
        // í•µì‹¬ ì£¼ì†Œ ì¶”ì¶œ (êµ¬ + ë„ë¡œëª…/ë™ + ë²ˆì§€)
        function extractAddressKey(address) {
            const normalized = normalizeAddress(address);
            
            // êµ¬ ì¶”ì¶œ
            const guMatch = normalized.match(/(ê°•ë‚¨êµ¬|ê°•ë™êµ¬|ê°•ë¶êµ¬|ê°•ì„œêµ¬|ê´€ì•…êµ¬|ê´‘ì§„êµ¬|êµ¬ë¡œêµ¬|ê¸ˆì²œêµ¬|ë…¸ì›êµ¬|ë„ë´‰êµ¬|ë™ëŒ€ë¬¸êµ¬|ë™ì‘êµ¬|ë§ˆí¬êµ¬|ì„œëŒ€ë¬¸êµ¬|ì„œì´ˆêµ¬|ì„±ë™êµ¬|ì„±ë¶êµ¬|ì†¡íŒŒêµ¬|ì–‘ì²œêµ¬|ì˜ë“±í¬êµ¬|ìš©ì‚°êµ¬|ì€í‰êµ¬|ì¢…ë¡œêµ¬|ì¤‘êµ¬|ì¤‘ë‘êµ¬)/);
            const gu = guMatch ? guMatch[1] : '';
            
            // ë„ë¡œëª… ì¶”ì¶œ (ì˜ˆ: ì‚¼ë´‰ë¡œ 71, í…Œí—¤ë€ë¡œ 123)
            const roadMatch = normalized.match(/([ê°€-í£]+ë¡œ|[ê°€-í£]+ê¸¸)\s*\d+/);
            
            // ë™ + ìˆ«ì ì¶”ì¶œ (ì˜ˆ: ì‚¼ì„±ë™ 123)
            const dongNumMatch = normalized.match(/([ê°€-í£]+ë™)\s*\d+/);
            
            // â˜… v2.2: ë™ + ì˜ë¬¸/ìˆ«ì í˜¼í•© ì§€ë²ˆ (ì˜ˆ: ë§ˆê³¡ë™ CP3-2, ìƒì•”ë™ DMC1-2)
            const dongAlphaNumMatch = normalized.match(/([ê°€-í£]+ë™)\s*([A-Za-z0-9][-A-Za-z0-9]*)/);
            
            // ë™ë§Œ ìˆëŠ” ê²½ìš° (ì˜ˆ: ë§ˆê³¡ë™)
            const dongOnlyMatch = normalized.match(/([ê°€-í£]+ë™)(?:\s|$)/);
            
            if (roadMatch) {
                return `${gu} ${roadMatch[0]}`.trim();
            } else if (dongNumMatch) {
                return `${gu} ${dongNumMatch[0]}`.trim();
            } else if (dongAlphaNumMatch) {
                // ë§ˆê³¡ë™ CP3-2 â†’ "ê°•ì„œêµ¬ ë§ˆê³¡ë™ CP3-2"
                return `${gu} ${dongAlphaNumMatch[1]} ${dongAlphaNumMatch[2]}`.trim();
            } else if (dongOnlyMatch) {
                return `${gu} ${dongOnlyMatch[1]}`.trim();
            }
            
            return gu || normalized.slice(0, 20);
        }
        
        // ë¬¸ìì—´ ìœ ì‚¬ë„ (0~1)
        function stringSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            const s1 = str1.toLowerCase();
            const s2 = str2.toLowerCase();
            
            if (s1 === s2) return 1;
            
            // Levenshtein ê¸°ë°˜ ê°„ë‹¨ ìœ ì‚¬ë„
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1;
            
            // í¬í•¨ ê´€ê³„ ì²´í¬
            if (longer.includes(shorter) || shorter.includes(longer)) {
                return shorter.length / longer.length + 0.3;
            }
            
            // ë‹¨ì–´ ë§¤ì¹­
            const words1 = s1.split(/\s+/);
            const words2 = s2.split(/\s+/);
            let matchCount = 0;
            
            words1.forEach(w1 => {
                if (words2.some(w2 => w1.includes(w2) || w2.includes(w1))) {
                    matchCount++;
                }
            });
            
            return matchCount / Math.max(words1.length, words2.length);
        }
        
        // Firebaseì—ì„œ ë¹Œë”© ë¡œë“œ (ìºì‹œ ì‚¬ìš©)
        async function loadBuildings(forceReload = false) {
            const now = Date.now();
            
            if (!forceReload && buildingsCache && (now - buildingsCacheTime) < CACHE_TTL) {
                console.log('ğŸ“¦ ìºì‹œëœ ë¹Œë”© ì‚¬ìš©:', Object.keys(buildingsCache).length, 'ê°œ');
                return buildingsCache;
            }
            
            console.log('ğŸ”„ Firebaseì—ì„œ ë¹Œë”© ë° ê³µì‹¤ ë¡œë“œ ì¤‘...');
            // â˜… ë§ˆì´ê·¸ë ˆì´ì…˜ í›„: buildingsì™€ vacancies ë³‘ë ¬ ë¡œë“œ
            const [buildingsSnap, vacanciesSnap] = await Promise.all([
                db.ref('buildings').once('value'),
                db.ref('vacancies').once('value')
            ]);
            
            buildingsCache = buildingsSnap.val() || {};
            vacanciesCache = vacanciesSnap.val() || {};  // â˜… ë…ë¦½ ì»¬ë ‰ì…˜
            buildingsCacheTime = now;
            
            console.log('âœ… ë¹Œë”© ë¡œë“œ ì™„ë£Œ:', Object.keys(buildingsCache).length, 'ê°œ');
            console.log('âœ… ê³µì‹¤ ë¡œë“œ ì™„ë£Œ:', Object.keys(vacanciesCache).length, 'ê°œ ë¹Œë”©');
            return buildingsCache;
        }
        
        // ë¹Œë”© ë§¤ì¹­ (í”„ë¡ íŠ¸ì—”ë“œ)
        async function matchBuilding(buildingName, address, threshold = 0.7) {
            const buildings = await loadBuildings();
            const candidates = [];
            
            const inputAddrKey = extractAddressKey(address);
            const inputNameNorm = (buildingName || '').replace(/ë¹Œë”©|íƒ€ì›Œ|ì„¼í„°|ì˜¤í”¼ìŠ¤/g, '').trim().toLowerCase();
            
            for (const [bldgId, bldg] of Object.entries(buildings)) {
                if (!bldg || typeof bldg !== 'object') continue;
                
                const bldgAddr = bldg.address || '';
                const bldgAddrJibun = bldg.addressJibun || '';
                const bldgName = (bldg.name || '').replace(/ë¹Œë”©|íƒ€ì›Œ|ì„¼í„°|ì˜¤í”¼ìŠ¤/g, '').trim().toLowerCase();
                
                // ì£¼ì†Œ ìœ ì‚¬ë„
                const addrKey = extractAddressKey(bldgAddr);
                const addrSim = stringSimilarity(inputAddrKey, addrKey);
                const addrJibunSim = stringSimilarity(inputAddrKey, extractAddressKey(bldgAddrJibun));
                const bestAddrSim = Math.max(addrSim, addrJibunSim);
                
                // ì´ë¦„ ìœ ì‚¬ë„
                const nameSim = stringSimilarity(inputNameNorm, bldgName);
                
                // ì¢…í•© ì ìˆ˜ (ì£¼ì†Œ 70% + ì´ë¦„ 30%)
                const totalScore = bestAddrSim * 0.7 + nameSim * 0.3;
                
                if (totalScore >= threshold) {
                    candidates.push({
                        buildingId: bldgId,
                        name: bldg.name,
                        address: bldgAddr,
                        addressJibun: bldgAddrJibun,
                        score: totalScore,
                        addressScore: bestAddrSim,
                        nameScore: nameSim
                    });
                }
            }
            
            // ì ìˆ˜ ìˆœ ì •ë ¬
            candidates.sort((a, b) => b.score - a.score);
            
            return {
                candidates: candidates.slice(0, 5),
                bestMatch: candidates.length > 0 ? candidates[0] : null,
                auto: candidates.length > 0 && candidates[0].score >= 0.85
            };
        }
        
        // ë°°ì¹˜ ë§¤ì¹­
        async function batchMatchBuildings(items, autoThreshold = 0.85) {
            console.log('ğŸ”„ ë°°ì¹˜ ë§¤ì¹­ ì‹œì‘:', items.length, 'ê°œ');
            
            // ë¹Œë”© ë¨¼ì € ë¡œë“œ
            await loadBuildings();
            
            const results = [];
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const buildingName = item.buildingName || item.building_name || '';
                const address = item.address || '';
                
                const result = await matchBuilding(buildingName, address);
                
                results.push({
                    input: item,
                    result: {
                        ...result,
                        auto: result.bestMatch && result.bestMatch.score >= autoThreshold
                    }
                });
                
                // ì§„í–‰ë¥  í‘œì‹œ (10ê°œë§ˆë‹¤)
                if ((i + 1) % 10 === 0) {
                    console.log(`   ë§¤ì¹­ ì§„í–‰: ${i + 1}/${items.length}`);
                }
            }
            
            console.log('âœ… ë°°ì¹˜ ë§¤ì¹­ ì™„ë£Œ');
            
            // ìš”ì•½
            const summary = {
                total: results.length,
                autoMatched: results.filter(r => r.result.auto).length,
                needsReview: results.filter(r => r.result.candidates?.length > 0 && !r.result.auto).length,
                noMatch: results.filter(r => !r.result.candidates?.length).length
            };
            
            console.log('ğŸ“Š ë§¤ì¹­ ìš”ì•½:', summary);
            
            return { results, summary };
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            loadSourceCompanies();
            // ë¹Œë”© ë¯¸ë¦¬ ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œ)
            loadBuildings().catch(e => console.warn('ë¹Œë”© ì‚¬ì „ ë¡œë“œ ì‹¤íŒ¨:', e));
        });
        
        function initEventListeners() {
            // íšŒì‚¬ ì„ íƒ ë³€ê²½
            document.getElementById('sourceCompany').addEventListener('change', (e) => {
                const customInput = document.getElementById('sourceCompanyCustom');
                customInput.style.display = e.target.value === 'other' ? 'block' : 'none';
                updateStep1Status();
            });
            
            // ì—°ë„/ì›” ì„ íƒ ë³€ê²½
            document.getElementById('publishYear').addEventListener('change', updateStep1Status);
            document.getElementById('publishMonth').addEventListener('change', updateStep1Status);
            
            // â˜… v2.1: ì§ì ‘ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œì—ë„ status ì—…ë°ì´íŠ¸
            document.getElementById('sourceCompanyCustom').addEventListener('input', updateStep1Status);
            
            // ê¶Œì—­ ì„ íƒ
            document.querySelectorAll('.region-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.region-chip').forEach(c => c.classList.remove('selected'));
                    chip.classList.add('selected');
                });
            });
            
            // íŒŒì¼ ì—…ë¡œë“œ
            const fileInput = document.getElementById('pdfFile');
            const uploadZone = document.getElementById('fileUploadZone');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--accent-color)';
                uploadZone.style.background = 'var(--accent-light)';
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = '';
                uploadZone.style.background = '';
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '';
                uploadZone.style.background = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    fileInput.files = files;
                    handleFileSelect({ target: fileInput });
                }
            });
        }
        
        // íšŒì‚¬ ëª©ë¡ ë¡œë“œ (Firebaseì—ì„œ)
        async function loadSourceCompanies() {
            try {
                // Firebaseì—ì„œ ì‹¤ì œ ë°ì´í„° ë¡œë“œ
                const snapshot = await db.ref('sourceCompanies').once('value');
                const companies = snapshot.val() || {};
                
                // ê¸°ë³¸ íšŒì‚¬ ëª©ë¡ (Firebaseì— ì—†ì„ ê²½ìš° ì‚¬ìš©)
                const defaultCompanies = [
                    { id: 'CBRE', name: 'CBRE', aliases: ['ì”¨ë¹„ì•Œì´'] },
                    { id: 'JLL', name: 'JLL', aliases: ['ì œì´ì—˜ì—˜'] },
                    { id: 'Cushman', name: 'Cushman & Wakefield', aliases: ['ì¿ ì‹œë¨¼', 'C&W'] },
                    { id: 'Savills', name: 'Savills', aliases: ['ì‚¬ë¹ŒìŠ¤'] },
                    { id: 'Colliers', name: 'Colliers', aliases: ['ì½œë¦¬ì–´ìŠ¤'] },
                    { id: 'ì‹ ì˜', name: 'ì‹ ì˜', aliases: [] },
                    { id: 'êµë³´ë¦¬ì–¼ì½”', name: 'êµë³´ë¦¬ì–¼ì½”', aliases: ['êµë³´'] },
                    { id: 'ë©”ì´íŠ¸í”ŒëŸ¬ìŠ¤', name: 'ë©”ì´íŠ¸í”ŒëŸ¬ìŠ¤', aliases: ['ë©”í”Œ'] },
                    { id: 'ì  ìŠ¤íƒ€', name: 'ì  ìŠ¤íƒ€', aliases: [] },
                ];
                
                // Firebase ë°ì´í„°ì™€ ê¸°ë³¸ ë°ì´í„° ë³‘í•©
                const mergedCompanies = [...defaultCompanies];
                
                Object.entries(companies).forEach(([id, data]) => {
                    // ê¸°ë³¸ ëª©ë¡ì— ì—†ëŠ” íšŒì‚¬ë§Œ ì¶”ê°€
                    if (!mergedCompanies.find(c => c.id === id || c.name === data.name)) {
                        mergedCompanies.push({
                            id: id,
                            name: data.name || id,
                            aliases: data.aliases || [],
                            fromFirebase: true
                        });
                    }
                });
                
                state.sourceCompanies = mergedCompanies;
                
                // Select ì˜µì…˜ ê°±ì‹ 
                updateSourceCompanySelect();
                
                console.log('âœ… ë°œê°„íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', mergedCompanies.length, 'ê°œ');
                
            } catch (error) {
                console.warn('ë°œê°„íšŒì‚¬ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
                state.sourceCompanies = [
                    { id: 'CBRE', name: 'CBRE', aliases: ['ì”¨ë¹„ì•Œì´'] },
                    { id: 'JLL', name: 'JLL', aliases: ['ì œì´ì—˜ì—˜'] },
                    { id: 'Cushman', name: 'Cushman & Wakefield', aliases: ['ì¿ ì‹œë¨¼', 'C&W'] },
                ];
            }
        }
        
        // Select ì˜µì…˜ ê°±ì‹ 
        function updateSourceCompanySelect() {
            const select = document.getElementById('sourceCompany');
            const currentValue = select.value;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            // íšŒì‚¬ ëª©ë¡ ì¶”ê°€
            state.sourceCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name + (company.fromFirebase ? ' âœ“' : '');
                select.appendChild(option);
            });
            
            // ì§ì ‘ ì…ë ¥ ì˜µì…˜ ì¶”ê°€
            const otherOption = document.createElement('option');
            otherOption.value = 'other';
            otherOption.textContent = '+ ì§ì ‘ ì…ë ¥';
            select.appendChild(otherOption);
            
            // ì´ì „ ì„ íƒê°’ ë³µì›
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            state.pdfFile = file;
            
            // ë¡œë”© í‘œì‹œ
            const uploadZone = document.getElementById('fileUploadZone');
            const uploadIcon = document.getElementById('uploadIcon');
            const uploadText = document.getElementById('uploadText');
            const uploadLoading = document.getElementById('uploadLoading');
            
            // í´ë¦­ ë¹„í™œì„±í™”
            uploadZone.onclick = null;
            uploadZone.style.pointerEvents = 'none';
            
            if (uploadIcon) uploadIcon.style.display = 'none';
            if (uploadText) uploadText.style.display = 'none';
            if (uploadLoading) {
                uploadLoading.style.display = 'flex';
                document.getElementById('uploadProgress').textContent = '0';
            }
            
            // PDF ë¡œë“œ
            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // ë¡œë”© ì§„í–‰ë¥  í‘œì‹œ
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                loadingTask.onProgress = (progress) => {
                    if (progress.total > 0) {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        const progressEl = document.getElementById('uploadProgress');
                        if (progressEl) progressEl.textContent = percent;
                    }
                };
                
                state.pdfDoc = await loadingTask.promise;
                state.totalPages = state.pdfDoc.numPages;
                
                // ì—…ë¡œë“œ ì™„ë£Œ â†’ ì¸ë„¤ì¼ ìƒì„± ì¤‘ í‘œì‹œ
                uploadZone.innerHTML = `
                    <div class="icon">âœ…</div>
                    <div class="file-name">${file.name}</div>
                    <div class="text">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    <button class="btn-change-file" onclick="resetFileUpload(event)">ë‹¤ë¥¸ íŒŒì¼ ì„ íƒ</button>
                `;
                uploadZone.classList.add('has-file');
                uploadZone.style.pointerEvents = 'auto';
                
                // Step 2ë¡œ ì´ë™í•˜ê³  ì¸ë„¤ì¼ ìƒì„± ë¡œë”© í‘œì‹œ
                goToStep(2);
                showThumbnailLoading(true);
                
                await generateThumbnails();
                
                showThumbnailLoading(false);
                showToast(`${state.totalPages}í˜ì´ì§€ PDF ë¡œë“œ ì™„ë£Œ`, 'success');
            } catch (error) {
                console.error('PDF ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
                uploadZone.innerHTML = `
                    <div class="icon" id="uploadIcon">ğŸ“</div>
                    <div class="text" id="uploadText">í´ë¦­í•˜ì—¬ PDF íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜<br>ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                    <div class="loading-indicator" id="uploadLoading" style="display:none;">
                        <div class="spinner"></div>
                        <div class="loading-text">PDF ë¡œë”© ì¤‘... <span id="uploadProgress">0</span>%</div>
                    </div>
                    <input type="file" id="pdfFile" accept=".pdf">
                `;
                showToast('PDF ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì¸ë„¤ì¼ ìƒì„±
        async function generateThumbnails() {
            const grid = document.getElementById('thumbnailGrid');
            
            document.getElementById('totalPages').textContent = state.totalPages;
            
            // ì¸ë„¤ì¼ ì„ì‹œ ì €ì¥
            const thumbnails = [];
            
            for (let i = 1; i <= state.totalPages; i++) {
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateThumbnailProgress(i, state.totalPages);
                
                const page = await state.pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.3 });
                
                // í˜ì´ì§€ íƒ€ì… ì¶”ì •
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');
                const pageType = classifyPage(text, i);
                state.pageTypes[i] = pageType;
                
                // ì¸ë„¤ì¼ ìš”ì†Œ ìƒì„±
                const item = document.createElement('div');
                item.className = `thumbnail-item ${pageType === 'content' ? 'selected' : 'skip'}`;
                item.dataset.page = i;
                item.onclick = () => togglePageSelection(i);
                
                // ìº”ë²„ìŠ¤
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.objectFit = 'contain';
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                const ctx = canvas.getContext('2d');
                
                await page.render({ canvasContext: ctx, viewport }).promise;
                
                item.innerHTML = `
                    <div class="checkbox">${pageType === 'content' ? 'âœ“' : ''}</div>
                    <span class="page-type ${pageType}">${getPageTypeLabel(pageType)}</span>
                    <div class="page-num">${i} / ${state.totalPages}</div>
                `;
                item.style.position = 'relative';
                item.insertBefore(canvas, item.firstChild);
                
                thumbnails.push(item);
                
                // ë³¸ë¬¸ í˜ì´ì§€ëŠ” ìë™ ì„ íƒ
                if (pageType === 'content') {
                    state.selectedPages.add(i);
                }
            }
            
            // ë¡œë”© ì™„ë£Œ í›„ ì¸ë„¤ì¼ í‘œì‹œ
            grid.innerHTML = '';
            thumbnails.forEach(item => grid.appendChild(item));
            
            updateSelectedCount();
        }
        
        // í˜ì´ì§€ íƒ€ì… ë¶„ë¥˜
        function classifyPage(text, pageNum) {
            const lowerText = text.toLowerCase();
            
            // í‘œì§€ (ì²« í˜ì´ì§€ ë˜ëŠ” íŠ¹ì • í‚¤ì›Œë“œ)
            if (pageNum === 1 || lowerText.includes('office market') || lowerText.includes('ì„ëŒ€ ì•ˆë‚´')) {
                return 'cover';
            }
            
            // ëª©ì°¨
            if (lowerText.includes('contents') || lowerText.includes('ëª©ì°¨') || lowerText.includes('index')) {
                return 'toc';
            }
            
            // ê°„ì§€ (ê¶Œì—­ ì œëª©ë§Œ ìˆëŠ” í˜ì´ì§€)
            if (text.length < 100 && (lowerText.includes('gbd') || lowerText.includes('ybd') || 
                lowerText.includes('cbd') || lowerText.includes('ê°•ë‚¨') || lowerText.includes('ì—¬ì˜ë„'))) {
                return 'divider';
            }
            
            // ë³¸ë¬¸ (ë¹Œë”© ì •ë³´ê°€ ìˆëŠ” í˜ì´ì§€)
            if (lowerText.includes('ë¹Œë”©') || lowerText.includes('íƒ€ì›Œ') || lowerText.includes('ì„¼í„°') ||
                lowerText.includes('building') || lowerText.includes('tower') ||
                lowerText.includes('í‰') || lowerText.includes('ã¡')) {
                return 'content';
            }
            
            return 'content'; // ê¸°ë³¸ê°’
        }
        
        function getPageTypeLabel(type) {
            const labels = {
                'cover': 'í‘œì§€',
                'toc': 'ëª©ì°¨',
                'divider': 'ê°„ì§€',
                'content': 'ë³¸ë¬¸'
            };
            return labels[type] || 'ê¸°íƒ€';
        }
        
        // í˜ì´ì§€ ì„ íƒ í† ê¸€
        function togglePageSelection(pageNum) {
            const item = document.querySelector(`.thumbnail-item[data-page="${pageNum}"]`);
            
            if (state.selectedPages.has(pageNum)) {
                state.selectedPages.delete(pageNum);
                item.classList.remove('selected');
                item.querySelector('.checkbox').textContent = '';
            } else {
                state.selectedPages.add(pageNum);
                item.classList.add('selected');
                item.querySelector('.checkbox').textContent = 'âœ“';
            }
            
            updateSelectedCount();
        }
        
        function selectAllPages() {
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                const pageNum = parseInt(item.dataset.page);
                state.selectedPages.add(pageNum);
                item.classList.add('selected');
                item.querySelector('.checkbox').textContent = 'âœ“';
            });
            updateSelectedCount();
        }
        
        function selectContentPages() {
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                const pageNum = parseInt(item.dataset.page);
                if (state.pageTypes[pageNum] === 'content') {
                    state.selectedPages.add(pageNum);
                    item.classList.add('selected');
                    item.querySelector('.checkbox').textContent = 'âœ“';
                } else {
                    state.selectedPages.delete(pageNum);
                    item.classList.remove('selected');
                    item.querySelector('.checkbox').textContent = '';
                }
            });
            updateSelectedCount();
        }
        
        function deselectAllPages() {
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                item.classList.remove('selected');
                item.querySelector('.checkbox').textContent = '';
            });
            state.selectedPages.clear();
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedPages').textContent = state.selectedPages.size;
            document.getElementById('startOcrBtn').disabled = state.selectedPages.size === 0;
        }
        
        // Step ì´ë™
        function goToStep(step) {
            state.currentStep = step;
            
            // ëª¨ë“  ìŠ¤í… ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.step-card').forEach(card => {
                card.style.display = 'none';
            });
            
            // í•´ë‹¹ ìŠ¤í… í‘œì‹œ
            document.getElementById(`step${step}`).style.display = 'block';
            
            // Step 4ë¡œ ì´ë™ ì‹œ ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
            if (step === 4) {
                renderResultTable();
            }
            
            // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateStep1Status() {
            const selectValue = document.getElementById('sourceCompany').value;
            const customInput = document.getElementById('sourceCompanyCustom');
            const year = document.getElementById('publishYear').value;
            const month = document.getElementById('publishMonth').value;
            
            // â˜… v2.1: other ì„ íƒ ì‹œ customInput ê°’ ì‚¬ìš©
            let company = selectValue;
            if (selectValue === 'other') {
                company = customInput.value.trim() || 'ê¸°íƒ€';
            }
            
            if (company && year && month) {
                document.getElementById('step1Status').textContent = `${company} / ${year.slice(2)}.${month}`;
            }
        }
        
        // OCR ì‹œì‘
        // â˜… v2.2: OCR ì‹œì‘ ì „ ì¤‘ë³µ ì²´í¬
        async function startOCR() {
            if (state.selectedPages.size === 0) {
                showToast('ì²˜ë¦¬í•  í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            // íšŒì‚¬/ë°œê°„ì—°ì›” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const company = getSelectedCompany();
            if (!company) {
                showToast('ë°œê°„íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
                goToStep(1);
                return;
            }
            
            const year = document.getElementById('publishYear').value;
            const month = document.getElementById('publishMonth').value;
            const publishDate = `${year.slice(2)}.${month}`;
            
            // ì¤‘ë³µ ì²´í¬
            showToast('ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì¤‘...', 'info');
            const duplicateCheck = await checkDuplicateData(company, publishDate);
            
            if (duplicateCheck.exists) {
                // ì¤‘ë³µ ë°œê²¬ â†’ ëª¨ë‹¬ í‘œì‹œ
                state.duplicateContext = {
                    company,
                    publishDate,
                    originalPublishDate: publishDate,
                    existingData: duplicateCheck.data,
                    nextVersion: duplicateCheck.nextVersion
                };
                
                showDuplicateCheckModal(duplicateCheck);
                return;
            }
            
            // ì¤‘ë³µ ì—†ìŒ â†’ ë°”ë¡œ OCR ì§„í–‰
            state.currentPublishDate = publishDate;
            await executeOCR();
        }
        
        // â˜… v2.2: ì¤‘ë³µ ë°ì´í„° ì²´í¬ (ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²½ë¡œ ë³€ê²½)
        async function checkDuplicateData(company, publishDate) {
            try {
                await loadBuildings();  // vacanciesCacheë„ í•¨ê»˜ ë¡œë“œë¨
                
                let buildingCount = 0;
                let vacancyCount = 0;
                let latestDate = null;
                const documentIds = new Set();
                
                // â˜… ë§ˆì´ê·¸ë ˆì´ì…˜ í›„: vacanciesCacheì—ì„œ ì¡°íšŒ
                for (const [bldgId, bldgVacancies] of Object.entries(vacanciesCache || {})) {
                    if (!bldgVacancies || typeof bldgVacancies !== 'object') continue;
                    
                    let hasSameSource = false;
                    
                    for (const [vacId, vacancy] of Object.entries(bldgVacancies)) {
                        // sourceì™€ publishDate ë§¤ì¹­ (ë²„ì „ í¬í•¨)
                        const vacSource = vacancy.source || '';
                        const vacPubDate = vacancy.publishDate || '';
                        
                        // ì •í™•íˆ ê°™ê±°ë‚˜, ë²„ì „ì´ ë¶™ì€ ê²½ìš° (25.01, 25.01_2nd ë“±)
                        if (vacSource === company && 
                            (vacPubDate === publishDate || vacPubDate.startsWith(publishDate + '_'))) {
                            hasSameSource = true;
                            vacancyCount++;
                            
                            if (vacancy.documentId) {
                                documentIds.add(vacancy.documentId);
                            }
                            
                            // ìµœì‹  ë“±ë¡ì¼ ì¶”ì 
                            if (vacancy.createdAt) {
                                const date = new Date(vacancy.createdAt);
                                if (!latestDate || date > latestDate) {
                                    latestDate = date;
                                }
                            }
                        }
                    }
                    
                    if (hasSameSource) {
                        buildingCount++;
                    }
                }
                
                if (vacancyCount === 0) {
                    return { exists: false };
                }
                
                // ë‹¤ìŒ ë²„ì „ ê³„ì‚°
                const existingVersions = Array.from(documentIds)
                    .map(id => {
                        const match = id.match(/_(\d+)(?:st|nd|rd|th)?$/);
                        return match ? parseInt(match[1]) : 1;
                    });
                
                const maxVersion = existingVersions.length > 0 ? Math.max(...existingVersions) : 1;
                const nextVersionNum = maxVersion + 1;
                const suffix = getOrdinalSuffix(nextVersionNum);
                const nextVersion = `${publishDate}_${nextVersionNum}${suffix}`;
                
                return {
                    exists: true,
                    data: {
                        buildingCount,
                        vacancyCount,
                        latestDate,
                        documentIds: Array.from(documentIds)
                    },
                    nextVersion
                };
                
            } catch (error) {
                console.error('ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', error);
                return { exists: false };
            }
        }
        
        // ì„œìˆ˜ ì ‘ë¯¸ì‚¬
        function getOrdinalSuffix(num) {
            if (num === 1) return 'st';
            if (num === 2) return 'nd';
            if (num === 3) return 'rd';
            return 'th';
        }
        
        // â˜… v2.2: ì¤‘ë³µ ì²´í¬ ëª¨ë‹¬ í‘œì‹œ
        function showDuplicateCheckModal(duplicateCheck) {
            const { company, publishDate } = state.duplicateContext;
            const { data, nextVersion } = duplicateCheck;
            
            document.getElementById('duplicateInfo').textContent = `${company} / ${publishDate}`;
            document.getElementById('duplicateStats').textContent = 
                `ë¹Œë”© ${data.buildingCount}ê°œ, ê³µì‹¤ ${data.vacancyCount}ê±´`;
            document.getElementById('duplicateDate').textContent = 
                data.latestDate ? data.latestDate.toLocaleDateString('ko-KR') + ' ë“±ë¡' : '';
            document.getElementById('newVersionLabel').textContent = `â†’ ${nextVersion}`;
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelector('input[name="duplicateAction"][value="newVersion"]').checked = true;
            
            document.getElementById('duplicateCheckModal').classList.add('show');
        }
        
        // â˜… v2.2: ì¤‘ë³µ ì²˜ë¦¬ ì•¡ì…˜ ì‹¤í–‰
        async function proceedWithDuplicateAction() {
            const selectedAction = document.querySelector('input[name="duplicateAction"]:checked')?.value;
            
            if (!selectedAction || selectedAction === 'cancel') {
                closeModal('duplicateCheckModal');
                showToast('OCR ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                return;
            }
            
            closeModal('duplicateCheckModal');
            
            const { company, publishDate, nextVersion, existingData } = state.duplicateContext;
            
            if (selectedAction === 'overwrite') {
                // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                showToast('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘...', 'info');
                await deleteExistingVacancies(company, publishDate);
                state.currentPublishDate = publishDate;
                showToast('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ. OCR ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
            } else if (selectedAction === 'newVersion') {
                // ìƒˆ ë²„ì „ìœ¼ë¡œ ì €ì¥
                state.currentPublishDate = nextVersion;
                showToast(`ìƒˆ ë²„ì „ (${nextVersion})ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`, 'info');
            }
            
            // OCR ì‹¤í–‰
            await executeOCR();
        }
        
        // â˜… v2.2: ê¸°ì¡´ ê³µì‹¤ ë°ì´í„° ì‚­ì œ (ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²½ë¡œ ë³€ê²½)
        async function deleteExistingVacancies(company, publishDate) {
            try {
                await loadBuildings();  // vacanciesCacheë„ í•¨ê»˜ ë¡œë“œë¨
                const deletePromises = [];
                
                // â˜… ë§ˆì´ê·¸ë ˆì´ì…˜ í›„: vacanciesCacheì—ì„œ ì¡°íšŒ (vacancies/{buildingId}/{vacancyId})
                for (const [bldgId, bldgVacancies] of Object.entries(vacanciesCache || {})) {
                    if (!bldgVacancies || typeof bldgVacancies !== 'object') continue;
                    
                    for (const [vacId, vacancy] of Object.entries(bldgVacancies)) {
                        const vacSource = vacancy.source || '';
                        const vacPubDate = vacancy.publishDate || '';
                        
                        // ì •í™•íˆ ê°™ì€ publishDateë§Œ ì‚­ì œ (ë²„ì „ í¬í•¨ëœ ê²ƒì€ ìœ ì§€)
                        if (vacSource === company && vacPubDate === publishDate) {
                            deletePromises.push(
                                db.ref(`vacancies/${bldgId}/${vacId}`).remove()  // â˜… ê²½ë¡œ ë³€ê²½
                            );
                        }
                    }
                }
                
                await Promise.all(deletePromises);
                console.log(`âœ… ${deletePromises.length}ê°œ ê³µì‹¤ ì‚­ì œ ì™„ë£Œ`);
                
                // ìºì‹œ ê°±ì‹ 
                await loadBuildings(true);
                
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }
        
        // â˜… v2.4: ë°±ì—”ë“œ ì›œì—… í•¨ìˆ˜
        async function warmupBackend() {
            const maxRetries = 3;
            const endpoints = ['/health', '/'];
            
            for (let i = 0; i < maxRetries; i++) {
                for (const endpoint of endpoints) {
                    try {
                        addLog('ì›œì—…', `ë°±ì—”ë“œ ì—°ê²° í™•ì¸ ì¤‘... (${i + 1}/${maxRetries})`, 'info');
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'GET',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            addLog('ì›œì—…', 'âœ… ë°±ì—”ë“œ ì¤€ë¹„ ì™„ë£Œ!', 'success');
                            return true;
                        }
                    } catch (e) {
                        if (e.name === 'AbortError') {
                            addLog('ì›œì—…', `â³ ë°±ì—”ë“œ ê¹¨ìš°ëŠ” ì¤‘... (${i + 1}/${maxRetries})`, 'warning');
                        } else {
                            addLog('ì›œì—…', `ì—°ê²° ì‹œë„ ${i + 1}: ${e.message}`, 'warning');
                        }
                    }
                }
                
                // ì¬ì‹œë„ ì „ ëŒ€ê¸°
                if (i < maxRetries - 1) {
                    addLog('ì›œì—…', '5ì´ˆ í›„ ì¬ì‹œë„...', 'info');
                    await new Promise(r => setTimeout(r, 5000));
                }
            }
            
            addLog('ì›œì—…', 'âš ï¸ ë°±ì—”ë“œ ì‘ë‹µ ì—†ìŒ - OCR ì§„í–‰ ì‹œë„', 'warning');
            return false;
        }
        
        // â˜… v2.3: ë°°ì¹˜ ì²˜ë¦¬ ë°©ì‹ OCR ì‹¤í–‰
        async function executeOCR() {
            goToStep(3);
            state.isProcessing = true;
            
            // â˜… v2.4: ë°±ì—”ë“œ ì›œì—… ë¨¼ì € ì‹¤í–‰
            addLog('ì‹œì‘', 'ğŸ”„ ë°±ì—”ë“œ ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘...', 'info');
            await warmupBackend();
            
            // ì´ì–´ì„œ ì²˜ë¦¬ê°€ ì•„ë‹Œ ê²½ìš° ì´ˆê¸°í™”
            if (!state.resumeData) {
                state.extractedData = [];
                state.failedPages = [];
                state.batchState = {
                    isPaused: false,
                    currentBatch: 0,
                    totalBatches: 0,
                    processedPagesList: [],
                    remainingPages: [],
                    continueResolve: null
                };
            }
            
            // ë°°ì¹˜ ì„¤ì •
            const batchSize = parseInt(document.getElementById('batchSize').value) || 0;
            const autoPause = document.getElementById('autoPauseBatch').checked;
            
            // â˜… v2.2: ë²„ì „ ë°°ì§€ í‘œì‹œ
            const versionBadge = document.getElementById('versionBadge');
            const batchBadge = document.getElementById('batchBadge');
            const company = getSelectedCompany();
            if (state.currentPublishDate && state.currentPublishDate.includes('_')) {
                versionBadge.textContent = `ğŸ“Œ ${company} / ${state.currentPublishDate}`;
                versionBadge.style.display = 'inline-block';
            } else {
                const year = document.getElementById('publishYear').value;
                const month = document.getElementById('publishMonth').value;
                versionBadge.textContent = `${company} / ${year.slice(2)}.${month}`;
                versionBadge.style.display = 'inline-block';
                versionBadge.style.background = 'var(--accent-light)';
                versionBadge.style.color = 'var(--accent-color)';
            }
            
            // í˜ì´ì§€ ëª©ë¡ (ì´ì–´ì„œ ì²˜ë¦¬ì¸ ê²½ìš° ë‚¨ì€ í˜ì´ì§€ë§Œ)
            let pages;
            if (state.resumeData && state.batchState.remainingPages.length > 0) {
                pages = state.batchState.remainingPages;
                addLog('ì¬ê°œ', `ì´ì–´ì„œ ì²˜ë¦¬: ${pages.length}ê°œ í˜ì´ì§€ ë‚¨ìŒ`, 'info');
            } else {
                pages = Array.from(state.selectedPages).sort((a, b) => a - b);
                state.batchState.remainingPages = [...pages];
            }
            
            const total = Array.from(state.selectedPages).length;
            const totalBatches = batchSize > 0 ? Math.ceil(pages.length / batchSize) : 1;
            state.batchState.totalBatches = totalBatches;
            
            // ë°°ì¹˜ ë°°ì§€ í‘œì‹œ
            if (batchSize > 0) {
                batchBadge.style.display = 'inline-block';
            }
            
            let processed = state.batchState.processedPagesList.length;
            let buildings = state.extractedData.filter(d => d.buildingName).length;
            let vacancies = state.extractedData.reduce((sum, d) => sum + (d.vacancies?.length || 0), 0);
            let warnings = state.failedPages.length;
            
            // ë¡œê·¸ ì´ˆê¸°í™” (ì´ì–´ì„œ ì²˜ë¦¬ê°€ ì•„ë‹Œ ê²½ìš°)
            if (!state.resumeData) {
                document.getElementById('realtimeLog').innerHTML = '';
            }
            
            // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
            let currentBatchNum = state.batchState.currentBatch;
            
            while (state.batchState.remainingPages.length > 0) {
                if (!state.isProcessing) break;
                
                currentBatchNum++;
                state.batchState.currentBatch = currentBatchNum;
                
                // í˜„ì¬ ë°°ì¹˜ì˜ í˜ì´ì§€ë“¤
                const batchPages = batchSize > 0 
                    ? state.batchState.remainingPages.splice(0, batchSize)
                    : state.batchState.remainingPages.splice(0);
                
                // ë°°ì¹˜ ë°°ì§€ ì—…ë°ì´íŠ¸
                if (batchSize > 0) {
                    batchBadge.textContent = `ë°°ì¹˜ ${currentBatchNum}/${totalBatches}`;
                }
                
                addLog('ë°°ì¹˜', `â”â”â” ë°°ì¹˜ ${currentBatchNum} ì‹œì‘ (${batchPages.length}í˜ì´ì§€) â”â”â”`, 'info');
                
                // ë°°ì¹˜ ë‚´ í˜ì´ì§€ ì²˜ë¦¬
                for (const pageNum of batchPages) {
                    if (!state.isProcessing) break;
                    
                    try {
                        addLog(pageNum, `í˜ì´ì§€ ${pageNum} ì²˜ë¦¬ ì‹œì‘...`);
                        
                        const result = await processPage(pageNum);
                        
                        if (result) {
                            if (result.buildingName) buildings++;
                            if (result.vacancies) vacancies += result.vacancies.length;
                            if (result.warning) warnings++;
                            
                            state.extractedData.push(result);
                            state.batchState.processedPagesList.push(pageNum);
                            
                            addLog(pageNum, `âœ“ ${result.buildingName || 'ë¹Œë”©'} - ê³µì‹¤ ${result.vacancies?.length || 0}ê±´`, 'success');
                        } else {
                            addLog(pageNum, 'ë°ì´í„° ì—†ìŒ', 'warning');
                            state.failedPages.push({ pageNum, error: 'ë°ì´í„° ì—†ìŒ' });
                            state.batchState.processedPagesList.push(pageNum);
                            warnings++;
                        }
                        
                    } catch (error) {
                        console.error(`Page ${pageNum} error:`, error);
                        addLog(pageNum, `ì˜¤ë¥˜: ${error.message}`, 'error');
                        warnings++;
                        state.failedPages.push({ pageNum, error: error.message });
                        state.batchState.processedPagesList.push(pageNum);
                    }
                    
                    processed++;
                    
                    // UI ì—…ë°ì´íŠ¸
                    const progress = Math.round((processed / total) * 100);
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('progressBar').textContent = `${progress}%`;
                    document.getElementById('statProcessed').textContent = `${processed}/${total}`;
                    document.getElementById('statBuildings').textContent = buildings;
                    document.getElementById('statVacancies').textContent = vacancies;
                    document.getElementById('statWarnings').textContent = warnings;
                }
                
                addLog('ë°°ì¹˜', `â”â”â” ë°°ì¹˜ ${currentBatchNum} ì™„ë£Œ â”â”â”`, 'success');
                
                // ë°°ì¹˜ ì™„ë£Œ í›„ ì¼ì‹œ ì •ì§€ (ì„¤ì •ëœ ê²½ìš° & ë‚¨ì€ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°)
                if (autoPause && batchSize > 0 && state.batchState.remainingPages.length > 0 && state.isProcessing) {
                    state.batchState.isPaused = true;
                    
                    // ì¼ì‹œ ì •ì§€ íŒ¨ë„ í‘œì‹œ
                    document.getElementById('batchPausePanel').style.display = 'block';
                    document.getElementById('batchStatusText').textContent = 
                        `ë°°ì¹˜ ${currentBatchNum}/${totalBatches} ì™„ë£Œ | ì²˜ë¦¬ë¨: ${processed}/${total} | ë‚¨ìŒ: ${state.batchState.remainingPages.length}ê°œ`;
                    
                    addLog('ì¼ì‹œì •ì§€', `ë°°ì¹˜ ${currentBatchNum} ì™„ë£Œ. ê³„ì†í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`, 'warning');
                    
                    // ì‚¬ìš©ìê°€ ê³„ì† ë²„íŠ¼ì„ í´ë¦­í•  ë•Œê¹Œì§€ ëŒ€ê¸°
                    await new Promise(resolve => {
                        state.batchState.continueResolve = resolve;
                    });
                    
                    document.getElementById('batchPausePanel').style.display = 'none';
                    state.batchState.isPaused = false;
                }
            }
            
            // â˜… ë©€í‹°í˜ì´ì§€ ë¹Œë”© ë³‘í•© â˜…
            state.extractedData = mergeMultiPageBuildings(state.extractedData);
            
            // ë³‘í•© í›„ ë¹Œë”©/ê³µì‹¤ ìˆ˜ ì¬ê³„ì‚°
            buildings = state.extractedData.length;
            vacancies = state.extractedData.reduce((sum, b) => sum + (b.vacancies?.length || 0), 0);
            
            document.getElementById('statBuildings').textContent = buildings;
            document.getElementById('statVacancies').textContent = vacancies;
            
            state.isProcessing = false;
            state.resumeData = null; // ì´ì–´ì„œ ì²˜ë¦¬ ë°ì´í„° ì´ˆê¸°í™”
            document.getElementById('viewResultsBtn').disabled = false;
            document.getElementById('batchPausePanel').style.display = 'none';
            batchBadge.style.display = 'none';
            
            addLog('ì™„ë£Œ', `ì´ ${buildings}ê°œ ë¹Œë”©, ${vacancies}ê±´ ê³µì‹¤ ì¶”ì¶œ ì™„ë£Œ`, 'success');
            
            // â˜… v2.1: ì‹¤íŒ¨ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ì¬ì‹œë„ ì˜µì…˜ ì œê³µ
            if (state.failedPages.length > 0) {
                addLog('ê²½ê³ ', `${state.failedPages.length}ê°œ í˜ì´ì§€ ì²˜ë¦¬ ì‹¤íŒ¨`, 'error');
                showFailedPagesModal();
            } else {
                showToast('OCR ì²˜ë¦¬ ì™„ë£Œ!', 'success');
            }
        }
        
        // â˜… v2.3: ë°°ì¹˜ ê³„ì† ì§„í–‰
        function continueBatchOCR() {
            if (state.batchState.continueResolve) {
                state.batchState.continueResolve();
                state.batchState.continueResolve = null;
            }
        }
        
        // â˜… v2.3: ë°°ì¹˜ ì¤‘ë‹¨
        function cancelBatchOCR() {
            state.isProcessing = false;
            if (state.batchState.continueResolve) {
                state.batchState.continueResolve();
                state.batchState.continueResolve = null;
            }
            document.getElementById('batchPausePanel').style.display = 'none';
            document.getElementById('viewResultsBtn').disabled = false;
            addLog('ì¤‘ë‹¨', 'OCR ì²˜ë¦¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ê¹Œì§€ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        }
        
        // â˜… v2.3: ì¤‘ê°„ ê²°ê³¼ JSON ì €ì¥
        function saveIntermediateJson() {
            const company = getSelectedCompany();
            const year = document.getElementById('publishYear').value;
            const month = document.getElementById('publishMonth').value;
            const publishDate = state.currentPublishDate || `${year.slice(2)}.${month}`;
            
            const saveData = {
                version: '2.3',
                savedAt: new Date().toISOString(),
                source: company,
                publishDate: publishDate,
                pdfFileName: state.pdfFile?.name || 'unknown',
                selectedPages: Array.from(state.selectedPages),
                processedPages: state.batchState.processedPagesList,
                remainingPages: state.batchState.remainingPages,
                extractedData: state.extractedData,
                failedPages: state.failedPages,
                batchState: {
                    currentBatch: state.batchState.currentBatch,
                    totalBatches: state.batchState.totalBatches
                }
            };
            
            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ocr_progress_${company}_${publishDate.replace('.', '')}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ì¤‘ê°„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            addLog('ì €ì¥', `JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (${state.extractedData.length}ê°œ ë¹Œë”©)`, 'success');
        }
        
        // â˜… v2.3: JSONì—ì„œ ì´ì–´ì„œ ì²˜ë¦¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadResumeJson(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.version || !data.extractedData) {
                        throw new Error('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤');
                    }
                    
                    state.resumeData = data;
                    state.extractedData = data.extractedData || [];
                    state.failedPages = data.failedPages || [];
                    state.batchState.processedPagesList = data.processedPages || [];
                    state.batchState.remainingPages = data.remainingPages || [];
                    state.batchState.currentBatch = data.batchState?.currentBatch || 0;
                    state.batchState.totalBatches = data.batchState?.totalBatches || 0;
                    state.currentPublishDate = data.publishDate;
                    
                    // ì„ íƒëœ í˜ì´ì§€ ë³µì›
                    if (data.selectedPages && data.selectedPages.length > 0) {
                        state.selectedPages = new Set(data.selectedPages);
                    }
                    
                    const remainingCount = state.batchState.remainingPages.length;
                    const processedCount = state.batchState.processedPagesList.length;
                    
                    document.getElementById('resumeStatus').innerHTML = `
                        âœ… <strong>${data.source} ${data.publishDate}</strong> ë¶ˆëŸ¬ì˜´ | 
                        ì²˜ë¦¬ë¨: ${processedCount}ê°œ | 
                        <span style="color: #dc2626;">ë‚¨ìŒ: ${remainingCount}ê°œ</span>
                    `;
                    
                    showToast(`ì´ì–´ì„œ ì²˜ë¦¬ ë°ì´í„° ë¶ˆëŸ¬ì˜´ (${remainingCount}ê°œ í˜ì´ì§€ ë‚¨ìŒ)`, 'success');
                    
                    // ë‚¨ì€ í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ê²°ê³¼ í™•ì¸ìœ¼ë¡œ
                    if (remainingCount === 0) {
                        showToast('ëª¨ë“  í˜ì´ì§€ê°€ ì´ë¯¸ ì²˜ë¦¬ë¨. ê²°ê³¼ í™•ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'info');
                        goToStep(4);
                    }
                    
                } catch (err) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', err);
                    showToast('JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            input.value = ''; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
        }
        
        // â˜… ë©€í‹°í˜ì´ì§€ ë¹Œë”© ë³‘í•© í•¨ìˆ˜ â˜…
        function mergeMultiPageBuildings(pages) {
            if (!pages || pages.length === 0) return pages;
            
            console.log('=== MULTI-PAGE MERGE STARTED ===');
            const merged = [];
            let i = 0;
            
            while (i < pages.length) {
                const current = pages[i];
                const currentName = current.buildingName || '';
                const currentVacancies = current.vacancies || [];
                const hasVacancies = currentVacancies.length > 0;
                
                // ë‹¤ìŒ í˜ì´ì§€ í™•ì¸
                if (i + 1 < pages.length) {
                    const next = pages[i + 1];
                    const nextName = next.buildingName || '';
                    const nextVacancies = next.vacancies || [];
                    const nextHasVacancies = nextVacancies.length > 0;
                    
                    // ë¹Œë”©ëª… ìœ ì‚¬ë„ ì²´í¬
                    const namesSimilar = areBuildingNamesSimilar(currentName, nextName);
                    
                    // ë³‘í•© ì¡°ê±´:
                    // 1. í˜„ì¬ ê³µì‹¤ ì—†ê³ , ë‹¤ìŒì— ê³µì‹¤ ìˆê³ , ë¹Œë”©ëª… ìœ ì‚¬
                    // 2. ê°™ì€ ë¹Œë”©ëª…ì˜ ì—°ì† í˜ì´ì§€
                    let shouldMerge = false;
                    
                    if (currentName && !hasVacancies && nextHasVacancies && namesSimilar) {
                        shouldMerge = true;
                        console.log(`[Merge Case A] P${current.pageNum} (0 vacancies) + P${next.pageNum} (${nextVacancies.length} vacancies)`);
                    } else if (currentName && nextName && namesSimilar && nextHasVacancies) {
                        shouldMerge = true;
                        console.log(`[Merge Case B] P${current.pageNum} + P${next.pageNum} (same building: ${currentName})`);
                    } else if (currentName && !nextName && nextHasVacancies) {
                        shouldMerge = true;
                        console.log(`[Merge Case C] P${current.pageNum} + P${next.pageNum} (next has no name)`);
                    }
                    
                    if (shouldMerge) {
                        // ë³‘í•© ì‹¤í–‰
                        const mergedPage = { ...current };
                        
                        // ì£¼ì†Œ ë³´ì™„
                        if (!mergedPage.address && next.address) {
                            mergedPage.address = next.address;
                        }
                        
                        // ê³µì‹¤ í•©ì¹˜ê¸°
                        const existingFloors = new Set((mergedPage.vacancies || []).map(v => v.floor));
                        mergedPage.vacancies = [...(mergedPage.vacancies || [])];
                        
                        for (const vacancy of nextVacancies) {
                            if (!existingFloors.has(vacancy.floor)) {
                                mergedPage.vacancies.push(vacancy);
                            }
                        }
                        
                        mergedPage.mergedPages = [current.pageNum, next.pageNum];
                        merged.push(mergedPage);
                        i += 2; // ë‘ í˜ì´ì§€ ê±´ë„ˆë›°ê¸°
                        continue;
                    }
                }
                
                // ë³‘í•© ì—†ì´ ê·¸ëŒ€ë¡œ ì¶”ê°€
                merged.push(current);
                i++;
            }
            
            console.log(`[Result] ${pages.length} pages â†’ ${merged.length} buildings`);
            console.log('=== MULTI-PAGE MERGE DONE ===');
            return merged;
        }
        
        // ë¹Œë”©ëª… ìœ ì‚¬ë„ ì²´í¬
        function areBuildingNamesSimilar(name1, name2) {
            if (!name1 || !name2) return false;
            
            // ì •ê·œí™”
            const normalize = (name) => {
                let n = name.toLowerCase().trim();
                n = n.replace(/\([^)]*\)/g, ''); // ê´„í˜¸ ì œê±°
                n = n.replace(/[^\wê°€-í£]/g, ''); // íŠ¹ìˆ˜ë¬¸ì ì œê±°
                return n;
            };
            
            const n1 = normalize(name1);
            const n2 = normalize(name2);
            
            // ì™„ì „ ì¼ì¹˜
            if (n1 === n2) return true;
            
            // í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨
            if (n1.includes(n2) || n2.includes(n1)) return true;
            
            // í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
            const extractKeywords = (name) => {
                const keywords = [];
                // ì˜ë¬¸
                const eng = name.match(/[a-zA-Z]+/g) || [];
                keywords.push(...eng.filter(w => w.length > 2).map(w => w.toLowerCase()));
                // í•œê¸€ (íƒ€ì›Œ, ë¹Œë”© ì•)
                const kor = name.match(/([ê°€-í£]+)(íƒ€ì›Œ|ë¹Œë”©|ì„¼í„°|í”Œë¼ì)/);
                if (kor) keywords.push(kor[1]);
                return keywords;
            };
            
            const kw1 = extractKeywords(name1);
            const kw2 = extractKeywords(name2);
            
            // í‚¤ì›Œë“œ ê²¹ì¹¨
            for (const k of kw1) {
                if (kw2.includes(k)) return true;
            }
            
            return false;
        }
        
        // í˜ì´ì§€ ì²˜ë¦¬ (OCR + AI íŒŒì‹±)
        async function processPage(pageNum) {
        try {
        // PDF í˜ì´ì§€ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        const page = await state.pdfDoc.getPage(pageNum);
        const scale = 2.0;
        const viewport = page.getViewport({ scale });
        
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        
        await page.render({ canvasContext: ctx, viewport }).promise;
        
        // Base64ë¡œ ë³€í™˜ (OCRìš© - PNG)
        const imageData = canvas.toDataURL('image/png').split(',')[1];
        
        // JPEGë¡œ ì••ì¶• (Storage ì €ì¥ìš© - í’ˆì§ˆ 0.7)
        const jpegDataUrl = canvas.toDataURL('image/jpeg', 0.7);
        
        // API í˜¸ì¶œ (OCR)
        const response = await fetch(`${API_BASE_URL}/api/ocr/process-image`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sessionId: state.sessionId || 'web-session',
                pageNum: pageNum,
                imageData: imageData,
                sourceCompany: document.getElementById('sourceCompany').value,
                publishDate: `${document.getElementById('publishYear').value.slice(2)}.${document.getElementById('publishMonth').value}`
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
            // ì´ë¯¸ì§€ë¥¼ Firebase Storageì— ì—…ë¡œë“œ
            const company = document.getElementById('sourceCompany').value || 'UNKNOWN';
            const publishDate = `${document.getElementById('publishYear').value.slice(2)}.${document.getElementById('publishMonth').value}`;
            
            try {
                const imageUrl = await uploadPageImage(jpegDataUrl, company, publishDate, pageNum);
                result.data.pageImageUrl = imageUrl;
                addLog(pageNum, `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ`, 'success');
            } catch (uploadErr) {
                console.warn('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨ (OCR ê²°ê³¼ëŠ” ìœ ì§€):', uploadErr);
                addLog(pageNum, `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨ (OCR ê²°ê³¼ ìœ ì§€)`, 'warning');
            }
            
            return result.data;
        }
        return null;
        
    } catch (error) {
        console.error('processPage error:', error);
        addLog(pageNum, `ì˜¤ë¥˜: ${error.message}`, 'error');
        return null;
    }
}

        // í˜ì´ì§€ ì´ë¯¸ì§€ Firebase Storage ì—…ë¡œë“œ
        async function uploadPageImage(jpegDataUrl, company, publishDate, pageNum) {
            // Data URLì„ Blobìœ¼ë¡œ ë³€í™˜
            const response = await fetch(jpegDataUrl);
            const blob = await response.blob();
            
            // íŒŒì¼ ê²½ë¡œ: leasing-docs/{company}/{publishDate}/page_{pageNum}.jpg
            const safePubDate = publishDate.replace('.', '_');
            const filePath = `leasing-docs/${company}/${safePubDate}/page_${String(pageNum).padStart(3, '0')}.jpg`;
            
            // Firebase Storageì— ì—…ë¡œë“œ
            const storageRef = storage.ref(filePath);
            const snapshot = await storageRef.put(blob, { contentType: 'image/jpeg' });
            
            // ë‹¤ìš´ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸°
            const downloadUrl = await snapshot.ref.getDownloadURL();
            
            return downloadUrl;
        }
        
        // ë¡œê·¸ ì¶”ê°€
        function addLog(page, message, type = '') {
            const log = document.getElementById('realtimeLog');
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="time">${time}</span>
                <span class="page">P${page}</span>
                <span class="message">${message}</span>
            `;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
        function renderResultTable() {
            const tbody = document.getElementById('resultTableBody');
            let buildingCount = 0;
            let vacancyCount = 0;
            
            let html = '';
            
            state.extractedData.forEach((data, idx) => {
                if (!data || !data.buildingName) return;
                
                buildingCount++;
                
                // ê³µì‹¤ì´ ìˆëŠ” ê²½ìš°: ê³µì‹¤ë³„ë¡œ í–‰ ìƒì„±
                if (data.vacancies && data.vacancies.length > 0) {
                    data.vacancies.forEach((v, vIdx) => {
                        vacancyCount++;
                        html += `
                            <tr data-idx="${idx}" data-vidx="${vIdx}">
                                <td>
                                    <a class="page-link" onclick="showPagePreview(${data.pageNum})">${data.pageNum}</a>
                                </td>
                                <td>
                                    <input type="text" value="${data.buildingName}" onchange="updateField(${idx}, 'buildingName', this.value)">
                                </td>
                                <td>
                                    <input type="text" value="${data.address || ''}" onchange="updateField(${idx}, 'address', this.value)">
                                </td>
                                <td>
                                    <input type="text" value="${v.floor || ''}" onchange="updateVacancyField(${idx}, ${vIdx}, 'floor', this.value)">
                                </td>
                                <td>
                                    <input type="number" value="${v.exclusiveArea || ''}" onchange="updateVacancyField(${idx}, ${vIdx}, 'exclusiveArea', this.value)">
                                </td>
                                <td>
                                    <input type="number" value="${v.rentArea || ''}" onchange="updateVacancyField(${idx}, ${vIdx}, 'rentArea', this.value)">
                                </td>
                                <td>
                                    <input type="text" value="${v.depositPy || ''}" onchange="updateVacancyField(${idx}, ${vIdx}, 'depositPy', this.value)">
                                </td>
                                <td>
                                    <input type="text" value="${v.rentPy || ''}" onchange="updateVacancyField(${idx}, ${vIdx}, 'rentPy', this.value)">
                                </td>
                                <td>
                                    <input type="text" value="${v.maintenancePy || ''}" onchange="updateVacancyField(${idx}, ${vIdx}, 'maintenancePy', this.value)">
                                </td>
                                <td>
                                    <input type="text" value="${v.moveInDate || 'í˜‘ì˜'}" onchange="updateVacancyField(${idx}, ${vIdx}, 'moveInDate', this.value)">
                                </td>
                                <td>
                                    <span class="status-badge ${data.status === 'matched' ? 'matched' : 'new'}">${data.status === 'matched' ? 'ë§¤ì¹­' : 'ì‹ ê·œ'}</span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="btn-action" onclick="reprocessSinglePage(${data.pageNum})">ğŸ”„</button>
                                        <button class="btn-action danger" onclick="deleteRow(${idx}, ${vIdx})">ğŸ—‘ï¸</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    // ê³µì‹¤ì´ ì—†ëŠ” ê²½ìš°: ë¹Œë”© ì •ë³´ë§Œ í‘œì‹œ (ë§Œì‹¤)
                    html += `
                        <tr data-idx="${idx}" data-vidx="-1" class="no-vacancy">
                            <td>
                                <a class="page-link" onclick="showPagePreview(${data.pageNum})">${data.pageNum}</a>
                            </td>
                            <td>
                                <input type="text" value="${data.buildingName}" onchange="updateField(${idx}, 'buildingName', this.value)">
                            </td>
                            <td>
                                <input type="text" value="${data.address || ''}" onchange="updateField(${idx}, 'address', this.value)">
                            </td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td style="text-align:center; color:var(--text-muted);">-</td>
                            <td>
                                <span class="status-badge" style="background:#6b7280;">ë§Œì‹¤</span>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn-action" onclick="reprocessSinglePage(${data.pageNum})">ğŸ”„</button>
                                    <button class="btn-action danger" onclick="deleteBuilding(${idx})">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html || '<tr><td colspan="12" style="text-align:center; padding:40px; color:var(--text-muted);">ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            
            document.getElementById('resultBuildingCount').textContent = buildingCount;
            document.getElementById('resultVacancyCount').textContent = vacancyCount;
        }
        
        // í•„ë“œ ìˆ˜ì •
        function updateField(idx, field, value) {
            if (state.extractedData[idx]) {
                state.extractedData[idx][field] = value;
            }
        }
        
        function updateVacancyField(idx, vIdx, field, value) {
            if (state.extractedData[idx]?.vacancies?.[vIdx]) {
                state.extractedData[idx].vacancies[vIdx][field] = value;
            }
        }
        
        function deleteRow(idx, vIdx) {
            if (confirm('ì´ ê³µì‹¤ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (state.extractedData[idx]?.vacancies) {
                    state.extractedData[idx].vacancies.splice(vIdx, 1);
                    // ê³µì‹¤ì´ 0ì´ ë˜ì–´ë„ ë¹Œë”©ì€ ìœ ì§€ (ë§Œì‹¤ë¡œ í‘œì‹œë¨)
                }
                renderResultTable();
            }
        }
        
        // ë¹Œë”© ì „ì²´ ì‚­ì œ
        function deleteBuilding(idx) {
            if (confirm('ì´ ë¹Œë”©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ëª¨ë“  ê´€ë ¨ ê³µì‹¤ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) {
                state.extractedData.splice(idx, 1);
                renderResultTable();
            }
        }
        
        // í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°
        async function showPagePreview(pageNum) {
            const modal = document.getElementById('previewModal');
            const canvas = document.getElementById('previewCanvas');
            
            const page = await state.pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.0 });
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: canvas.getContext('2d'),
                viewport
            }).promise;
            
            document.getElementById('previewPageNum').textContent = pageNum;
            
            // í•´ë‹¹ í˜ì´ì§€ ë°ì´í„° í‘œì‹œ
            const pageData = state.extractedData.find(d => d.pageNum === pageNum);
            const dataDiv = document.getElementById('previewData');
            
            if (pageData) {
                dataDiv.innerHTML = `
                    <h4>ì¶”ì¶œëœ ì •ë³´</h4>
                    <div class="preview-field">
                        <label>ë¹Œë”©ëª…</label>
                        <div class="value">${pageData.buildingName || '-'}</div>
                    </div>
                    <div class="preview-field">
                        <label>ì£¼ì†Œ</label>
                        <div class="value">${pageData.address || '-'}</div>
                    </div>
                    <h4 style="margin-top:16px;">ê³µì‹¤ ì •ë³´</h4>
                    ${pageData.vacancies?.map(v => `
                        <div class="preview-field">
                            <label>${v.floor}</label>
                            <div class="value">ì „ìš© ${v.exclusiveArea}í‰ / ì„ëŒ€ ${v.rentArea}í‰<br>ì„ëŒ€ë£Œ ${v.rentPy}/í‰</div>
                        </div>
                    `).join('') || '<div class="preview-field"><div class="value">ê³µì‹¤ ì—†ìŒ</div></div>'}
                `;
            } else {
                dataDiv.innerHTML = '<div class="preview-field"><div class="value">ì¶”ì¶œëœ ë°ì´í„° ì—†ìŒ</div></div>';
            }
            
            modal.classList.add('show');
        }
        
        // Firebase ì €ì¥ (í”„ë¡ íŠ¸ì—”ë“œ ì™„ì „ ì²˜ë¦¬)
        async function saveToFirebase() {
            if (!confirm('ì¶”ì¶œëœ ë°ì´í„°ë¥¼ Firebaseì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì €ì¥ í›„ì—ëŠ” ì‚¬ìš©ì í˜ì´ì§€ì—ì„œ ê²€ìƒ‰ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            // â˜… v2.1: íšŒì‚¬ëª… ê°€ì ¸ì˜¤ê¸° (other ì„ íƒ ì‹œ customInput ì‚¬ìš©)
            const company = getSelectedCompany();
            if (!company) {
                showToast('ë°œê°„íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            const year = document.getElementById('publishYear').value;
            const month = document.getElementById('publishMonth').value;
            // â˜… v2.2: ë²„ì „ì´ ì ìš©ëœ publishDate ì‚¬ìš© (ì¤‘ë³µ ì²˜ë¦¬ ì‹œ ì„¤ì •ë¨)
            const basePublishDate = `${year.slice(2)}.${month}`;
            const publishDate = state.currentPublishDate || basePublishDate;
            const region = document.querySelector('.region-chip.selected')?.dataset.region || 'ALL';
            const documentId = `${company}_${publishDate.replace('.', '_')}_${region}`;
            
            // ë²„ì „ì´ ì ìš©ëœ ê²½ìš° ì•ˆë‚´
            if (state.currentPublishDate && state.currentPublishDate !== basePublishDate) {
                showToast(`ë²„ì „ ${publishDate}ë¡œ ì €ì¥í•©ë‹ˆë‹¤.`, 'info');
            }
            
            try {
                // Step 1: ë¹Œë”© ë§¤ì¹­
                showToast('ë¹Œë”© ë§¤ì¹­ ì¤‘...', 'info');
                
                const matchItems = state.extractedData.map(b => ({
                    buildingName: b.buildingName,
                    address: b.address || b.addressNormalized
                }));
                
                const { results: matchResults, summary } = await batchMatchBuildings(matchItems, 0.85);
                
                console.log('ë§¤ì¹­ ê²°ê³¼:', matchResults);
                console.log('ë§¤ì¹­ ìš”ì•½:', summary);
                
                // Step 2: ë§¤ì¹­ ê²€í†  í•„ìš”í•œ í•­ëª© í™•ì¸
                const needsReview = matchResults.filter(r => !r.result.auto && r.result.candidates?.length > 0);
                const noMatch = matchResults.filter(r => !r.result.candidates?.length);
                const autoMatched = matchResults.filter(r => r.result.auto);
                
                showToast(`ìë™ë§¤ì¹­ ${autoMatched.length}ê±´, ê²€í† í•„ìš” ${needsReview.length}ê±´, ë§¤ì¹­ì‹¤íŒ¨ ${noMatch.length}ê±´`, 'info');
                
                // Step 3: ê²€í†  í•„ìš”í•˜ë©´ ëª¨ë‹¬ í‘œì‹œ
                if (needsReview.length > 0 || noMatch.length > 0) {
                    state.matchResults = matchResults;
                    state.saveContext = { company, publishDate, documentId, region };
                    showMatchReviewModal(matchResults, summary);
                    return;
                }
                
                // Step 4: ëª¨ë‘ ìë™ ë§¤ì¹­ë˜ë©´ ë°”ë¡œ ì €ì¥
                await saveVacanciesToFirebase(matchResults, company, publishDate, documentId);
                
            } catch (error) {
                console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ë§¤ì¹­ ê²€í†  ëª¨ë‹¬ í‘œì‹œ
        function showMatchReviewModal(matchResults, summary) {
            const needsReview = matchResults.filter(r => !r.result.auto && r.result.candidates?.length > 0);
            const noMatch = matchResults.filter(r => !r.result.candidates?.length);
            const autoMatched = matchResults.filter(r => r.result.auto);
            
            document.getElementById('matchReviewContent').innerHTML = `
                <div class="match-summary" style="display: flex; gap: 20px; margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--success-color);">${autoMatched.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">ìë™ ë§¤ì¹­</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--warning-color);">${needsReview.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">ê²€í†  í•„ìš”</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--danger-color);">${noMatch.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">ë§¤ì¹­ ì‹¤íŒ¨</div>
                    </div>
                </div>
                
                ${needsReview.length > 0 ? `
                <div class="review-section" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px; color: var(--warning-color);">âš ï¸ ê²€í†  í•„ìš” (${needsReview.length}ê±´)</h4>
                    <div class="review-items" style="max-height: 300px; overflow-y: auto;">
                        ${needsReview.map((r, idx) => `
                            <div class="review-item" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;" data-idx="${matchResults.indexOf(r)}">
                                <div style="font-weight: 600; margin-bottom: 8px;">${r.input.buildingName || '(ì´ë¦„ì—†ìŒ)'}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${r.input.address || ''}</div>
                                <select class="match-select" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;" onchange="updateMatchSelection(${matchResults.indexOf(r)}, this.value)">
                                    <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                                    ${r.result.candidates.map(c => `
                                        <option value="${c.buildingId}" ${c.score >= 0.85 ? 'selected' : ''}>
                                            ${c.name} (${Math.round(c.score * 100)}%) - ${c.address}
                                        </option>
                                    `).join('')}
                                    <option value="__skip__">ê±´ë„ˆë›°ê¸° (ì €ì¥ ì•ˆ í•¨)</option>
                                    <option value="__new__">ì‹ ê·œ ë¹Œë”©ìœ¼ë¡œ ë“±ë¡</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${noMatch.length > 0 ? `
                <div class="nomatch-section">
                    <h4 style="margin-bottom: 12px; color: var(--danger-color);">âŒ ë§¤ì¹­ ì‹¤íŒ¨ (${noMatch.length}ê±´) - ê¸°ì¡´ ë¹Œë”© ê²€ìƒ‰ ë˜ëŠ” ì‹ ê·œ ë“±ë¡</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${noMatch.map((r, idx) => {
                            const globalIdx = matchResults.indexOf(r);
                            return `
                            <div class="nomatch-item" style="padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; background: #fef2f2;" data-idx="${globalIdx}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 15px; color: var(--text-primary);">${r.input.buildingName || '(ì´ë¦„ì—†ìŒ)'}</div>
                                        <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">${r.input.address || ''}</div>
                                    </div>
                                    <span class="match-status-badge" id="matchStatus_${globalIdx}" style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: #fecaca; color: #dc2626;">
                                        ë¯¸ë§¤ì¹­
                                    </span>
                                </div>
                                
                                <!-- ê²€ìƒ‰ ì˜ì—­ -->
                                <div style="background: white; border-radius: 6px; padding: 12px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="text" 
                                               id="searchInput_${globalIdx}" 
                                               placeholder="ë¹Œë”©ëª… ë˜ëŠ” ì£¼ì†Œë¡œ ê²€ìƒ‰..." 
                                               value="${r.input.buildingName || ''}"
                                               style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;"
                                               onkeypress="if(event.key==='Enter') searchBuildingForMatch(${globalIdx})">
                                        <button onclick="searchBuildingForMatch(${globalIdx})" 
                                                style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                                            ğŸ” ê²€ìƒ‰
                                        </button>
                                    </div>
                                    
                                    <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
                                    <div id="searchResults_${globalIdx}" style="display: none; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;">
                                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                                    </div>
                                    
                                    <!-- ì„ íƒëœ ë¹Œë”© í‘œì‹œ -->
                                    <div id="selectedBuilding_${globalIdx}" style="display: none; padding: 8px 12px; background: #d1fae5; border-radius: 4px; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="font-weight: 600; color: #059669;">âœ“ ë§¤ì¹­ë¨:</span>
                                                <span id="selectedBuildingName_${globalIdx}"></span>
                                            </div>
                                            <button onclick="clearBuildingSelection(${globalIdx})" 
                                                    style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 12px;">
                                                âœ• ì·¨ì†Œ
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="selectNewBuilding(${globalIdx})" 
                                                id="newBuildingBtn_${globalIdx}"
                                                style="flex: 1; padding: 8px; background: var(--warning-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            â• ì‹ ê·œ ë¹Œë”©ìœ¼ë¡œ ë“±ë¡
                                        </button>
                                        <button onclick="selectSkipBuilding(${globalIdx})" 
                                                id="skipBtn_${globalIdx}"
                                                style="padding: 8px 16px; background: var(--bg-tertiary); color: var(--text-secondary); border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            ê±´ë„ˆë›°ê¸°
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('matchReviewModalOverlay').classList.add('show');
        }
        
        // ë§¤ì¹­ ì„ íƒ ì—…ë°ì´íŠ¸
        window.updateMatchSelection = function(idx, value) {
            if (state.matchResults[idx]) {
                state.matchResults[idx].selectedBuildingId = value;
            }
        };
        
        // â˜… v2.2: ë¹Œë”© ê²€ìƒ‰ (noMatch í•­ëª©ìš©)
        window.searchBuildingForMatch = async function(idx) {
            const searchInput = document.getElementById(`searchInput_${idx}`);
            const resultsDiv = document.getElementById(`searchResults_${idx}`);
            const query = searchInput.value.trim();
            
            if (!query) {
                showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted);">ê²€ìƒ‰ ì¤‘...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const buildings = await loadBuildings();
                const results = [];
                const queryLower = query.toLowerCase();
                const queryNormalized = normalizeAddress(query);
                
                for (const [bldgId, bldg] of Object.entries(buildings)) {
                    if (!bldg || typeof bldg !== 'object') continue;
                    
                    const name = (bldg.name || '').toLowerCase();
                    const address = (bldg.address || '').toLowerCase();
                    const addressJibun = (bldg.addressJibun || '').toLowerCase();
                    
                    // ì´ë¦„ ë§¤ì¹­
                    const nameMatch = name.includes(queryLower) || queryLower.includes(name.replace(/ë¹Œë”©|íƒ€ì›Œ|ì„¼í„°/g, ''));
                    
                    // ì£¼ì†Œ ë§¤ì¹­
                    const addrMatch = address.includes(queryLower) || 
                                      addressJibun.includes(queryLower) ||
                                      queryLower.includes(address) ||
                                      stringSimilarity(queryNormalized, bldg.address) > 0.5;
                    
                    if (nameMatch || addrMatch) {
                        // ìœ ì‚¬ë„ ì ìˆ˜ ê³„ì‚°
                        let score = 0;
                        if (name === queryLower) score = 1.0;
                        else if (name.includes(queryLower)) score = 0.8;
                        else if (queryLower.includes(name)) score = 0.7;
                        else if (addrMatch) score = 0.6;
                        else score = 0.5;
                        
                        results.push({
                            buildingId: bldgId,
                            name: bldg.name,
                            address: bldg.address || bldg.addressJibun || '',
                            region: bldg.region || '',
                            score: score
                        });
                    }
                }
                
                // ì ìˆ˜ìˆœ ì •ë ¬
                results.sort((a, b) => b.score - a.score);
                
                // ìƒìœ„ 10ê°œë§Œ
                const topResults = results.slice(0, 10);
                
                if (topResults.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="padding: 16px; text-align: center; color: var(--text-muted);">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ”</div>
                            <div>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                            <div style="font-size: 12px; margin-top: 4px;">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•˜ê±°ë‚˜ "ì‹ ê·œ ë¹Œë”©ìœ¼ë¡œ ë“±ë¡"ì„ ì„ íƒí•˜ì„¸ìš”.</div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = topResults.map(r => `
                        <div class="search-result-item" 
                             onclick="selectBuildingFromSearch(${idx}, '${r.buildingId}', '${escapeHtml(r.name)}', '${escapeHtml(r.address)}')"
                             style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;"
                             onmouseover="this.style.background='var(--accent-light)'" 
                             onmouseout="this.style.background='white'">
                            <div style="font-weight: 500;">${r.name}</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">
                                ${r.address} ${r.region ? `â€¢ ${r.region}` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('ë¹Œë”© ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                resultsDiv.innerHTML = `<div style="padding: 12px; text-align: center; color: var(--danger-color);">ê²€ìƒ‰ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };
        
        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        // â˜… v2.2: ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ë¹Œë”© ì„ íƒ
        window.selectBuildingFromSearch = function(idx, buildingId, buildingName, buildingAddress) {
            // ì„ íƒ ì €ì¥
            state.matchResults[idx].selectedBuildingId = buildingId;
            state.matchResults[idx].selectedBuildingName = buildingName;
            
            // UI ì—…ë°ì´íŠ¸
            const resultsDiv = document.getElementById(`searchResults_${idx}`);
            const selectedDiv = document.getElementById(`selectedBuilding_${idx}`);
            const selectedNameSpan = document.getElementById(`selectedBuildingName_${idx}`);
            const statusBadge = document.getElementById(`matchStatus_${idx}`);
            const newBuildingBtn = document.getElementById(`newBuildingBtn_${idx}`);
            const skipBtn = document.getElementById(`skipBtn_${idx}`);
            const itemDiv = document.querySelector(`.nomatch-item[data-idx="${idx}"]`);
            
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            resultsDiv.style.display = 'none';
            
            // ì„ íƒëœ ë¹Œë”© í‘œì‹œ
            selectedDiv.style.display = 'block';
            selectedNameSpan.textContent = `${buildingName} (${buildingAddress})`;
            
            // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
            statusBadge.textContent = 'âœ“ ë§¤ì¹­ë¨';
            statusBadge.style.background = '#d1fae5';
            statusBadge.style.color = '#059669';
            
            // ë°°ê²½ìƒ‰ ë³€ê²½
            itemDiv.style.background = '#f0fdf4';
            itemDiv.style.borderColor = '#86efac';
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            newBuildingBtn.style.background = 'var(--bg-tertiary)';
            newBuildingBtn.style.color = 'var(--text-muted)';
            skipBtn.style.background = 'var(--bg-tertiary)';
            skipBtn.style.color = 'var(--text-muted)';
            
            showToast(`"${buildingName}"ìœ¼ë¡œ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        };
        
        // â˜… v2.2: ë¹Œë”© ì„ íƒ ì·¨ì†Œ
        window.clearBuildingSelection = function(idx) {
            // ì„ íƒ ì´ˆê¸°í™”
            state.matchResults[idx].selectedBuildingId = null;
            state.matchResults[idx].selectedBuildingName = null;
            
            // UI ë³µì›
            const selectedDiv = document.getElementById(`selectedBuilding_${idx}`);
            const statusBadge = document.getElementById(`matchStatus_${idx}`);
            const newBuildingBtn = document.getElementById(`newBuildingBtn_${idx}`);
            const skipBtn = document.getElementById(`skipBtn_${idx}`);
            const itemDiv = document.querySelector(`.nomatch-item[data-idx="${idx}"]`);
            
            selectedDiv.style.display = 'none';
            
            statusBadge.textContent = 'ë¯¸ë§¤ì¹­';
            statusBadge.style.background = '#fecaca';
            statusBadge.style.color = '#dc2626';
            
            itemDiv.style.background = '#fef2f2';
            itemDiv.style.borderColor = 'var(--border-color)';
            
            newBuildingBtn.style.background = 'var(--warning-color)';
            newBuildingBtn.style.color = 'white';
            skipBtn.style.background = 'var(--bg-tertiary)';
            skipBtn.style.color = 'var(--text-secondary)';
        };
        
        // â˜… v2.2: ì‹ ê·œ ë¹Œë”© ë“±ë¡ ì„ íƒ
        window.selectNewBuilding = function(idx) {
            // ê¸°ì¡´ ì„ íƒ ì·¨ì†Œ
            state.matchResults[idx].selectedBuildingId = '__new__';
            state.matchResults[idx].selectedBuildingName = null;
            
            // UI ì—…ë°ì´íŠ¸
            const resultsDiv = document.getElementById(`searchResults_${idx}`);
            const selectedDiv = document.getElementById(`selectedBuilding_${idx}`);
            const selectedNameSpan = document.getElementById(`selectedBuildingName_${idx}`);
            const statusBadge = document.getElementById(`matchStatus_${idx}`);
            const newBuildingBtn = document.getElementById(`newBuildingBtn_${idx}`);
            const skipBtn = document.getElementById(`skipBtn_${idx}`);
            const itemDiv = document.querySelector(`.nomatch-item[data-idx="${idx}"]`);
            
            resultsDiv.style.display = 'none';
            
            // ì„ íƒ í‘œì‹œ
            selectedDiv.style.display = 'block';
            selectedDiv.style.background = '#fef3c7';
            selectedNameSpan.innerHTML = '<strong style="color: #b45309;">ì‹ ê·œ ë¹Œë”©ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</strong>';
            
            statusBadge.textContent = 'â• ì‹ ê·œ ë“±ë¡';
            statusBadge.style.background = '#fef3c7';
            statusBadge.style.color = '#b45309';
            
            itemDiv.style.background = '#fffbeb';
            itemDiv.style.borderColor = '#fcd34d';
            
            newBuildingBtn.style.background = 'var(--warning-color)';
            newBuildingBtn.style.color = 'white';
            newBuildingBtn.style.outline = '2px solid var(--warning-color)';
            skipBtn.style.background = 'var(--bg-tertiary)';
            skipBtn.style.color = 'var(--text-muted)';
        };
        
        // â˜… v2.2: ê±´ë„ˆë›°ê¸° ì„ íƒ
        window.selectSkipBuilding = function(idx) {
            state.matchResults[idx].selectedBuildingId = '__skip__';
            state.matchResults[idx].selectedBuildingName = null;
            
            // UI ì—…ë°ì´íŠ¸
            const resultsDiv = document.getElementById(`searchResults_${idx}`);
            const selectedDiv = document.getElementById(`selectedBuilding_${idx}`);
            const selectedNameSpan = document.getElementById(`selectedBuildingName_${idx}`);
            const statusBadge = document.getElementById(`matchStatus_${idx}`);
            const newBuildingBtn = document.getElementById(`newBuildingBtn_${idx}`);
            const skipBtn = document.getElementById(`skipBtn_${idx}`);
            const itemDiv = document.querySelector(`.nomatch-item[data-idx="${idx}"]`);
            
            resultsDiv.style.display = 'none';
            
            selectedDiv.style.display = 'block';
            selectedDiv.style.background = 'var(--bg-tertiary)';
            selectedNameSpan.innerHTML = '<span style="color: var(--text-muted);">ì €ì¥í•˜ì§€ ì•Šê³  ê±´ë„ˆëœë‹ˆë‹¤</span>';
            
            statusBadge.textContent = 'â­ï¸ ê±´ë„ˆëœ€';
            statusBadge.style.background = 'var(--bg-tertiary)';
            statusBadge.style.color = 'var(--text-muted)';
            
            itemDiv.style.background = 'var(--bg-secondary)';
            itemDiv.style.borderColor = 'var(--border-color)';
            itemDiv.style.opacity = '0.7';
            
            newBuildingBtn.style.background = 'var(--bg-tertiary)';
            newBuildingBtn.style.color = 'var(--text-muted)';
            newBuildingBtn.style.outline = 'none';
            skipBtn.style.background = 'var(--text-muted)';
            skipBtn.style.color = 'white';
        };
        
        // ë§¤ì¹­ ê²€í†  í™•ì¸ í›„ ì €ì¥
        window.confirmMatchAndSave = async function() {
            // â˜… v2.2: ë¯¸ì²˜ë¦¬ í•­ëª© í™•ì¸
            const noMatchItems = state.matchResults.filter(r => !r.result.auto && !r.result.candidates?.length);
            const unprocessedItems = noMatchItems.filter(r => !r.selectedBuildingId);
            
            if (unprocessedItems.length > 0) {
                const names = unprocessedItems.map(r => r.input?.buildingName || '(ì´ë¦„ì—†ìŒ)').join(', ');
                const proceed = confirm(
                    `âš ï¸ ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì€ í•­ëª©ì´ ${unprocessedItems.length}ê±´ ìˆìŠµë‹ˆë‹¤:\n\n` +
                    `${names}\n\n` +
                    `ì´ í•­ëª©ë“¤ì€ "ì‹ ê·œ ë¹Œë”©ìœ¼ë¡œ ë“±ë¡"ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                );
                
                if (!proceed) {
                    return;
                }
            }
            
            closeModal('matchReviewModalOverlay');
            
            const { company, publishDate, documentId, region } = state.saveContext;
            
            // ì„ íƒëœ ë§¤ì¹­ ì ìš©
            state.matchResults.forEach(r => {
                if (r.selectedBuildingId) {
                    if (r.selectedBuildingId === '__skip__') {
                        r.skip = true;
                    } else if (r.selectedBuildingId === '__new__') {
                        r.createNew = true;
                    } else {
                        r.result.bestMatch = { buildingId: r.selectedBuildingId };
                        r.result.auto = true;
                    }
                } else if (r.result.auto && r.result.bestMatch) {
                    // ìë™ ë§¤ì¹­ ìœ ì§€
                } else if (r.result.candidates?.length > 0) {
                    // ê²€í†  í•„ìš”í•œë° ì„ íƒ ì•ˆ í•¨ â†’ ì²« ë²ˆì§¸ í›„ë³´ ì‚¬ìš©
                    r.result.bestMatch = r.result.candidates[0];
                } else {
                    // â˜… v2.2: í›„ë³´ ì—†ê³  ì„ íƒ ì•ˆ í•¨ â†’ ìë™ìœ¼ë¡œ ì‹ ê·œ ë“±ë¡
                    r.createNew = true;
                    console.log('Auto-create new building:', r.input?.buildingName);
                }
            });
            
            await saveVacanciesToFirebase(state.matchResults, company, publishDate, documentId);
        };
        
        // ì‹¤ì œ Firebase ì €ì¥
        async function saveVacanciesToFirebase(matchResults, company, publishDate, documentId) {
            showToast('Firebaseì— ì €ì¥ ì¤‘...', 'info');
            
            let savedCount = 0;
            let skipCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < matchResults.length; i++) {
                const r = matchResults[i];
                const buildingData = state.extractedData[i];
                
                if (r.skip) {
                    skipCount++;
                    continue;
                }
                
                try {
                    let buildingId;
                    
                    if (r.createNew) {
                        // ì‹ ê·œ ë¹Œë”© ìƒì„±
                        const newBldgRef = db.ref('buildings').push();
                        buildingId = newBldgRef.key;
                        
                        // â˜… v2.2: OCR ì¶”ì¶œ ì •ë³´ ëª¨ë‘ ì €ì¥
                        const newBuildingData = {
                            name: buildingData.buildingName,
                            address: buildingData.addressNormalized || buildingData.address,
                            addressJibun: buildingData.address || '',
                            addressRoad: buildingData.addressRoad || '',
                            region: detectRegion(buildingData.address),
                            createdAt: new Date().toISOString(),
                            createdBy: 'admin',
                            source: 'OCR'
                        };
                        
                        // ì¢Œí‘œ ì •ë³´
                        if (buildingData.coordinates?.lat && buildingData.coordinates?.lng) {
                            newBuildingData.coordinates = buildingData.coordinates;
                        }
                        
                        // ê·œëª¨ ì •ë³´
                        if (buildingData.totalFloors) newBuildingData.totalFloors = buildingData.totalFloors;
                        if (buildingData.basementFloors) newBuildingData.basementFloors = buildingData.basementFloors;
                        if (buildingData.grossFloorArea) newBuildingData.grossFloorArea = buildingData.grossFloorArea;
                        
                        // ê¸°ì¤€ì¸µ/ì „ìš©ë¥  ì •ë³´
                        if (buildingData.typicalFloorArea) newBuildingData.typicalFloorArea = buildingData.typicalFloorArea;
                        if (buildingData.exclusiveRate) newBuildingData.exclusiveRate = buildingData.exclusiveRate;
                        
                        // ì¤€ê³µì—°ë„
                        if (buildingData.completionYear) newBuildingData.completionYear = buildingData.completionYear;
                        
                        // êµí†µí¸
                        if (buildingData.nearbyStation) newBuildingData.nearbyStation = buildingData.nearbyStation;
                        
                        // ë‹´ë‹¹ì ì •ë³´
                        if (buildingData.contactInfo) newBuildingData.contactInfo = buildingData.contactInfo;
                        
                        await newBldgRef.set(newBuildingData);
                        
                        console.log('ì‹ ê·œ ë¹Œë”© ìƒì„±:', buildingId, buildingData.buildingName, newBuildingData);
                    } else if (r.result.bestMatch) {
                        buildingId = r.result.bestMatch.buildingId;
                    } else {
                        skipCount++;
                        continue;
                    }
                    
                    // ê³µì‹¤ ì •ë³´ ì €ì¥
                    const vacancies = buildingData.vacancies || [];
                    const vacancySource = buildingData.sourceCompany || company || '';
                    const vacancyPublishDate = buildingData.publishDate || publishDate || '';
                    
                    for (const vacancy of vacancies) {
                        const floor = (vacancy.floor || 'UNK').replace(/[\/\s]/g, '_');
                        const vacancyId = `${vacancySource}_${vacancyPublishDate.replace('.', '_')}_${floor}`;
                        
                        const vacancyData = {
                            floor: vacancy.floor,
                            rentArea: vacancy.rentArea || vacancy.area || null,
                            exclusiveArea: vacancy.exclusiveArea || null,
                            depositPy: vacancy.depositPy || vacancy.deposit || null,
                            rentPy: vacancy.rentPy || vacancy.rent || null,
                            maintenancePy: vacancy.maintenancePy || vacancy.maintenance || null,
                            moveInDate: vacancy.moveInDate || null,
                            source: vacancySource,
                            publishDate: vacancyPublishDate,
                            pageNum: buildingData.pageNum || null,
                            pageImageUrl: buildingData.pageImageUrl || null,
                            documentId: documentId,
                            buildingName: buildingData.buildingName,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        // â˜… ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²½ë¡œ ë³€ê²½: vacancies/{buildingId}/{vacancyId}
                        await db.ref(`vacancies/${buildingId}/${vacancyId}`).set(vacancyData);
                    }
                    
                    // â˜… v9.5: ê³µì‹¤ ë©”íƒ€ ì •ë³´ ì €ì¥ (ê³µì‹¤ì—†ìŒ/ë§Œì‹¤ êµ¬ë¶„ìš©)
                    const metaId = `${vacancySource}_${vacancyPublishDate.replace('.', '_')}_meta`;
                    const metaData = {
                        source: vacancySource,
                        publishDate: vacancyPublishDate,
                        pageNum: buildingData.pageNum || null,
                        pageImageUrl: buildingData.pageImageUrl || null,
                        documentId: documentId,
                        buildingName: buildingData.buildingName,
                        noVacancy: vacancies.length === 0,  // â˜… ê³µì‹¤ì—†ìŒ(ë§Œì‹¤) í”Œë˜ê·¸
                        vacancyCount: vacancies.length,
                        updatedAt: new Date().toISOString()
                    };
                    await db.ref(`vacancies/${buildingId}/${metaId}`).set(metaData);
                    
                    // â˜… v9.4: vacanciesì—ì„œ ê¸°ì¤€ê°€(floorPricing) ìë™ ìƒì„±
                    await generateFloorPricingFromVacancies(buildingId, buildingData, company, publishDate);
                    
                    savedCount++;
                    
                    // ì§„í–‰ë¥  í‘œì‹œ
                    if ((i + 1) % 10 === 0) {
                        showToast(`ì €ì¥ ì§„í–‰ ì¤‘... ${i + 1}/${matchResults.length}`, 'info');
                    }
                    
                } catch (error) {
                    console.error('ì €ì¥ ì˜¤ë¥˜:', buildingData.buildingName, error);
                    errorCount++;
                }
            }
            
            showToast(`ì €ì¥ ì™„ë£Œ! ì„±ê³µ ${savedCount}ê±´, ê±´ë„ˆëœ€ ${skipCount}ê±´, ì˜¤ë¥˜ ${errorCount}ê±´`, 'success');
            
            // ì™„ë£Œ í›„ ì²˜ë¦¬
            if (confirm(`ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì„±ê³µ: ${savedCount}ê±´\nê±´ë„ˆëœ€: ${skipCount}ê±´\nì˜¤ë¥˜: ${errorCount}ê±´\n\nì‚¬ìš©ì í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                window.open('portal.html', '_blank');
            }
        }
        
        // â˜… v9.5: vacancies + basePricingì—ì„œ ê¸°ì¤€ê°€(floorPricing) ìë™ ìƒì„±
        async function generateFloorPricingFromVacancies(buildingId, buildingData, company, publishDate) {
            try {
                const vacancies = buildingData.vacancies || [];
                const basePricing = buildingData.basePricing || null;
                const source = buildingData.sourceCompany || company || '';
                const pubDate = buildingData.publishDate || publishDate || '';
                
                let newPricings = [];
                
                // â˜… Case 1: basePricingì´ ìˆëŠ” ê²½ìš° (ê³µì‹¤ì—†ìŒì´ì–´ë„ ê¸°ì¤€ê°€ ì €ì¥)
                if (basePricing) {
                    if (basePricing.isSingle && basePricing.single) {
                        // ë‹¨ì¼ ê¸°ì¤€ê°€
                        const single = basePricing.single;
                        const depositPy = parseFloat(String(single.depositPy || 0).replace(/,/g, '')) || 0;
                        const rentPy = parseFloat(String(single.rentPy || 0).replace(/,/g, '')) || 0;
                        const maintenancePy = parseFloat(String(single.maintenancePy || 0).replace(/,/g, '')) || 0;
                        
                        if (rentPy > 0 || depositPy > 0) {
                            newPricings.push({
                                id: `fp_ocr_${Date.now()}_base`,
                                label: 'ê¸°ì¤€ê°€',
                                floorRange: 'ì „ì²´',
                                depositPy: depositPy,
                                rentPy: rentPy,
                                maintenancePy: maintenancePy,
                                effectiveDate: pubDate.includes('.') ? `20${pubDate.replace('.', '-')}-01` : pubDate,
                                sourceType: 'ocr_basePricing',
                                sourceCompany: source,
                                notes: `${source} ì„ëŒ€ì•ˆë‚´ë¬¸ ê¸°ì¤€ê°€ì—ì„œ ì¶”ì¶œ`,
                                createdAt: new Date().toISOString()
                            });
                        }
                    } else if (basePricing.multiple && basePricing.multiple.length > 0) {
                        // ë³µìˆ˜ ê¸°ì¤€ê°€ (ê³ ì¸µ/ì €ì¸µ ë“±)
                        basePricing.multiple.forEach((mp, idx) => {
                            const depositPy = parseFloat(String(mp.depositPy || 0).replace(/,/g, '')) || 0;
                            const rentPy = parseFloat(String(mp.rentPy || 0).replace(/,/g, '')) || 0;
                            const maintenancePy = parseFloat(String(mp.maintenancePy || 0).replace(/,/g, '')) || 0;
                            
                            if (rentPy > 0 || depositPy > 0) {
                                newPricings.push({
                                    id: `fp_ocr_${Date.now()}_${idx}`,
                                    label: mp.label || `êµ¬ê°„${idx + 1}`,
                                    floorRange: mp.floorRange || 'ì „ì²´',
                                    depositPy: depositPy,
                                    rentPy: rentPy,
                                    maintenancePy: maintenancePy,
                                    effectiveDate: pubDate.includes('.') ? `20${pubDate.replace('.', '-')}-01` : pubDate,
                                    sourceType: 'ocr_basePricing',
                                    sourceCompany: source,
                                    notes: `${source} ì„ëŒ€ì•ˆë‚´ë¬¸ ê¸°ì¤€ê°€ì—ì„œ ì¶”ì¶œ`,
                                    createdAt: new Date().toISOString()
                                });
                            }
                        });
                    }
                }
                
                // â˜… Case 2: basePricingì´ ì—†ê³  vacanciesì—ì„œ ê°€ê²© ì¶”ì¶œ
                if (newPricings.length === 0 && vacancies.length > 0) {
                    // ê°€ê²©ì´ ìˆëŠ” ê³µì‹¤ë§Œ í•„í„°
                    const vacanciesWithPrice = vacancies.filter(v => v.rentPy || v.depositPy);
                    
                    if (vacanciesWithPrice.length > 0) {
                        // ê³ ìœ í•œ ê°€ê²© ì¡°í•© ì¶”ì¶œ (depositPy + rentPy + maintenancePy)
                        const priceMap = {};
                        vacanciesWithPrice.forEach(v => {
                            const key = `${v.depositPy || 0}_${v.rentPy || 0}_${v.maintenancePy || 0}`;
                            if (!priceMap[key]) {
                                priceMap[key] = {
                                    depositPy: parseFloat(String(v.depositPy || 0).replace(/,/g, '')) || 0,
                                    rentPy: parseFloat(String(v.rentPy || 0).replace(/,/g, '')) || 0,
                                    maintenancePy: parseFloat(String(v.maintenancePy || 0).replace(/,/g, '')) || 0,
                                    floors: []
                                };
                            }
                            priceMap[key].floors.push(v.floor);
                        });
                        
                        // floorPricing ë°°ì—´ ìƒì„±
                        const pricingList = Object.values(priceMap);
                        newPricings = pricingList.map((p, idx) => {
                            // ì¸µ ë²”ìœ„ ë¼ë²¨ ìƒì„±
                            const floors = p.floors.sort((a, b) => {
                                const numA = parseInt(a) || 0;
                                const numB = parseInt(b) || 0;
                                return numA - numB;
                            });
                            
                            let label = 'ê¸°ì¤€ê°€';
                            let floorRange = 'ì „ì²´';
                            
                            if (floors.length === 1) {
                                label = floors[0];
                                floorRange = floors[0];
                            } else if (floors.length > 1) {
                                const first = floors[0];
                                const last = floors[floors.length - 1];
                                label = `${first}~${last}`;
                                floorRange = `${first}~${last}`;
                            }
                            
                            // ë³µìˆ˜ ê°€ê²© ì¡°í•©ì¼ ë•Œ êµ¬ë¶„
                            if (pricingList.length > 1) {
                                if (idx === 0) label = `ì €ì¸µë¶€ (${label})`;
                                else if (idx === pricingList.length - 1) label = `ê³ ì¸µë¶€ (${label})`;
                                else label = `ì¤‘ì¸µë¶€ (${label})`;
                            }
                            
                            return {
                                id: `fp_ocr_${Date.now()}_${idx}`,
                                label: label,
                                floorRange: floorRange,
                                depositPy: p.depositPy,
                                rentPy: p.rentPy,
                                maintenancePy: p.maintenancePy,
                                effectiveDate: pubDate.includes('.') ? `20${pubDate.replace('.', '-')}-01` : pubDate,
                                sourceType: 'ocr',
                                sourceCompany: source,
                                notes: `${source} ì„ëŒ€ì•ˆë‚´ë¬¸ì—ì„œ ì¶”ì¶œ`,
                                createdAt: new Date().toISOString()
                            };
                        });
                    }
                }
                
                if (newPricings.length === 0) return;
                
                // ê¸°ì¡´ floorPricing ì¡°íšŒ
                const existingRef = await db.ref(`buildings/${buildingId}/floorPricing`).once('value');
                let existingPricing = existingRef.val() || [];
                if (!Array.isArray(existingPricing)) existingPricing = [];
                
                // ë™ì¼ ì¶œì²˜+ì›”ì˜ ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸°
                const effectiveMonth = newPricings[0].effectiveDate?.slice(0, 7) || '';
                existingPricing = existingPricing.filter(ep => {
                    const epMonth = (ep.effectiveDate || '').slice(0, 7);
                    const epSource = ep.sourceCompany || '';
                    // ê°™ì€ ì›” + ê°™ì€ ì¶œì²˜ë©´ ì œê±° (ìƒˆ ë°ì´í„°ë¡œ ëŒ€ì²´)
                    return !(epMonth === effectiveMonth && epSource === source);
                });
                
                // ìƒˆ ê¸°ì¤€ê°€ ì¶”ê°€
                const mergedPricing = [...existingPricing, ...newPricings];
                
                // ì €ì¥
                await db.ref(`buildings/${buildingId}/floorPricing`).set(mergedPricing);
                
                console.log(`âœ… ${buildingData.buildingName}: floorPricing ${newPricings.length}ê°œ ì €ì¥ (ì´ ${mergedPricing.length}ê°œ)`);
                
            } catch (error) {
                console.error('floorPricing ìƒì„± ì˜¤ë¥˜:', buildingData.buildingName, error);
            }
        }
        
        // ê¶Œì—­ ìë™ ê°ì§€
        function detectRegion(address) {
            if (!address) return 'ETC';
            
            const cbd = ['ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì„ì§€ë¡œ', 'ì„¸ì¢…ëŒ€ë¡œ', 'íƒœí‰ë¡œ', 'ëª…ë™'];
            const gbd = ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'í…Œí—¤ë€', 'ê°•ë‚¨ëŒ€ë¡œ', 'ì‚¼ì„±ë™', 'ì—­ì‚¼'];
            const ybd = ['ì˜ë“±í¬êµ¬', 'ì—¬ì˜ë„', 'ë§ˆí¬êµ¬', 'ê³µë•'];
            const etc = ['ë¶„ë‹¹', 'íŒêµ', 'ì†¡ë„', 'ë§ˆê³¡'];
            
            if (cbd.some(k => address.includes(k))) return 'CBD';
            if (gbd.some(k => address.includes(k))) return 'GBD';
            if (ybd.some(k => address.includes(k))) return 'YBD';
            if (etc.some(k => address.includes(k))) return 'ETC';
            
            return 'ETC';
        }
        
        // ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
        }
        
        // ëª¨ë‹¬
        function showAddSourceModal() {
            document.getElementById('addSourceModal').classList.add('show');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        // â˜… v2.1: íšŒì‚¬ëª… ë“±ë¡ ìˆ˜ì • (Firebase ì €ì¥ ì¶”ê°€)
        async function addNewSource() {
            const name = document.getElementById('newSourceName').value.trim();
            const alias = document.getElementById('newSourceAlias').value.trim();
            const logo = document.getElementById('newSourceLogo').value.trim();
            
            if (!name) {
                showToast('íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            // ì¤‘ë³µ ì²´í¬
            const exists = state.sourceCompanies.some(c => 
                c.id === name || c.name === name || c.name.toLowerCase() === name.toLowerCase()
            );
            
            if (exists) {
                showToast('ì´ë¯¸ ë“±ë¡ëœ íšŒì‚¬ëª…ì…ë‹ˆë‹¤', 'warning');
                return;
            }
            
            try {
                // Firebaseì— ì €ì¥
                const companyData = {
                    name: name,
                    aliases: alias ? alias.split(',').map(a => a.trim()) : [],
                    logo: logo || 'ğŸ¢',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.email || 'admin'
                };
                
                await db.ref(`sourceCompanies/${name}`).set(companyData);
                
                // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                state.sourceCompanies.push({
                    id: name,
                    name: name,
                    aliases: companyData.aliases,
                    fromFirebase: true
                });
                
                // Select ê°±ì‹ 
                updateSourceCompanySelect();
                
                // ê°’ ì„¤ì •
                document.getElementById('sourceCompany').value = name;
                
                // ì»¤ìŠ¤í…€ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
                document.getElementById('sourceCompanyCustom').style.display = 'none';
                
                // Step1 ìƒíƒœ ì—…ë°ì´íŠ¸
                updateStep1Status();
                
                closeModal('addSourceModal');
                document.getElementById('newSourceName').value = '';
                document.getElementById('newSourceAlias').value = '';
                document.getElementById('newSourceLogo').value = '';
                
                showToast(`${name} íšŒì‚¬ê°€ Firebaseì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                
            } catch (error) {
                console.error('íšŒì‚¬ ë“±ë¡ ì‹¤íŒ¨:', error);
                showToast('ë“±ë¡ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // â˜… v2.1: ì‹¤íŒ¨ í˜ì´ì§€ ëª¨ë‹¬ í‘œì‹œ
        function showFailedPagesModal() {
            const container = document.getElementById('failedPagesList');
            container.innerHTML = '';
            
            state.failedPages.forEach((item, idx) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;';
                div.innerHTML = `
                    <span style="font-weight: 600; color: #dc2626;">í˜ì´ì§€ ${item.pageNum}</span>
                    <span style="flex: 1; color: #991b1b; font-size: 13px;">${item.error}</span>
                    <button class="btn btn-sm" style="background: #f59e0b; color: white; padding: 4px 12px;" onclick="retrySinglePage(${item.pageNum})">ì¬ì‹œë„</button>
                    <button class="btn btn-sm" style="background: var(--accent-color); color: white; padding: 4px 12px;" onclick="manualInputPage(${item.pageNum})">ì§ì ‘ì…ë ¥</button>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('failedPagesModal').classList.add('show');
        }
        
        // â˜… v2.1: ì‹¤íŒ¨ í˜ì´ì§€ ê±´ë„ˆë›°ê¸°
        function skipFailedPages() {
            closeModal('failedPagesModal');
            state.failedPages = [];
            showToast('ì‹¤íŒ¨ í˜ì´ì§€ë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤', 'info');
        }
        
        // â˜… v2.1: ì „ì²´ ì¬ì‹œë„
        async function retryFailedPages() {
            if (state.failedPages.length === 0) {
                showToast('ì¬ì‹œë„í•  í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            closeModal('failedPagesModal');
            
            const pagesToRetry = state.failedPages.map(p => p.pageNum);
            state.failedPages = [];
            
            showToast(`${pagesToRetry.length}ê°œ í˜ì´ì§€ ì¬ì‹œë„ ì¤‘...`, 'info');
            
            for (const pageNum of pagesToRetry) {
                try {
                    addLog(pageNum, `í˜ì´ì§€ ${pageNum} ì¬ì‹œë„...`);
                    const result = await processPage(pageNum);
                    
                    if (result && result.buildingName) {
                        state.extractedData.push(result);
                        addLog(pageNum, `âœ“ ${result.buildingName} - ê³µì‹¤ ${result.vacancies?.length || 0}ê±´`, 'success');
                    } else {
                        state.failedPages.push({ pageNum, error: 'ë°ì´í„° ì—†ìŒ' });
                        addLog(pageNum, 'ì¬ì‹œë„ ì‹¤íŒ¨: ë°ì´í„° ì—†ìŒ', 'error');
                    }
                } catch (error) {
                    state.failedPages.push({ pageNum, error: error.message });
                    addLog(pageNum, `ì¬ì‹œë„ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
            
            // ì—¬ì „íˆ ì‹¤íŒ¨í•œ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ëª¨ë‹¬ í‘œì‹œ
            if (state.failedPages.length > 0) {
                showFailedPagesModal();
            } else {
                showToast('ëª¨ë“  í˜ì´ì§€ ì²˜ë¦¬ ì™„ë£Œ!', 'success');
            }
        }
        
        // â˜… v2.1: ë‹¨ì¼ í˜ì´ì§€ ì¬ì‹œë„
        async function retrySinglePage(pageNum) {
            try {
                addLog(pageNum, `í˜ì´ì§€ ${pageNum} ì¬ì‹œë„...`);
                const result = await processPage(pageNum);
                
                if (result && result.buildingName) {
                    state.extractedData.push(result);
                    // ì‹¤íŒ¨ ëª©ë¡ì—ì„œ ì œê±°
                    state.failedPages = state.failedPages.filter(p => p.pageNum !== pageNum);
                    addLog(pageNum, `âœ“ ${result.buildingName} - ê³µì‹¤ ${result.vacancies?.length || 0}ê±´`, 'success');
                    showToast(`í˜ì´ì§€ ${pageNum} ì²˜ë¦¬ ì™„ë£Œ!`, 'success');
                    
                    // ëª¨ë‹¬ ê°±ì‹ 
                    if (state.failedPages.length > 0) {
                        showFailedPagesModal();
                    } else {
                        closeModal('failedPagesModal');
                    }
                } else {
                    showToast('ë°ì´í„°ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                showToast(`ì¬ì‹œë„ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // â˜… v2.1: ì§ì ‘ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸° (ì „ì²´)
        function openManualInputModal() {
            if (state.failedPages.length === 0) {
                showToast('ì…ë ¥í•  í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            closeModal('failedPagesModal');
            manualInputPage(state.failedPages[0].pageNum);
        }
        
        // â˜… v2.1: íŠ¹ì • í˜ì´ì§€ ì§ì ‘ ì…ë ¥
        function manualInputPage(pageNum) {
            document.getElementById('manualPageNum').value = pageNum;
            document.getElementById('manualBuildingName').value = '';
            document.getElementById('manualAddress').value = '';
            document.getElementById('manualVacancies').value = '';
            
            closeModal('failedPagesModal');
            document.getElementById('manualInputModal').classList.add('show');
        }
        
        // â˜… v2.1: ì§ì ‘ ì…ë ¥ ì €ì¥
        function saveManualInput() {
            const pageNum = parseInt(document.getElementById('manualPageNum').value);
            const buildingName = document.getElementById('manualBuildingName').value.trim();
            const address = document.getElementById('manualAddress').value.trim();
            const vacanciesText = document.getElementById('manualVacancies').value.trim();
            
            if (!buildingName) {
                showToast('ë¹Œë”©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            // ê³µì‹¤ ì •ë³´ íŒŒì‹±
            const vacancies = [];
            if (vacanciesText) {
                const lines = vacanciesText.split('\n').filter(l => l.trim());
                lines.forEach(line => {
                    const parts = line.split(',').map(p => p.trim());
                    vacancies.push({
                        floor: parts[0] || '',
                        area: parts[1] || '',
                        exclusiveRate: parts[2] || '',
                        note: parts.slice(3).join(', ')
                    });
                });
            }
            
            // ë°ì´í„° ì¶”ê°€
            state.extractedData.push({
                pageNum,
                buildingName,
                address,
                vacancies,
                source: 'manual'
            });
            
            // ì‹¤íŒ¨ ëª©ë¡ì—ì„œ ì œê±°
            state.failedPages = state.failedPages.filter(p => p.pageNum !== pageNum);
            
            addLog(pageNum, `âœ“ ${buildingName} (ì§ì ‘ì…ë ¥) - ê³µì‹¤ ${vacancies.length}ê±´`, 'success');
            
            closeModal('manualInputModal');
            
            // ë‹¤ìŒ ì‹¤íŒ¨ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ê³„ì†
            if (state.failedPages.length > 0) {
                showToast(`ì €ì¥ ì™„ë£Œ. ë‚¨ì€ ${state.failedPages.length}ê°œ í˜ì´ì§€`, 'success');
                showFailedPagesModal();
            } else {
                showToast('ëª¨ë“  í˜ì´ì§€ ì²˜ë¦¬ ì™„ë£Œ!', 'success');
            }
        }
        
        // â˜… v2.1: ì„ íƒëœ íšŒì‚¬ëª… ê°€ì ¸ì˜¤ê¸° (other ì„ íƒ ì‹œ customInput ì‚¬ìš©)
        function getSelectedCompany() {
            const select = document.getElementById('sourceCompany');
            const customInput = document.getElementById('sourceCompanyCustom');
            
            if (select.value === 'other') {
                return customInput.value.trim() || '';
            }
            return select.value || '';
        }
        
        // í† ìŠ¤íŠ¸
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ìƒ˜í”Œ JSON ë‹¤ìš´ë¡œë“œ
        function downloadSampleJson() {
            const sampleData = {
                meta: {
                    source: "CBRE",
                    publishDate: "25.01",
                    region: "ALL",
                    extractedAt: new Date().toISOString(),
                    buildingCount: 2,
                    vacancyCount: 3
                },
                extractedData: [
                    {
                        pageNum: 1,
                        buildingName: "ê·¸ë‘ì„œìš¸",
                        address: "ì„œìš¸ ì¢…ë¡œêµ¬ ì¢…ë¡œ 33",
                        vacancies: [
                            {
                                floor: "15F",
                                exclusiveArea: 300,
                                rentArea: 500,
                                depositPy: "1,200",
                                rentPy: "120",
                                maintenancePy: "35",
                                moveInDate: "ì¦‰ì‹œ"
                            },
                            {
                                floor: "16F",
                                exclusiveArea: 280,
                                rentArea: 470,
                                depositPy: "1,200",
                                rentPy: "120",
                                maintenancePy: "35",
                                moveInDate: "í˜‘ì˜"
                            }
                        ]
                    },
                    {
                        pageNum: 2,
                        buildingName: "ì„¼í„°ì›ë¹Œë”© East",
                        address: "ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ5ê¸¸ 26",
                        vacancies: [
                            {
                                floor: "20F",
                                exclusiveArea: 450,
                                rentArea: 750,
                                depositPy: "1,500",
                                rentPy: "135",
                                maintenancePy: "40",
                                moveInDate: "25ë…„ 3ì›”"
                            }
                        ]
                    }
                ]
            };
            
            const dataStr = JSON.stringify(sampleData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì„ëŒ€ì•ˆë‚´ë¬¸_ìƒ˜í”Œ_ì–‘ì‹.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ìƒ˜í”Œ JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ì–‘ì‹ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.', 'success');
        }
        
        // JSON ë‹¤ìš´ë¡œë“œ
        function exportToExcel() {
            if (!state.extractedData || state.extractedData.length === 0) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            // â˜… v2.1: íšŒì‚¬ëª… ê°€ì ¸ì˜¤ê¸° ìˆ˜ì •
            const company = getSelectedCompany() || 'UNKNOWN';
            const year = document.getElementById('publishYear').value || '2025';
            const month = document.getElementById('publishMonth').value || '01';
            const basePublishDate = `${year.slice(2)}.${month}`;
            // â˜… v2.2: ë²„ì „ì´ ì ìš©ëœ publishDate ì‚¬ìš©
            const publishDate = state.currentPublishDate || basePublishDate;
            const region = document.querySelector('.region-chip.selected')?.dataset.region || 'ALL';
            
            // ë©”íƒ€ë°ì´í„° í¬í•¨ JSON ìƒì„±
            const jsonPayload = {
                meta: {
                    source: company,
                    publishDate: publishDate,
                    region: region,
                    extractedAt: new Date().toISOString(),
                    buildingCount: state.extractedData.length,
                    vacancyCount: state.extractedData.reduce((sum, b) => sum + (b.vacancies?.length || 0), 0)
                },
                extractedData: state.extractedData
            };
            
            // JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const dataStr = JSON.stringify(jsonPayload, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì„ëŒ€ì•ˆë‚´ë¬¸_${company}_${publishDate.replace('.', '_')}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
        }
        
        // JSON ì—…ë¡œë“œ
        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('íŒŒì¼ ì½ëŠ” ì¤‘...', 'info');
            
            try {
                const fileName = file.name.toLowerCase();
                
                if (!fileName.endsWith('.json')) {
                    throw new Error('JSON íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤ (.json)');
                }
                
                // JSON íŒŒì¼ ë¡œë“œ
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (Array.isArray(data)) {
                    // êµ¬ë²„ì „: ë°°ì—´ë§Œ ìˆëŠ” ê²½ìš°
                    state.extractedData = data;
                } else if (data.extractedData) {
                    // ì‹ ë²„ì „: ë©”íƒ€ë°ì´í„° í¬í•¨
                    state.extractedData = data.extractedData;
                    
                    // ë©”íƒ€ë°ì´í„°ë¡œ UI ì„¤ì •
                    if (data.meta) {
                        if (data.meta.source) {
                            document.getElementById('sourceCompany').value = data.meta.source;
                        }
                        if (data.meta.publishDate) {
                            const parts = data.meta.publishDate.split('.');
                            if (parts.length === 2) {
                                document.getElementById('publishYear').value = '20' + parts[0];
                                document.getElementById('publishMonth').value = parts[1];
                            }
                        }
                    }
                } else {
                    throw new Error('ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
                }
                
                // UI ì—…ë°ì´íŠ¸
                const totalVacancies = state.extractedData.reduce((sum, b) => sum + (b.vacancies?.length || 0), 0);
                
                document.getElementById('resultBuildingCount').textContent = state.extractedData.length;
                document.getElementById('resultVacancyCount').textContent = totalVacancies;
                
                // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
                renderResultTable();
                
                // Step 4ë¡œ ì´ë™
                state.currentStep = 4;
                goToStep(4);
                
                showToast(`íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${state.extractedData.length}ê°œ ë¹Œë”©, ${totalVacancies}ê±´ ê³µì‹¤`, 'success');
                
                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                event.target.value = '';
                
            } catch (error) {
                console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                event.target.value = '';
            }
        }
        
        function cancelAll() {
            if (confirm('ëª¨ë“  ì‘ì—…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.reload();
            }
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™” (ë‹¤ë¥¸ íŒŒì¼ ì„ íƒ)
        function resetFileUpload(e) {
            if (e) e.stopPropagation();
            
            const uploadZone = document.getElementById('fileUploadZone');
            uploadZone.innerHTML = `
                <div class="icon" id="uploadIcon">ğŸ“</div>
                <div class="text" id="uploadText">í´ë¦­í•˜ì—¬ PDF íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜<br>ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                <div class="loading-indicator" id="uploadLoading" style="display:none;">
                    <div class="spinner"></div>
                    <div class="loading-text">PDF ë¡œë”© ì¤‘... <span id="uploadProgress">0</span>%</div>
                </div>
                <input type="file" id="pdfFile" accept=".pdf" style="display:none;">
            `;
            uploadZone.classList.remove('has-file');
            uploadZone.style.pointerEvents = 'auto';
            uploadZone.onclick = () => document.getElementById('pdfFile').click();
            
            // íŒŒì¼ input ì´ë²¤íŠ¸ ë‹¤ì‹œ ì—°ê²°
            document.getElementById('pdfFile').addEventListener('change', handleFileSelect);
            
            // ìƒíƒœ ì´ˆê¸°í™”
            state.pdfDoc = null;
            state.pdfFile = null;
            state.totalPages = 0;
            state.selectedPages.clear();
            state.pageTypes = {};
        }
        
        // ìƒˆ PDF ì¶”ì¶œ ì‹œì‘
        function startNewExtraction() {
            if (confirm('ìƒˆë¡œìš´ PDFë¥¼ ì¶”ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì‘ì—… ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                // ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”
                state.pdfDoc = null;
                state.pdfFile = null;
                state.totalPages = 0;
                state.selectedPages.clear();
                state.pageTypes = {};
                state.extractedData = [];
                state.isProcessing = false;
                
                // UI ì´ˆê¸°í™”
                resetFileUpload();
                document.getElementById('thumbnailGrid').innerHTML = '';
                document.getElementById('realtimeLog').innerHTML = '';
                document.getElementById('resultTableBody').innerHTML = '';
                
                // Step 1ë¡œ ì´ë™
                goToStep(1);
                showToast('ìƒˆ PDFë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'info');
            }
        }
        
        // ì¸ë„¤ì¼ ë¡œë”© í‘œì‹œ
        function showThumbnailLoading(show) {
            const grid = document.getElementById('thumbnailGrid');
            
            if (show) {
                grid.innerHTML = `
                    <div class="thumbnail-loading">
                        <div class="spinner"></div>
                        <div>ì¸ë„¤ì¼ ìƒì„± ì¤‘...</div>
                        <div class="progress-text" id="thumbnailProgress">0 / ${state.totalPages} í˜ì´ì§€</div>
                    </div>
                `;
            }
        }
        
        // ì¸ë„¤ì¼ ìƒì„± ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateThumbnailProgress(current, total) {
            const progressEl = document.getElementById('thumbnailProgress');
            if (progressEl) {
                progressEl.textContent = `${current} / ${total} í˜ì´ì§€`;
            }
        }

    </script>
</body>
</html>
