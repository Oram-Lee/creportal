<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE PORTAL ‚Äî Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================================
           CSS Variables (portal.css Ìò∏Ìôò)
           ============================================================ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: #eff6ff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --accent-light: #1e3a5f;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.4);
        }

        /* ============================================================
           Base
           ============================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ============================================================
           Login Screen
           ============================================================ */
        .login-container {
            position: fixed; inset: 0;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%);
            z-index: 9999;
        }
        .login-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 40px;
            width: 400px;
            box-shadow: var(--shadow-lg);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo .icon { font-size: 48px; margin-bottom: 12px; }
        .login-logo h1 {
            font-size: 24px; font-weight: 700;
            letter-spacing: -0.5px;
        }
        .login-logo p {
            color: var(--text-muted); font-size: 14px; margin-top: 4px;
        }
        .login-logo .admin-badge {
            display: inline-block;
            background: var(--error-color);
            color: #fff;
            font-size: 11px; font-weight: 600;
            padding: 2px 10px;
            border-radius: 20px;
            margin-top: 8px;
            letter-spacing: 1px;
        }
        .login-error {
            background: #fef2f2;
            color: var(--error-color);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }
        .login-error.show { display: block; }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 13px; font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        /* ============================================================
           Buttons
           ============================================================ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px; font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: var(--accent-color);
            color: #fff;
            width: 100%;
            justify-content: center;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover { filter: brightness(0.9); }
        .btn-danger { background: var(--error-color); color: #fff; }
        .btn-danger:hover { filter: brightness(0.9); }
        .btn-warning { background: var(--warning-color); color: #fff; }
        .btn-warning:hover { filter: brightness(0.9); }
        .btn-sm { padding: 6px 14px; font-size: 13px; }
        .btn-icon {
            width: 32px; height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background: transparent;
            border: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            transition: all 0.15s;
        }
        .btn-icon:hover { background: var(--bg-hover); }

        /* ============================================================
           Header
           ============================================================ */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        .header-left {
            display: flex; align-items: center; gap: 20px;
        }
        .header-logo {
            font-size: 18px; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
            letter-spacing: -0.5px;
        }
        .header-logo .icon { font-size: 22px; }
        .header-nav {
            display: flex; gap: 2px;
        }
        .nav-item {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px; font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            display: flex; align-items: center; gap: 4px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent-color);
        }
        .header-right {
            display: flex; align-items: center; gap: 12px;
        }
        .user-info {
            display: flex; flex-direction: column; align-items: flex-end;
            font-size: 12px; line-height: 1.3;
        }
        .user-email { font-weight: 600; color: var(--text-primary); }
        .user-role {
            color: var(--accent-color); font-weight: 500;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .logout-btn {
            padding: 6px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px; font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }
        .logout-btn:hover { background: #fef2f2; color: var(--error-color); border-color: var(--error-color); }
        .theme-btn {
            width: 36px; height: 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .theme-btn:hover { background: var(--bg-hover); }

        /* ============================================================
           Main Content
           ============================================================ */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 28px 24px;
        }

        /* ============================================================
           Stats Cards
           ============================================================ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-sm);
        }
        .stat-icon {
            width: 48px; height: 48px;
            border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
        }
        .stat-icon.blue { background: #eff6ff; }
        .stat-icon.green { background: #ecfdf5; }
        .stat-icon.amber { background: #fffbeb; }
        .stat-icon.red { background: #fef2f2; }
        .stat-icon.purple { background: #faf5ff; }
        .stat-value { font-size: 28px; font-weight: 700; line-height: 1; }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

        /* ============================================================
           Table Card
           ============================================================ */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        .table-header {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }
        .table-header h2 {
            font-size: 18px; font-weight: 600;
        }
        .table-actions {
            display: flex; gap: 8px; align-items: center;
        }
        .search-input {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            width: 240px;
        }
        .search-input:focus { outline: none; border-color: var(--accent-color); }

        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead th {
            padding: 12px 16px;
            font-size: 12px; font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            text-align: left;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        tbody td {
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        tbody tr:hover { background: var(--bg-hover); }
        tbody tr:last-child td { border-bottom: none; }

        /* ============================================================
           Badges
           ============================================================ */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px; font-weight: 600;
            letter-spacing: 0.3px;
        }
        .badge-admin { background: #fef2f2; color: #dc2626; }
        .badge-superadmin { background: #faf5ff; color: #7c3aed; }
        .badge-manager { background: #eff6ff; color: #2563eb; }
        .badge-user { background: #ecfdf5; color: #059669; }
        .badge-viewer { background: #f8fafc; color: #64748b; }
        .badge-active { background: #ecfdf5; color: #059669; }
        .badge-disabled { background: #fef2f2; color: #dc2626; }
        .badge-pending { background: #fffbeb; color: #d97706; }

        /* ============================================================
           Modal
           ============================================================ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 32px;
            width: 520px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.2s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-title {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px;
        }
        .modal-title h3 { font-size: 20px; font-weight: 600; }
        .modal-close {
            width: 32px; height: 32px;
            border: none; background: transparent;
            font-size: 22px; cursor: pointer;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { background: var(--bg-hover); }
        .modal-form { display: grid; gap: 16px; }
        .modal-form .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-footer {
            display: flex; gap: 10px; justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* ============================================================
           Toast
           ============================================================ */
        .toast-container {
            position: fixed;
            top: 72px; right: 24px;
            z-index: 9999;
            display: flex; flex-direction: column; gap: 8px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px; font-weight: 500;
            box-shadow: var(--shadow-md);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
            display: flex; align-items: center; gap: 8px;
        }
        .toast-success { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .toast-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .toast-warning { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } }
        @keyframes toastOut { to { opacity: 0; transform: translateX(40px); } }

        /* ============================================================
           Confirm Dialog
           ============================================================ */
        .confirm-dialog {
            text-align: center;
            padding: 8px;
        }
        .confirm-dialog .confirm-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .confirm-dialog h3 {
            font-size: 18px; margin-bottom: 8px;
        }
        .confirm-dialog p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .confirm-actions {
            display: flex; gap: 10px; justify-content: center;
        }

        /* ============================================================
           Empty State
           ============================================================ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }

        /* ============================================================
           Responsive
           ============================================================ */
        @media (max-width: 768px) {
            .header { padding: 0 12px; }
            .header-nav { display: none; }
            .main-content { padding: 16px 12px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .modal { padding: 20px; width: 95vw; }
            .table-header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .search-input { width: 100%; }
        }

        /* Password visibility toggle */
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input { padding-right: 40px; }
        .password-toggle {
            position: absolute;
            right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none;
            cursor: pointer; font-size: 16px;
            color: var(--text-muted);
        }

        /* Table action buttons */
        .action-cell {
            display: flex; gap: 4px;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- ============================================================
         Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
         ============================================================ -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <div class="icon">üõ°Ô∏è</div>
                <h1>CRE PORTAL</h1>
                <p>Í¥ÄÎ¶¨Ïûê ÏΩòÏÜî</p>
                <div class="admin-badge">ADMIN ONLY</div>
            </div>
            <div class="login-error" id="loginError"></div>
            <div class="form-group">
                <label>Ïù¥Î©îÏùº</label>
                <input type="email" id="loginEmail" placeholder="admin@company.com"
                       onkeypress="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
            </div>
            <div class="form-group">
                <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                       onkeypress="if(event.key==='Enter')handleLogin()">
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</button>
        </div>
    </div>

    <!-- ============================================================
         Î©îÏù∏ Ïï±
         ============================================================ -->
    <div id="appContainer" style="display:none;">
        <header class="header">
            <div class="header-left">
                <div class="header-logo"><span class="icon">üõ°Ô∏è</span> CRE PORTAL <span style="color:var(--error-color); font-size:12px; font-weight:600; margin-left:4px;">ADMIN</span></div>
                <nav class="header-nav">
                    <div class="nav-item active" data-tab="users" onclick="switchTab('users')">üë• ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</div>
                    <div class="nav-item" data-tab="logs" onclick="switchTab('logs')">üìã ÌôúÎèô Î°úÍ∑∏</div>
                    <a href="portal.html" class="nav-item">üè¢ Ìè¨ÌÉàÎ°ú Ïù¥Îèô</a>
                </nav>
            </div>
            <div class="header-right">
                <button class="theme-btn" onclick="toggleTheme()" title="Îã§ÌÅ¨Î™®Îìú">üåô</button>
                <div class="user-info">
                    <span class="user-email" id="adminName">Í¥ÄÎ¶¨Ïûê</span>
                    <span class="user-role" id="adminRole">admin</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
        </header>

        <!-- ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ ÌÉ≠ -->
        <div class="main-content" id="tabUsers">
            <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon blue">üë•</div>
                    <div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ Í≥ÑÏ†ï</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">‚úÖ</div>
                    <div>
                        <div class="stat-value" id="statActive">0</div>
                        <div class="stat-label">ÌôúÏÑ± Í≥ÑÏ†ï</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">üö´</div>
                    <div>
                        <div class="stat-value" id="statDisabled">0</div>
                        <div class="stat-label">ÎπÑÌôúÏÑ± Í≥ÑÏ†ï</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon amber">‚è≥</div>
                    <div>
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-label">Ï¥àÍ∏∞ Î°úÍ∑∏Ïù∏ ÎåÄÍ∏∞</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">üõ°Ô∏è</div>
                    <div>
                        <div class="stat-value" id="statAdmin">0</div>
                        <div class="stat-label">Í¥ÄÎ¶¨Ïûê</div>
                    </div>
                </div>
            </div>

            <!-- ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î -->
            <div class="table-card">
                <div class="table-header">
                    <h2>ÏÇ¨Ïö©Ïûê Î™©Î°ù</h2>
                    <div class="table-actions">
                        <input type="text" class="search-input" id="userSearch" 
                               placeholder="Ïù¥Î¶Ñ, Ïù¥Î©îÏùº Í≤ÄÏÉâ..." oninput="filterUsers()">
                        <select id="roleFilter" onchange="filterUsers()" 
                                style="padding:8px 12px; border:1px solid var(--border-color); border-radius:var(--radius-sm); font-size:13px; font-family:inherit; background:var(--bg-primary); color:var(--text-primary);">
                            <option value="">Ï†ÑÏ≤¥ Ïó≠Ìï†</option>
                            <option value="superadmin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="user">User</option>
                            <option value="viewer">Viewer</option>
                        </select>
                        <button class="btn btn-success btn-sm" onclick="openCreateModal()">‚ûï Í≥ÑÏ†ï ÏÉùÏÑ±</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadUsers()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px;">#</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>ÏßÅÍ∏â</th>
                                <th>Ïó∞ÎùΩÏ≤ò</th>
                                <th>Ïó≠Ìï†</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>ÏÉùÏÑ±Ïùº</th>
                                <th>ÏµúÍ∑º ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</th>
                                <th style="width:140px;">Í¥ÄÎ¶¨</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="10">
                                    <div class="empty-state">
                                        <div class="loading-spinner" style="width:32px;height:32px;border-width:3px;margin:0 auto 12px;"></div>
                                        <p>ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ÌôúÎèô Î°úÍ∑∏ ÌÉ≠ -->
        <div class="main-content" id="tabLogs" style="display:none;">
            <div class="table-card">
                <div class="table-header">
                    <h2>Í¥ÄÎ¶¨Ïûê ÌôúÎèô Î°úÍ∑∏</h2>
                    <button class="btn btn-secondary btn-sm" onclick="loadLogs()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ÏãúÍ∞Ñ</th>
                                <th>Í¥ÄÎ¶¨Ïûê</th>
                                <th>ÎèôÏûë</th>
                                <th>ÎåÄÏÉÅ</th>
                                <th>ÏÉÅÏÑ∏</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr><td colspan="5"><div class="empty-state"><p>Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================
         Í≥ÑÏ†ï ÏÉùÏÑ±/Ìé∏Ïßë Î™®Îã¨
         ============================================================ -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-title">
                <h3 id="modalTitle">Í≥ÑÏ†ï ÏÉùÏÑ±</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label>Ïù¥Î©îÏùº (ÏïÑÏù¥Îîî) <span style="color:var(--error-color);">*</span></label>
                    <input type="email" id="modalEmail" placeholder="user@company.com">
                </div>
                <div class="form-group">
                    <label>ÎπÑÎ∞ÄÎ≤àÌò∏ (Ïà´Ïûê 6ÏûêÎ¶¨) <span style="color:var(--error-color);">*</span></label>
                    <div class="password-wrapper">
                        <input type="password" id="modalPassword" placeholder="000000" maxlength="6" 
                               oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                        <button class="password-toggle" onclick="togglePasswordVisibility('modalPassword', this)">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="row2">
                    <div class="form-group">
                        <label>Ïù¥Î¶Ñ <span style="color:var(--error-color);">*</span></label>
                        <input type="text" id="modalName" placeholder="ÌôçÍ∏∏Îèô">
                    </div>
                    <div class="form-group">
                        <label>ÏßÅÍ∏â</label>
                        <input type="text" id="modalPosition" placeholder="Í≥ºÏû•">
                    </div>
                </div>
                <div class="row2">
                    <div class="form-group">
                        <label>Ïó∞ÎùΩÏ≤ò</label>
                        <input type="tel" id="modalPhone" placeholder="010-0000-0000">
                    </div>
                    <div class="form-group">
                        <label>Ïó≠Ìï† <span style="color:var(--error-color);">*</span></label>
                        <select id="modalRole">
                            <option value="user">User (ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê)</option>
                            <option value="viewer">Viewer (ÏùΩÍ∏∞ Ï†ÑÏö©)</option>
                            <option value="manager">Manager (Îß§ÎãàÏ†Ä)</option>
                            <option value="admin">Admin (Í¥ÄÎ¶¨Ïûê)</option>
                        </select>
                    </div>
                </div>
                <div class="row2">
                    <div class="form-group">
                        <label>ÏÜåÏÜç ÌöåÏÇ¨</label>
                        <input type="text" id="modalCompany" placeholder="S&I Corporation">
                    </div>
                    <div class="form-group">
                        <label>Î∂ÄÏÑú</label>
                        <input type="text" id="modalDepartment" placeholder="CREÌåÄ">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" id="modalSubmitBtn" onclick="submitUser()" style="width:auto;">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- ============================================================
         ÌôïÏù∏ Î™®Îã¨ (ÏÇ≠Ï†ú/Ï§ëÏßÄ Îì±)
         ============================================================ -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="width:400px;">
            <div class="confirm-dialog">
                <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
                <h3 id="confirmTitle">ÌôïÏù∏</h3>
                <p id="confirmMessage">Ï†ïÎßê ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
                <div class="confirm-actions">
                    <button class="btn btn-secondary" onclick="closeConfirm()">Ï∑®ÏÜå</button>
                    <button class="btn btn-danger" id="confirmBtn" onclick="executeConfirm()">ÌôïÏù∏</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ============================================================
         JavaScript
         ============================================================ -->
    <script type="module">
        // ============================================================
        // Firebase Ï¥àÍ∏∞Ìôî
        // ============================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, get, set, push, update, remove, onValue } 
            from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTEJnDQzgY6FQABVBcvNsKvwDLJkmj26s",
            authDomain: "cre-unified.firebaseapp.com",
            databaseURL: "https://cre-unified-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cre-unified",
            storageBucket: "cre-unified.firebasestorage.app",
            messagingSenderId: "161207314802",
            appId: "1:161207314802:web:777e72ae0e190e73ebd5eb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ============================================================
        // ÏÉÅÌÉú Í¥ÄÎ¶¨
        // ============================================================
        let currentAdmin = null;
        let allUsers = [];
        let editingUserId = null;
        let confirmCallback = null;

        // ============================================================
        // Ïú†Ìã∏Î¶¨Ìã∞
        // ============================================================
        const emailToKey = (email) => email.replace(/[@.]/g, '_');

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `${icons[type] || ''} ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        // ============================================================
        // ÌÖåÎßà ÌÜ†Í∏Ä
        // ============================================================
        function toggleTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
            localStorage.setItem('admin-theme', isDark ? 'light' : 'dark');
        }
        // Ï†ÄÏû•Îêú ÌÖåÎßà Ï†ÅÏö©
        if (localStorage.getItem('admin-theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        // ============================================================
        // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
        // ============================================================
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorEl = document.getElementById('loginError');

            if (!email || !password) {
                errorEl.textContent = 'Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
                errorEl.classList.add('show');
                return;
            }

            try {
                const key = emailToKey(email);
                const snapshot = await get(ref(db, `users/${key}`));
                
                if (!snapshot.exists()) {
                    errorEl.textContent = 'Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Í≥ÑÏ†ïÏûÖÎãàÎã§.';
                    errorEl.classList.add('show');
                    return;
                }

                const user = snapshot.val();

                if (user.password !== password) {
                    errorEl.textContent = 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.';
                    errorEl.classList.add('show');
                    return;
                }

                if (user.disabled) {
                    errorEl.textContent = 'ÎπÑÌôúÏÑ±ÌôîÎêú Í≥ÑÏ†ïÏûÖÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.';
                    errorEl.classList.add('show');
                    return;
                }

                if (user.role !== 'admin' && user.role !== 'superadmin') {
                    errorEl.textContent = 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. admin ÎòêÎäî superadmin Ïó≠Ìï†Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.';
                    errorEl.classList.add('show');
                    return;
                }

                // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ
                currentAdmin = user;
                localStorage.setItem('adminSession', JSON.stringify({
                    email: user.email,
                    role: user.role,
                    name: user.name || user.email,
                    loginAt: Date.now()
                }));

                showApp();
                loadUsers();
                loadLogs();
                
                // Î°úÍ∑∏ Í∏∞Î°ù
                writeLog('login', user.email, 'Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏');

            } catch (err) {
                console.error('Login error:', err);
                errorEl.textContent = 'Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                errorEl.classList.add('show');
            }
        }

        function handleLogout() {
            currentAdmin = null;
            localStorage.removeItem('adminSession');
            document.getElementById('loginScreen').style.display = '';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = '';
            document.getElementById('adminName').textContent = currentAdmin.name || currentAdmin.email;
            document.getElementById('adminRole').textContent = currentAdmin.role;
        }

        // ÏÑ∏ÏÖò Î≥µÏõê
        async function restoreSession() {
            const session = localStorage.getItem('adminSession');
            if (!session) return;
            
            try {
                const data = JSON.parse(session);
                // 24ÏãúÍ∞Ñ Ï¥àÍ≥º Ïãú Î°úÍ∑∏ÏïÑÏõÉ
                if (Date.now() - data.loginAt > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('adminSession');
                    return;
                }

                const key = emailToKey(data.email);
                const snapshot = await get(ref(db, `users/${key}`));
                if (snapshot.exists()) {
                    const user = snapshot.val();
                    if ((user.role === 'admin' || user.role === 'superadmin') && !user.disabled) {
                        currentAdmin = user;
                        showApp();
                        loadUsers();
                        loadLogs();
                    }
                }
            } catch (e) {
                console.error('Session restore error:', e);
            }
        }

        // ============================================================
        // ÌÉ≠ Ï†ÑÌôò
        // ============================================================
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item[data-tab]').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tabName);
            });
            document.getElementById('tabUsers').style.display = tabName === 'users' ? '' : 'none';
            document.getElementById('tabLogs').style.display = tabName === 'logs' ? '' : 'none';
            
            if (tabName === 'logs') loadLogs();
        }

        // ============================================================
        // ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú
        // ============================================================
        async function loadUsers() {
            try {
                const snapshot = await get(ref(db, 'users'));
                allUsers = [];
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.entries(data).forEach(([key, user]) => {
                        if (key === '_schema') return; // Ïä§ÌÇ§Îßà Ï†úÏô∏
                        allUsers.push({ ...user, _key: key });
                    });
                }

                // ÏÉùÏÑ±Ïùº ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
                allUsers.sort((a, b) => (b.created || 0) - (a.created || 0));
                
                updateStats();
                renderUsers(allUsers);
            } catch (err) {
                console.error('Load users error:', err);
                showToast('ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïã§Ìå®', 'error');
            }
        }

        function updateStats() {
            const total = allUsers.length;
            const active = allUsers.filter(u => !u.disabled).length;
            const disabled = allUsers.filter(u => u.disabled).length;
            const pending = allUsers.filter(u => u.firstLogin && !u.disabled).length;
            const admins = allUsers.filter(u => u.role === 'admin' || u.role === 'superadmin').length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statDisabled').textContent = disabled;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statAdmin').textContent = admins;
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="icon">üë•</div><p>Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = users.map((u, i) => {
                const roleBadge = `<span class="badge badge-${u.role}">${u.role}</span>`;
                const statusBadge = u.disabled 
                    ? '<span class="badge badge-disabled">ÎπÑÌôúÏÑ±</span>'
                    : (u.firstLogin ? '<span class="badge badge-pending">ÎåÄÍ∏∞Ï§ë</span>' : '<span class="badge badge-active">ÌôúÏÑ±</span>');
                
                const isSelf = currentAdmin && u.email === currentAdmin.email;
                
                return `<tr style="${u.disabled ? 'opacity:0.55;' : ''}">
                    <td style="color:var(--text-muted);font-size:12px;">${i + 1}</td>
                    <td style="font-weight:500;">${u.email || '-'}${isSelf ? ' <span style="color:var(--accent-color);font-size:11px;">(ÎÇò)</span>' : ''}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.position || u.department || '-'}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td style="font-size:12px;color:var(--text-muted);">${formatDate(u.created)}</td>
                    <td style="font-size:12px;color:var(--text-muted);">${formatDate(u.lastPasswordChange)}</td>
                    <td>
                        <div class="action-cell">
                            <button class="btn-icon" onclick="openEditModal('${u._key}')" title="Ìé∏Ïßë">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="toggleUserStatus('${u._key}')" title="${u.disabled ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}">${u.disabled ? '‚úÖ' : 'üö´'}</button>
                            <button class="btn-icon" onclick="resetPassword('${u._key}')" title="ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî">üîë</button>
                            ${isSelf ? '' : `<button class="btn-icon" onclick="deleteUser('${u._key}')" title="ÏÇ≠Ï†ú" style="color:var(--error-color);">üóëÔ∏è</button>`}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            
            let filtered = allUsers;
            if (search) {
                filtered = filtered.filter(u => 
                    (u.email || '').toLowerCase().includes(search) ||
                    (u.name || '').toLowerCase().includes(search) ||
                    (u.phone || '').includes(search)
                );
            }
            if (role) {
                filtered = filtered.filter(u => u.role === role);
            }
            renderUsers(filtered);
        }

        // ============================================================
        // Í≥ÑÏ†ï ÏÉùÏÑ± Î™®Îã¨
        // ============================================================
        function openCreateModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'ÏÉà Í≥ÑÏ†ï ÏÉùÏÑ±';
            document.getElementById('modalEmail').value = '';
            document.getElementById('modalEmail').disabled = false;
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalName').value = '';
            document.getElementById('modalPosition').value = '';
            document.getElementById('modalPhone').value = '';
            document.getElementById('modalRole').value = 'user';
            document.getElementById('modalCompany').value = '';
            document.getElementById('modalDepartment').value = '';
            document.getElementById('modalSubmitBtn').textContent = 'ÏÉùÏÑ±';
            document.getElementById('userModal').classList.add('show');
        }

        function openEditModal(key) {
            const user = allUsers.find(u => u._key === key);
            if (!user) return;
            
            editingUserId = key;
            document.getElementById('modalTitle').textContent = 'Í≥ÑÏ†ï Ìé∏Ïßë';
            document.getElementById('modalEmail').value = user.email || '';
            document.getElementById('modalEmail').disabled = true; // Ïù¥Î©îÏùº Î≥ÄÍ≤Ω Î∂àÍ∞Ä
            document.getElementById('modalPassword').value = user.password || '';
            document.getElementById('modalName').value = user.name || '';
            document.getElementById('modalPosition').value = user.position || '';
            document.getElementById('modalPhone').value = user.phone || '';
            document.getElementById('modalRole').value = user.role || 'user';
            document.getElementById('modalCompany').value = user.company || '';
            document.getElementById('modalDepartment').value = user.department || '';
            document.getElementById('modalSubmitBtn').textContent = 'Ï†ÄÏû•';
            document.getElementById('userModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('userModal').classList.remove('show');
            editingUserId = null;
        }

        async function submitUser() {
            const email = document.getElementById('modalEmail').value.trim();
            const password = document.getElementById('modalPassword').value.trim();
            const name = document.getElementById('modalName').value.trim();
            const position = document.getElementById('modalPosition').value.trim();
            const phone = document.getElementById('modalPhone').value.trim();
            const role = document.getElementById('modalRole').value;
            const company = document.getElementById('modalCompany').value.trim();
            const department = document.getElementById('modalDepartment').value.trim();

            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!email) { showToast('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); return; }
            if (!password || password.length !== 6 || !/^\d{6}$/.test(password)) {
                showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî Ïà´Ïûê 6ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§', 'error'); return;
            }
            if (!name) { showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); return; }

            const key = emailToKey(email);

            try {
                if (editingUserId) {
                    // Ìé∏Ïßë Î™®Îìú
                    const updates = {
                        name, position, phone, role, company, department
                    };
                    // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïó¨Î∂Ä Ï≤¥ÌÅ¨
                    const existing = allUsers.find(u => u._key === editingUserId);
                    if (existing && existing.password !== password) {
                        updates.password = password;
                        updates.lastPasswordChange = Date.now();
                    }
                    
                    await update(ref(db, `users/${editingUserId}`), updates);
                    writeLog('edit', email, `Í≥ÑÏ†ï Ï†ïÎ≥¥ ÏàòÏ†ï (Ïó≠Ìï†: ${role})`);
                    showToast(`${name} (${email}) Í≥ÑÏ†ïÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§`, 'success');
                } else {
                    // ÏÉùÏÑ± Î™®Îìú - Ï§ëÎ≥µ ÌôïÏù∏
                    const existing = await get(ref(db, `users/${key}`));
                    if (existing.exists()) {
                        showToast('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïù¥Î©îÏùºÏûÖÎãàÎã§', 'error');
                        return;
                    }

                    const newUser = {
                        id: key,
                        email,
                        password,
                        name,
                        position,
                        phone,
                        role,
                        company,
                        department,
                        created: Date.now(),
                        firstLogin: true,
                        _meta: { source: 'admin-console', createdAt: new Date().toISOString(), createdBy: currentAdmin.email }
                    };

                    await set(ref(db, `users/${key}`), newUser);
                    writeLog('create', email, `ÏÉà Í≥ÑÏ†ï ÏÉùÏÑ± (Ïó≠Ìï†: ${role})`);
                    showToast(`${name} (${email}) Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§`, 'success');
                }

                closeModal();
                loadUsers();
            } catch (err) {
                console.error('Submit error:', err);
                showToast('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + err.message, 'error');
            }
        }

        // ============================================================
        // Í≥ÑÏ†ï ÏÉÅÌÉú Î≥ÄÍ≤Ω (ÌôúÏÑ±/ÎπÑÌôúÏÑ±)
        // ============================================================
        function toggleUserStatus(key) {
            const user = allUsers.find(u => u._key === key);
            if (!user) return;

            const isDisabling = !user.disabled;
            const action = isDisabling ? 'ÎπÑÌôúÏÑ±Ìôî' : 'ÌôúÏÑ±Ìôî';

            openConfirm(
                isDisabling ? 'üö´' : '‚úÖ',
                `Í≥ÑÏ†ï ${action}`,
                `<strong>${user.name || user.email}</strong> Í≥ÑÏ†ïÏùÑ ${action}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?${isDisabling ? '<br><br>ÎπÑÌôúÏÑ±ÌôîÎêú Í≥ÑÏ†ïÏùÄ Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.' : ''}`,
                isDisabling ? 'btn-danger' : 'btn-success',
                action,
                async () => {
                    try {
                        await update(ref(db, `users/${key}`), { disabled: isDisabling });
                        writeLog(isDisabling ? 'disable' : 'enable', user.email, `Í≥ÑÏ†ï ${action}`);
                        showToast(`${user.name || user.email} Í≥ÑÏ†ïÏù¥ ${action}ÎêòÏóàÏäµÎãàÎã§`, 'success');
                        loadUsers();
                    } catch (err) {
                        showToast(`${action} Ïã§Ìå®: ${err.message}`, 'error');
                    }
                }
            );
        }

        // ============================================================
        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî
        // ============================================================
        function resetPassword(key) {
            const user = allUsers.find(u => u._key === key);
            if (!user) return;

            openConfirm(
                'üîë',
                'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî',
                `<strong>${user.name || user.email}</strong> Í≥ÑÏ†ïÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º <strong>123456</strong>ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,
                'btn-warning',
                'Ï¥àÍ∏∞Ìôî',
                async () => {
                    try {
                        await update(ref(db, `users/${key}`), {
                            password: '123456',
                            firstLogin: true,
                            lastPasswordChange: Date.now()
                        });
                        writeLog('reset_password', user.email, 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî (123456)');
                        showToast(`${user.name || user.email} ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä 123456ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§`, 'success');
                        loadUsers();
                    } catch (err) {
                        showToast('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ' + err.message, 'error');
                    }
                }
            );
        }

        // ============================================================
        // Í≥ÑÏ†ï ÏÇ≠Ï†ú
        // ============================================================
        function deleteUser(key) {
            const user = allUsers.find(u => u._key === key);
            if (!user) return;

            // ÏûêÍ∏∞ ÏûêÏã† ÏÇ≠Ï†ú Î∞©ÏßÄ
            if (currentAdmin && user.email === currentAdmin.email) {
                showToast('ÏûêÍ∏∞ ÏûêÏã†Ïùò Í≥ÑÏ†ïÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }

            openConfirm(
                'üóëÔ∏è',
                'Í≥ÑÏ†ï ÏÇ≠Ï†ú',
                `<strong>${user.name || user.email}</strong> Í≥ÑÏ†ïÏùÑ ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br><br><span style="color:var(--error-color);font-weight:600;">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.</span>`,
                'btn-danger',
                'ÏòÅÍµ¨ ÏÇ≠Ï†ú',
                async () => {
                    try {
                        await remove(ref(db, `users/${key}`));
                        writeLog('delete', user.email, `Í≥ÑÏ†ï ÏòÅÍµ¨ ÏÇ≠Ï†ú (Ïó≠Ìï†: ${user.role})`);
                        showToast(`${user.name || user.email} Í≥ÑÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`, 'success');
                        loadUsers();
                    } catch (err) {
                        showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message, 'error');
                    }
                }
            );
        }

        // ============================================================
        // ÌôïÏù∏ Î™®Îã¨
        // ============================================================
        function openConfirm(icon, title, message, btnClass, btnText, callback) {
            document.getElementById('confirmIcon').textContent = icon;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').innerHTML = message;
            const btn = document.getElementById('confirmBtn');
            btn.className = `btn ${btnClass}`;
            btn.textContent = btnText;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmCallback = null;
        }

        async function executeConfirm() {
            if (confirmCallback) {
                await confirmCallback();
            }
            closeConfirm();
        }

        // ============================================================
        // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌëúÏãú ÌÜ†Í∏Ä
        // ============================================================
        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        // ============================================================
        // ÌôúÎèô Î°úÍ∑∏
        // ============================================================
        async function writeLog(action, target, detail) {
            try {
                const logRef = push(ref(db, 'adminLogs'));
                await set(logRef, {
                    timestamp: Date.now(),
                    admin: currentAdmin?.email || 'unknown',
                    action,
                    target,
                    detail
                });
            } catch (e) {
                console.error('Log write error:', e);
            }
        }

        async function loadLogs() {
            try {
                const snapshot = await get(ref(db, 'adminLogs'));
                const tbody = document.getElementById('logsTableBody');
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="icon">üìã</div><p>ÌôúÎèô Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</p></div></td></tr>';
                    return;
                }

                const logs = [];
                snapshot.forEach(child => {
                    logs.push({ id: child.key, ...child.val() });
                });
                
                // ÏµúÏã†Ïàú Ï†ïÎ†¨
                logs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                const actionLabels = {
                    login: 'üîê Î°úÍ∑∏Ïù∏',
                    create: '‚ûï ÏÉùÏÑ±',
                    edit: '‚úèÔ∏è ÏàòÏ†ï',
                    delete: 'üóëÔ∏è ÏÇ≠Ï†ú',
                    disable: 'üö´ ÎπÑÌôúÏÑ±Ìôî',
                    enable: '‚úÖ ÌôúÏÑ±Ìôî',
                    reset_password: 'üîë ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî'
                };

                tbody.innerHTML = logs.slice(0, 100).map(log => `
                    <tr>
                        <td style="font-size:12px;color:var(--text-muted);white-space:nowrap;">${formatDateTime(log.timestamp)}</td>
                        <td style="font-weight:500;">${log.admin || '-'}</td>
                        <td>${actionLabels[log.action] || log.action}</td>
                        <td>${log.target || '-'}</td>
                        <td style="font-size:13px;color:var(--text-secondary);">${log.detail || '-'}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Load logs error:', err);
            }
        }

        // ============================================================
        // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
        // ============================================================
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.toggleTheme = toggleTheme;
        window.switchTab = switchTab;
        window.openCreateModal = openCreateModal;
        window.openEditModal = openEditModal;
        window.closeModal = closeModal;
        window.submitUser = submitUser;
        window.toggleUserStatus = toggleUserStatus;
        window.resetPassword = resetPassword;
        window.deleteUser = deleteUser;
        window.filterUsers = filterUsers;
        window.loadUsers = loadUsers;
        window.loadLogs = loadLogs;
        window.closeConfirm = closeConfirm;
        window.executeConfirm = executeConfirm;
        window.togglePasswordVisibility = togglePasswordVisibility;

        // ============================================================
        // Ï¥àÍ∏∞Ìôî
        // ============================================================
        restoreSession();
    </script>
</body>
</html>
